{% extends "base.html" %}

{% block title %}Cargar Resumen de Ventas - Leal Caf√©{% endblock %}

{% block btn_back %}
<a href="{{ url_for('modulo_operativo') }}" class="btn-back">
    <i class="fas fa-arrow-left"></i>
    Volver
</a>
{% endblock %}

{% block content %}
<!-- Module Header -->
<div class="module-header">
    <div class="module-icon">
        <i class="fas fa-file-upload"></i>
    </div>
    <div class="module-info">
        <h1>Cargar Resumen de Ventas</h1>
        <p>Importa el archivo de Resumen de Ventas desde Excel</p>
    </div>
</div>

<!-- Stepper de Progreso -->
<div class="stepper-container">
    <div class="stepper">
        <div class="step active" data-step="1">
            <div class="step-number">1</div>
            <div class="step-label">Configuraci√≥n</div>
        </div>
        <div class="step-line"></div>
        <div class="step" data-step="2">
            <div class="step-number">2</div>
            <div class="step-label">Subir Archivo</div>
        </div>
        <div class="step-line"></div>
        <div class="step" data-step="3">
            <div class="step-number">3</div>
            <div class="step-label">Vista Previa</div>
        </div>
        <div class="step-line"></div>
        <div class="step" data-step="4">
            <div class="step-number">4</div>
            <div class="step-label">Confirmar</div>
        </div>
    </div>
</div>

<!-- Formulario de Carga -->
<div class="section-box">
    <div class="section-title">
        <i class="fas fa-upload"></i>
        Cargar Resumen de Ventas
    </div>

    <form id="formCargarVentas">
        <!-- Selector de Modo de Carga -->
        <div style="background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); padding: 20px; border-radius: var(--radius-lg); margin-bottom: 24px; color: white;">
            <h3 style="margin: 0 0 12px 0; font-size: 16px; color: white;">
                <i class="fas fa-layer-group"></i>
                Modo de Carga
            </h3>
            <div style="display: flex; gap: 16px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; background: rgba(255,255,255,0.2); padding: 12px 20px; border-radius: 8px; flex: 1;">
                    <input type="radio" name="modo_carga" id="modo_diario" value="diario" checked style="width: 18px; height: 18px;">
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">üìÖ Carga Diaria</div>
                        <div style="font-size: 11px; opacity: 0.9;">Para operaci√≥n actual (d√≠a espec√≠fico)</div>
                    </div>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; background: rgba(255,255,255,0.2); padding: 12px 20px; border-radius: 8px; flex: 1;">
                    <input type="radio" name="modo_carga" id="modo_mensual" value="mensual" style="width: 18px; height: 18px;">
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">üóÇÔ∏è Carga Mensual</div>
                        <div style="font-size: 11px; opacity: 0.9;">Para meses pasados (divide por d√≠as)</div>
                    </div>
                </label>
            </div>
        </div>

        <!-- Metadatos de Identificaci√≥n -->
        <div style="background: var(--gray-100); padding: 20px; border-radius: var(--radius-lg); margin-bottom: 24px;">
            <h3 style="margin: 0 0 16px 0; font-size: 16px; color: var(--secondary-color);">
                <i class="fas fa-info-circle"></i>
                Informaci√≥n de Identificaci√≥n
            </h3>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px;">
                <!-- Sucursal -->
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="sucursal" class="required">Sucursal</label>
                    <select id="sucursal" name="sucursal" class="form-control" required>
                        <option value="">-- Seleccionar --</option>
                        <option value="Centro">Centro</option>
                        <option value="LM">LM</option>
                        <option value="Auditorio">Auditorio</option>
                        <option value="Ahumada">Ahumada</option>
                    </select>
                </div>

                <!-- A√±o -->
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="anio" class="required">A√±o</label>
                    <select id="anio" name="anio" class="form-control" required>
                        <option value="">-- Seleccionar --</option>
                        <option value="2025">2025</option>
                        <option value="2026" selected>2026</option>
                    </select>
                </div>

                <!-- Mes -->
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="mes" class="required">Mes</label>
                    <select id="mes" name="mes" class="form-control" required>
                        <option value="">-- Seleccionar --</option>
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>

                <!-- D√≠a (solo para modo diario) -->
                <div class="form-group" id="campo_dia" style="margin-bottom: 0;">
                    <label for="dia" class="required">D√≠a</label>
                    <select id="dia" name="dia" class="form-control" required>
                        <option value="">-- Seleccionar --</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Archivo Excel -->
        <div class="form-group">
            <label for="archivo" class="required">Archivo Excel de Resumen de Ventas</label>
            <div style="position: relative;">
                <input
                    type="file"
                    id="archivo"
                    name="file"
                    class="form-control"
                    accept=".xlsx,.xls"
                    required
                >
            </div>
            <div class="form-text">
                Solo archivos .xlsx o .xls. Tama√±o m√°ximo: 16 MB
            </div>
            <div id="nombreArchivo" style="margin-top: 12px; font-weight: 500; color: var(--primary-color);"></div>
        </div>

        <!-- Botones -->
        <div style="display: flex; gap: 12px; margin-top: 32px;">
            <button type="submit" class="btn btn-primary btn-lg" id="btnProcesar">
                <i class="fas fa-search"></i>
                Analizar Archivo (Vista Previa)
            </button>
            <button type="button" class="btn btn-secondary btn-lg" onclick="resetForm()">
                <i class="fas fa-times"></i>
                Cancelar
            </button>
        </div>
    </form>
</div>

<!-- Vista Previa de Datos (Se muestra despu√©s de procesar) -->
<div id="vistaPrevia" style="display: none;">

    <!-- Resumen General -->
    <div class="section-box" style="background: linear-gradient(135deg, var(--success-light) 0%, var(--success-color) 100%); color: white;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <h2 style="color: white; margin: 0 0 8px 0; font-size: 24px;">
                    <i class="fas fa-check-circle"></i>
                    Archivo Procesado Correctamente
                </h2>
                <p style="margin: 0; opacity: 0.95;" id="metadataInfo"></p>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 32px; font-weight: bold;" id="totalVentas">$0.00</div>
                <div style="font-size: 14px; opacity: 0.9;">Total de Ventas</div>
            </div>
        </div>
    </div>

    <!-- Resumen de Registros Procesados -->
    <div class="section-box">
        <div class="section-title">
            <i class="fas fa-chart-bar"></i>
            Resumen de Registros Extra√≠dos
        </div>

        <div class="stats-grid" id="resumenRegistros">
            <!-- Se llenar√° con JavaScript -->
        </div>
    </div>

    <!-- Tabs para ver cada secci√≥n -->
    <div class="section-box">
        <div class="section-title">
            <i class="fas fa-table"></i>
            Vista Previa de Datos Extra√≠dos
        </div>

        <!-- Tabs -->
        <div class="tabs" style="margin-bottom: 24px;">
            <button class="tab-btn active" onclick="showTab('hora', event)">Ventas por Hora</button>
            <button class="tab-btn" onclick="showTab('platillo', event)">Ventas por Platillo</button>
            <button class="tab-btn" onclick="showTab('grupo', event)">Ventas por Grupo</button>
            <button class="tab-btn" onclick="showTab('tipo_grupo', event)">Tipo de Grupo</button>
            <button class="tab-btn" onclick="showTab('tipo_pago', event)">Tipo de Pago</button>
            <button class="tab-btn" onclick="showTab('usuario', event)">Por Usuario</button>
            <button class="tab-btn" onclick="showTab('cajero', event)">Por Cajero</button>
            <button class="tab-btn" onclick="showTab('modificador', event)">Modificadores</button>
        </div>

        <!-- Contenido de tabs -->
        <div id="tabContent">
            <!-- Se llenar√° con JavaScript -->
        </div>
    </div>

    <!-- Bot√≥n para confirmar guardado -->
    <div class="section-box" style="background: var(--gray-100); border: 2px dashed var(--primary-color);">
        <div style="text-align: center;">
            <h3 style="margin: 0 0 12px 0; color: var(--primary-color);">
                <i class="fas fa-question-circle"></i>
                ¬øLos datos se ven correctos?
            </h3>
            <p style="margin: 0 0 20px 0; color: var(--gray-700);">
                Si los datos mostrados arriba son correctos, puedes proceder a guardarlos en la base de datos.
            </p>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button class="btn btn-success btn-lg" onclick="confirmarGuardado()">
                    <i class="fas fa-save"></i>
                    S√≠, Guardar en Base de Datos
                </button>
                <button class="btn btn-danger btn-lg" onclick="resetForm()">
                    <i class="fas fa-times"></i>
                    No, Cancelar
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
/* Ocultar perfil y logout en subm√≥dulos, mantener bot√≥n de regreso */
.user-profile {
    display: none;
}

.header-right {
    display: none;
}

.main-container {
    padding-top: 24px;
}

/* ==================== STEPPER DE PROGRESO ==================== */
.stepper-container {
    background: var(--white);
    padding: var(--space-3xl);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-3xl);
    box-shadow: var(--shadow-sm);
}

.stepper {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: 700px;
    margin: 0 auto;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    flex-shrink: 0;
}

.step-number {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: var(--gray-200);
    color: var(--gray-500);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: var(--font-weight-bold);
    font-size: var(--font-size-lg);
    margin-bottom: var(--space-sm);
    transition: all var(--transition-base);
    border: 3px solid var(--gray-200);
}

.step.active .step-number {
    background: var(--primary-500);
    color: var(--white);
    border-color: var(--primary-500);
    box-shadow: 0 0 0 4px rgba(139, 111, 71, 0.2);
}

.step.completed .step-number {
    background: var(--success-500);
    color: var(--white);
    border-color: var(--success-500);
    font-size: 0; /* Ocultar n√∫mero */
}

.step.completed .step-number::before {
    content: '‚úì';
    font-size: var(--font-size-xl);
}

.step-label {
    font-size: var(--font-size-sm);
    color: var(--gray-600);
    text-align: center;
    font-weight: var(--font-weight-medium);
    white-space: nowrap;
}

.step.active .step-label {
    color: var(--primary-700);
    font-weight: var(--font-weight-semibold);
}

.step.completed .step-label {
    color: var(--success-700);
    font-weight: var(--font-weight-medium);
}

.step-line {
    flex: 1;
    height: 3px;
    background: var(--gray-200);
    margin: 0 var(--space-md);
    margin-bottom: var(--space-4xl);
    transition: background var(--transition-base);
}

.step.completed + .step-line {
    background: var(--success-500);
}

.step.active + .step-line {
    background: linear-gradient(to right, var(--primary-500) 0%, var(--gray-200) 100%);
}

/* Responsive Stepper */
@media (max-width: 640px) {
    .stepper-container {
        padding: var(--space-lg);
    }

    .step-label {
        font-size: 10px;
    }

    .step-number {
        width: 36px;
        height: 36px;
        font-size: var(--font-size-base);
    }

    .step-line {
        margin: 0 var(--space-xs);
    }
}

@media (max-width: 480px) {
    .step-label {
        display: none;
    }

    .stepper {
        max-width: 100%;
    }
}

/* Modal personalizado para mensajes */
.custom-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.2s ease-out;
}

.custom-modal {
    background: white;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    animation: slideUp 0.3s ease-out;
}

.custom-modal-header {
    padding: 24px 24px 16px 24px;
    border-bottom: 2px solid var(--gray-200);
}

.custom-modal-header h3 {
    margin: 0;
    font-size: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.custom-modal-body {
    padding: 24px;
    white-space: pre-line;
    line-height: 1.6;
    color: var(--gray-700);
}

.custom-modal-footer {
    padding: 16px 24px;
    border-top: 1px solid var(--gray-200);
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
    margin-top: 16px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: var(--radius-lg);
    border-left: 4px solid var(--primary-color);
    box-shadow: var(--shadow-sm);
}

.stat-card h4 {
    margin: 0 0 8px 0;
    font-size: 14px;
    color: var(--gray-600);
    font-weight: 500;
}

.stat-card .stat-value {
    font-size: 28px;
    font-weight: bold;
    color: var(--primary-color);
}

.tabs {
    display: flex;
    gap: 8px;
    border-bottom: 2px solid var(--gray-300);
    overflow-x: auto;
}

.tab-btn {
    padding: 12px 20px;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-weight: 500;
    color: var(--gray-600);
    transition: all var(--transition-base);
    white-space: nowrap;
}

.tab-btn:hover {
    color: var(--primary-color);
    background: var(--gray-100);
}

.tab-btn.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
}

.table-wrapper {
    overflow-x: auto;
    margin-top: 16px;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

.data-table th {
    background: var(--gray-200);
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: var(--secondary-color);
    border-bottom: 2px solid var(--gray-400);
}

.data-table td {
    padding: 10px 12px;
    border-bottom: 1px solid var(--gray-300);
}

.data-table tr:hover {
    background: var(--gray-100);
}

.text-right {
    text-align: right;
}

.text-center {
    text-align: center;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let datosExtraidos = null;

// ==================== STEPPER CONTROL ====================

let pasoActual = 1;

function actualizarPasoStepper(paso) {
    pasoActual = paso;

    document.querySelectorAll('.step').forEach((stepEl, index) => {
        const numeroStep = index + 1;

        stepEl.classList.remove('active', 'completed');

        if (numeroStep < paso) {
            stepEl.classList.add('completed');
        } else if (numeroStep === paso) {
            stepEl.classList.add('active');
        }
    });
}

// ============================================================================
// MANEJO DE MODO DE CARGA Y D√çAS DIN√ÅMICOS
// ============================================================================

// Manejar cambio de modo de carga
document.querySelectorAll('input[name="modo_carga"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const campoDia = document.getElementById('campo_dia');
        const selectDia = document.getElementById('dia');

        if (this.value === 'diario') {
            campoDia.style.display = 'block';
            selectDia.required = true;
        } else {
            campoDia.style.display = 'none';
            selectDia.required = false;
            selectDia.value = '';
        }
    });
});

// Generar d√≠as seg√∫n el mes seleccionado
document.getElementById('mes').addEventListener('change', generarDias);
document.getElementById('anio').addEventListener('change', generarDias);

function generarDias() {
    const mes = parseInt(document.getElementById('mes').value);
    const anio = parseInt(document.getElementById('anio').value);
    const selectDia = document.getElementById('dia');

    if (!mes || !anio) {
        selectDia.innerHTML = '<option value="">-- Seleccionar --</option>';
        return;
    }

    // Calcular d√≠as del mes
    const diasEnMes = new Date(anio, mes, 0).getDate();

    // Generar opciones
    let options = '<option value="">-- Seleccionar --</option>';
    for (let i = 1; i <= diasEnMes; i++) {
        options += `<option value="${i}">${i}</option>`;
    }

    selectDia.innerHTML = options;
}

// Sistema de di√°logos personalizados
function showModal(title, message, type = 'info', buttons = [{ text: 'Aceptar', className: 'btn-primary' }]) {
    return new Promise((resolve) => {
        // Crear overlay
        const overlay = document.createElement('div');
        overlay.className = 'custom-modal-overlay';

        // Iconos por tipo
        const icons = {
            success: '<i class="fas fa-check-circle" style="color: var(--success-color);"></i>',
            error: '<i class="fas fa-times-circle" style="color: var(--danger-color);"></i>',
            warning: '<i class="fas fa-exclamation-triangle" style="color: var(--warning-color);"></i>',
            info: '<i class="fas fa-info-circle" style="color: var(--primary-color);"></i>',
            question: '<i class="fas fa-question-circle" style="color: var(--primary-color);"></i>'
        };

        // Crear modal
        const modal = document.createElement('div');
        modal.className = 'custom-modal';

        // Header
        const header = document.createElement('div');
        header.className = 'custom-modal-header';
        header.innerHTML = `<h3>${icons[type] || icons.info} ${title}</h3>`;

        // Body
        const body = document.createElement('div');
        body.className = 'custom-modal-body';
        body.textContent = message;

        // Footer con botones
        const footer = document.createElement('div');
        footer.className = 'custom-modal-footer';

        buttons.forEach((btn, index) => {
            const button = document.createElement('button');
            button.className = `btn ${btn.className || 'btn-secondary'}`;
            button.textContent = btn.text;
            button.onclick = () => {
                overlay.remove();
                resolve(btn.value !== undefined ? btn.value : index);
            };
            footer.appendChild(button);
        });

        // Ensamblar modal
        modal.appendChild(header);
        modal.appendChild(body);
        modal.appendChild(footer);
        overlay.appendChild(modal);

        // Agregar al DOM
        document.body.appendChild(overlay);

        // Click fuera del modal para cerrar (solo si es informativo)
        if (buttons.length === 1) {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                    resolve(0);
                }
            });
        }
    });
}

function showConfirm(title, message, confirmText = 'Confirmar', cancelText = 'Cancelar') {
    return showModal(title, message, 'question', [
        { text: cancelText, className: 'btn-secondary', value: false },
        { text: confirmText, className: 'btn-primary', value: true }
    ]);
}

function showSuccess(title, message) {
    return showModal(title, message, 'success', [{ text: 'Aceptar', className: 'btn-success' }]);
}

function showError(title, message) {
    return showModal(title, message, 'error', [{ text: 'Aceptar', className: 'btn-danger' }]);
}

function showWarning(title, message) {
    return showModal(title, message, 'warning', [{ text: 'Aceptar', className: 'btn-warning' }]);
}

function showInfo(title, message) {
    return showModal(title, message, 'info', [{ text: 'Aceptar', className: 'btn-primary' }]);
}

// Mostrar nombre del archivo seleccionado
document.getElementById('archivo').addEventListener('change', function(e) {
    const nombreDiv = document.getElementById('nombreArchivo');
    if (e.target.files.length > 0) {
        const archivo = e.target.files[0];
        nombreDiv.innerHTML = `
            <i class="fas fa-file-excel" style="color: var(--success-color);"></i>
            ${archivo.name} (${(archivo.size / 1024 / 1024).toFixed(2)} MB)
        `;
        // Avanzar al Paso 2: Subir Archivo
        actualizarPasoStepper(2);
    } else {
        nombreDiv.innerHTML = '';
        // Volver al Paso 1: Configuraci√≥n
        actualizarPasoStepper(1);
    }
});

// Procesar archivo y mostrar preview
document.getElementById('formCargarVentas').addEventListener('submit', async function(e) {
    e.preventDefault();

    // Obtener modo de carga
    const modoCarga = document.querySelector('input[name="modo_carga"]:checked').value;

    // Validar metadatos
    const sucursal = document.getElementById('sucursal').value;
    const anio = document.getElementById('anio').value;
    const mes = document.getElementById('mes').value;
    const dia = document.getElementById('dia').value;

    // Validaci√≥n seg√∫n modo
    let camposRequeridos = {
        'Sucursal': sucursal,
        'A√±o': anio,
        'Mes': mes
    };

    if (modoCarga === 'diario') {
        camposRequeridos['D√≠a'] = dia;
    }

    const camposFaltantes = Object.entries(camposRequeridos)
        .filter(([_, valor]) => !valor)
        .map(([campo, _]) => `‚ùå ${campo}`)
        .join('\n');

    const camposCompletos = Object.entries(camposRequeridos)
        .filter(([_, valor]) => valor)
        .map(([campo, _]) => `‚úì ${campo}`)
        .join('\n');

    if (camposFaltantes) {
        await showWarning('CAMPOS INCOMPLETOS', `Por favor completa todos los campos requeridos:

${camposCompletos}
${camposFaltantes}`);
        return;
    }

    const archivo = document.getElementById('archivo').files[0];

    if (!archivo) {
        await showWarning('ARCHIVO NO SELECCIONADO', `Por favor selecciona un archivo Excel para continuar.

Formatos permitidos:
‚Ä¢ .xlsx (Excel 2007+)
‚Ä¢ .xls (Excel 97-2003)`);
        return;
    }

    if (!archivo.name.match(/\.(xlsx|xls)$/)) {
        await showError('FORMATO DE ARCHIVO INV√ÅLIDO', `Archivo seleccionado: ${archivo.name}

Solo se permiten archivos Excel:
‚Ä¢ .xlsx (Excel 2007+)
‚Ä¢ .xls (Excel 97-2003)`);
        return;
    }

    if (archivo.size > 16 * 1024 * 1024) {
        const sizeMB = (archivo.size / 1024 / 1024).toFixed(2);
        await showError('ARCHIVO DEMASIADO GRANDE', `Tama√±o del archivo: ${sizeMB} MB
Tama√±o m√°ximo permitido: 16 MB

Por favor selecciona un archivo m√°s peque√±o.`);
        return;
    }

    // Mostrar loading
    const btnProcesar = document.getElementById('btnProcesar');
    const btnTextoOriginal = btnProcesar.innerHTML;
    btnProcesar.disabled = true;
    btnProcesar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando archivo...';

    showLoading('Procesando archivo...');

    try {
        const formData = new FormData();
        formData.append('file', archivo);
        formData.append('modo_carga', modoCarga);
        formData.append('sucursal', sucursal);
        formData.append('anio', anio);
        formData.append('mes', mes);

        if (modoCarga === 'diario') {
            formData.append('dia', dia);
        }

        updateLoadingMessage('Validando datos...');

        const response = await fetch('/ventas/upload-preview', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (!response.ok || !data.success) {
            throw new Error(data.error || 'Error procesando el archivo');
        }

        // Guardar datos
        datosExtraidos = data;

        // Mostrar vista previa
        mostrarVistaPrevia(data);

    } catch (error) {
        console.error('Error:', error);
        await showError('ERROR AL PROCESAR ARCHIVO', `${error.message}

Verifica que:
‚Ä¢ El archivo tenga el formato correcto
‚Ä¢ La pesta√±a "Resumen de Ventas" exista
‚Ä¢ Los datos est√©n en el formato esperado`);
    } finally {
        hideLoading();
        btnProcesar.disabled = false;
        btnProcesar.innerHTML = btnTextoOriginal;
    }
});

function mostrarVistaPrevia(data) {
    // Avanzar al Paso 3: Vista Previa
    actualizarPasoStepper(3);

    // Mostrar secci√≥n de vista previa
    document.getElementById('vistaPrevia').style.display = 'block';

    // Scroll a la vista previa
    document.getElementById('vistaPrevia').scrollIntoView({ behavior: 'smooth' });

    // Metadata
    const metadata = data.metadata;
    document.getElementById('metadataInfo').textContent =
        `Archivo: ${metadata.archivo} | Fecha: ${metadata.fecha_carga} | ${metadata.filas} filas √ó ${metadata.columnas} columnas`;

    // Total de ventas
    document.getElementById('totalVentas').textContent =
        `$${parseFloat(metadata.total_ventas).toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

    // Resumen de registros
    const resumen = data.resumen;
    const resumenHTML = `
        <div class="stat-card">
            <h4>Ventas por Hora</h4>
            <div class="stat-value">${resumen.ventas_por_hora}</div>
        </div>
        <div class="stat-card">
            <h4>Ventas por Platillo</h4>
            <div class="stat-value">${resumen.ventas_por_platillo}</div>
        </div>
        <div class="stat-card">
            <h4>Ventas por Grupo</h4>
            <div class="stat-value">${resumen.ventas_por_grupo}</div>
        </div>
        <div class="stat-card">
            <h4>Ventas por Tipo de Grupo</h4>
            <div class="stat-value">${resumen.ventas_por_tipo_grupo}</div>
        </div>
        <div class="stat-card">
            <h4>Ventas por Tipo de Pago</h4>
            <div class="stat-value">${resumen.ventas_por_tipo_pago}</div>
        </div>
        <div class="stat-card">
            <h4>Ventas por Usuario</h4>
            <div class="stat-value">${resumen.ventas_por_usuario}</div>
        </div>
        <div class="stat-card">
            <h4>Ventas por Cajero</h4>
            <div class="stat-value">${resumen.ventas_por_cajero}</div>
        </div>
        <div class="stat-card">
            <h4>Ventas por Modificador</h4>
            <div class="stat-value">${resumen.ventas_por_modificador}</div>
        </div>
    `;
    document.getElementById('resumenRegistros').innerHTML = resumenHTML;

    // Mostrar primera tab por defecto
    showTab('hora');
}

function showTab(tabName, event) {
    // Actualizar botones activos
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

    // Si hay evento (click en bot√≥n), marcar el bot√≥n como activo
    if (event && event.target) {
        event.target.classList.add('active');
    } else {
        // Si no hay evento (llamada program√°tica), marcar el primer tab
        const firstTab = document.querySelector('.tab-btn');
        if (firstTab) firstTab.classList.add('active');
    }

    if (!datosExtraidos) return;

    const preview = datosExtraidos.preview_data;
    let html = '';

    switch(tabName) {
        case 'hora':
            html = generarTablaHora(preview.ventas_por_hora);
            break;
        case 'platillo':
            html = generarTablaPlatillo(preview.ventas_por_platillo);
            break;
        case 'grupo':
            html = generarTablaGrupo(preview.ventas_por_grupo);
            break;
        case 'tipo_grupo':
            html = generarTablaTipoGrupo(preview.ventas_por_tipo_grupo);
            break;
        case 'tipo_pago':
            html = generarTablaTipoPago(preview.ventas_por_tipo_pago);
            break;
        case 'usuario':
            html = generarTablaUsuario(preview.ventas_por_usuario);
            break;
        case 'cajero':
            html = generarTablaCajero(preview.ventas_por_cajero);
            break;
        case 'modificador':
            html = generarTablaModificador(preview.ventas_por_modificador);
            break;
    }

    document.getElementById('tabContent').innerHTML = html;
}

function generarTablaHora(datos) {
    if (!datos || datos.length === 0) return '<p>No hay datos</p>';

    return `
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Hora</th>
                        <th class="text-right">Monto</th>
                    </tr>
                </thead>
                <tbody>
                    ${datos.map(row => `
                        <tr>
                            <td>${row.hora}</td>
                            <td class="text-right">$${parseFloat(row.monto).toLocaleString('es-MX', {minimumFractionDigits: 2})}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        <p style="margin-top: 12px; color: var(--gray-600); font-size: 13px;">
            <i class="fas fa-info-circle"></i> Mostrando ${datos.length} de ${datosExtraidos.resumen.ventas_por_hora} registros
        </p>
    `;
}

function generarTablaPlatillo(datos) {
    if (!datos || datos.length === 0) return '<p>No hay datos</p>';

    return `
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Clave</th>
                        <th>Nombre</th>
                        <th>Grupo</th>
                        <th class="text-right">Cantidad</th>
                        <th class="text-right">Subtotal</th>
                        <th class="text-right">%</th>
                    </tr>
                </thead>
                <tbody>
                    ${datos.map(row => `
                        <tr>
                            <td>${row.clave_platillo}</td>
                            <td>${row.nombre_platillo}</td>
                            <td>${row.grupo}</td>
                            <td class="text-right">${row.cantidad}</td>
                            <td class="text-right">$${parseFloat(row.subtotal).toLocaleString('es-MX', {minimumFractionDigits: 2})}</td>
                            <td class="text-right">${parseFloat(row.porcentaje).toFixed(2)}%</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        <p style="margin-top: 12px; color: var(--gray-600); font-size: 13px;">
            <i class="fas fa-info-circle"></i> Mostrando ${datos.length} de ${datosExtraidos.resumen.ventas_por_platillo} registros
        </p>
    `;
}

function generarTablaGrupo(datos) {
    if (!datos || datos.length === 0) return '<p>No hay datos</p>';

    return `
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Grupo</th>
                        <th class="text-right">Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    ${datos.map(row => `
                        <tr>
                            <td>${row.grupo}</td>
                            <td class="text-right">$${parseFloat(row.subtotal).toLocaleString('es-MX', {minimumFractionDigits: 2})}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        <p style="margin-top: 12px; color: var(--gray-600); font-size: 13px;">
            <i class="fas fa-info-circle"></i> Mostrando ${datos.length} de ${datosExtraidos.resumen.ventas_por_grupo} registros
        </p>
    `;
}

function generarTablaTipoGrupo(datos) {
    if (!datos || datos.length === 0) return '<p>No hay datos</p>';

    return `
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Grupo</th>
                        <th class="text-right">Cantidad</th>
                        <th class="text-right">Subtotal</th>
                        <th class="text-right">IVA</th>
                        <th class="text-right">Total</th>
                        <th class="text-right">%</th>
                    </tr>
                </thead>
                <tbody>
                    ${datos.map(row => `
                        <tr>
                            <td>${row.grupo}</td>
                            <td class="text-right">${row.cantidad}</td>
                            <td class="text-right">$${parseFloat(row.subtotal).toLocaleString('es-MX', {minimumFractionDigits: 2})}</td>
                            <td class="text-right">$${parseFloat(row.iva).toLocaleString('es-MX', {minimumFractionDigits: 2})}</td>
                            <td class="text-right">$${parseFloat(row.total).toLocaleString('es-MX', {minimumFractionDigits: 2})}</td>
                            <td class="text-right">${parseFloat(row.porcentaje).toFixed(2)}%</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function generarTablaTipoPago(datos) {
    if (!datos || datos.length === 0) return '<p>No hay datos</p>';

    return `
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Tipo de Pago</th>
                        <th class="text-right">Total</th>
                        <th class="text-right">%</th>
                    </tr>
                </thead>
                <tbody>
                    ${datos.map(row => `
                        <tr>
                            <td>${row.tipo_pago}</td>
                            <td class="text-right">$${parseFloat(row.total).toLocaleString('es-MX', {minimumFractionDigits: 2})}</td>
                            <td class="text-right">${parseFloat(row.porcentaje).toFixed(2)}%</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function generarTablaUsuario(datos) {
    if (!datos || datos.length === 0) return '<p>No hay datos</p>';

    return `
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Usuario</th>
                        <th class="text-right">Subtotal</th>
                        <th class="text-right">IVA</th>
                        <th class="text-right">Total</th>
                        <th class="text-right">Cuentas</th>
                        <th class="text-right">Ticket Prom.</th>
                        <th class="text-right">%</th>
                    </tr>
                </thead>
                <tbody>
                    ${datos.map(row => `
                        <tr>
                            <td>${row.usuario}</td>
                            <td class="text-right">$${parseFloat(row.subtotal).toLocaleString('es-MX', {minimumFractionDigits: 2})}</td>
                            <td class="text-right">$${parseFloat(row.iva).toLocaleString('es-MX', {minimumFractionDigits: 2})}</td>
                            <td class="text-right">$${parseFloat(row.total).toLocaleString('es-MX', {minimumFractionDigits: 2})}</td>
                            <td class="text-right">${row.num_cuentas}</td>
                            <td class="text-right">$${parseFloat(row.ticket_promedio).toLocaleString('es-MX', {minimumFractionDigits: 2})}</td>
                            <td class="text-right">${parseFloat(row.porcentaje).toFixed(2)}%</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function generarTablaCajero(datos) {
    if (!datos || datos.length === 0) return '<p>No hay datos</p>';

    return `
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Cajero</th>
                        <th class="text-right">Subtotal</th>
                        <th class="text-right">IVA</th>
                        <th class="text-right">Total</th>
                        <th class="text-right">Transacciones</th>
                        <th class="text-right">%</th>
                    </tr>
                </thead>
                <tbody>
                    ${datos.map(row => `
                        <tr>
                            <td>${row.cajero}</td>
                            <td class="text-right">$${parseFloat(row.subtotal).toLocaleString('es-MX', {minimumFractionDigits: 2})}</td>
                            <td class="text-right">$${parseFloat(row.iva).toLocaleString('es-MX', {minimumFractionDigits: 2})}</td>
                            <td class="text-right">$${parseFloat(row.total).toLocaleString('es-MX', {minimumFractionDigits: 2})}</td>
                            <td class="text-right">${row.cantidad_transacciones}</td>
                            <td class="text-right">${parseFloat(row.porcentaje).toFixed(2)}%</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function generarTablaModificador(datos) {
    if (!datos || datos.length === 0) return '<p>No hay datos</p>';

    return `
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Grupo</th>
                        <th>Clave</th>
                        <th>Nombre</th>
                        <th>Tama√±o</th>
                        <th class="text-right">Cantidad</th>
                        <th class="text-right">Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    ${datos.map(row => `
                        <tr>
                            <td>${row.grupo}</td>
                            <td>${row.clave_platillo}</td>
                            <td>${row.nombre_platillo}</td>
                            <td>${row.tamano || '-'}</td>
                            <td class="text-right">${row.cantidad}</td>
                            <td class="text-right">$${parseFloat(row.subtotal).toLocaleString('es-MX', {minimumFractionDigits: 2})}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        <p style="margin-top: 12px; color: var(--gray-600); font-size: 13px;">
            <i class="fas fa-info-circle"></i> Mostrando ${datos.length} de ${datosExtraidos.resumen.ventas_por_modificador} registros
        </p>
    `;
}

function resetForm() {
    document.getElementById('formCargarVentas').reset();
    document.getElementById('nombreArchivo').innerHTML = '';
    document.getElementById('vistaPrevia').style.display = 'none';
    datosExtraidos = null;
    // Volver al Paso 1: Configuraci√≥n
    actualizarPasoStepper(1);
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

async function confirmarGuardado() {
    if (!datosExtraidos) {
        await showWarning('NO HAY DATOS PARA GUARDAR', `Primero debes:
1. Completar los campos de informaci√≥n
2. Seleccionar un archivo Excel
3. Procesarlo con "Analizar Archivo"`);
        return;
    }

    // Avanzar al Paso 4: Confirmar
    actualizarPasoStepper(4);

    const metadata = datosExtraidos.metadata;
    const resumen = datosExtraidos.resumen;

    // Mensaje de confirmaci√≥n mejorado
    const mensajeConfirmacion = `INFORMACI√ìN DEL ARCHIVO:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Sucursal: ${metadata.sucursal}
‚Ä¢ A√±o: ${metadata.anio}
‚Ä¢ Mes: ${metadata.mes}
‚Ä¢ Semana: ${metadata.semana}

REGISTROS A INSERTAR:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Ventas por hora: ${resumen.ventas_por_hora}
‚Ä¢ Ventas por platillo: ${resumen.ventas_por_platillo}
‚Ä¢ Ventas por grupo: ${resumen.ventas_por_grupo}
‚Ä¢ Ventas por tipo grupo: ${resumen.ventas_por_tipo_grupo}
‚Ä¢ Ventas por tipo pago: ${resumen.ventas_por_tipo_pago}
‚Ä¢ Ventas por usuario: ${resumen.ventas_por_usuario}
‚Ä¢ Ventas por cajero: ${resumen.ventas_por_cajero}
‚Ä¢ Ventas por modificador: ${resumen.ventas_por_modificador}

TOTAL: ${Object.values(resumen).reduce((a, b) => a + b, 0)} registros`;

    const confirmado = await showConfirm('¬øConfirmar guardado?', mensajeConfirmacion, 'S√≠, Guardar', 'Cancelar');

    if (!confirmado) {
        return;
    }

    const btnConfirmar = document.querySelector('.btn-success');
    const btnTextoOriginal = btnConfirmar.innerHTML;
    btnConfirmar.disabled = true;
    btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

    try {
        const response = await fetch('/ventas/confirmar-guardado', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(datosExtraidos)
        });

        const data = await response.json();

        if (data.success) {
            const totalRegistros = Object.values(data.resumen).reduce((a, b) => a + b, 0);

            await showSuccess('DATOS GUARDADOS EXITOSAMENTE', `REGISTROS INSERTADOS:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Ventas por hora: ${data.resumen.ventas_por_hora || 0}
‚Ä¢ Ventas por platillo: ${data.resumen.ventas_por_platillo || 0}
‚Ä¢ Ventas por grupo: ${data.resumen.ventas_por_grupo || 0}
‚Ä¢ Ventas por tipo grupo: ${data.resumen.ventas_por_tipo_grupo || 0}
‚Ä¢ Ventas por tipo pago: ${data.resumen.ventas_por_tipo_pago || 0}
‚Ä¢ Ventas por usuario: ${data.resumen.ventas_por_usuario || 0}
‚Ä¢ Ventas por cajero: ${data.resumen.ventas_por_cajero || 0}
‚Ä¢ Ventas por modificador: ${data.resumen.ventas_por_modificador || 0}

TOTAL: ${totalRegistros} registros insertados correctamente`);

            // Resetear formulario despu√©s de guardado exitoso
            resetForm();
        } else {
            await showError('ERROR AL GUARDAR', data.error);
            btnConfirmar.disabled = false;
            btnConfirmar.innerHTML = btnTextoOriginal;
        }
    } catch (error) {
        await showError('ERROR DE CONEXI√ìN', error.message);
        btnConfirmar.disabled = false;
        btnConfirmar.innerHTML = btnTextoOriginal;
    }
}
</script>
{% endblock %}
