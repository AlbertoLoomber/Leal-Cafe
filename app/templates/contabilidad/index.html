{% extends "base.html" %}

{% block title %}Gastos - Leal Café{% endblock %}

{% block btn_back %}
<a href="{{ url_for('modulo_contabilidad') }}" class="btn-back">
    <i class="fas fa-arrow-left"></i>
    Volver
</a>
{% endblock %}

{% block content %}
<!-- Contenedor de notificaciones toast -->
<div class="toast-container" id="toastContainer"></div>

<div class="module-header">
    <div class="module-icon">
        <i class="fas fa-calculator" aria-hidden="true"></i>
    </div>
    <div class="module-info">
        <h1>Gestión de Gastos</h1>
        <p>Registra y controla todos los gastos del negocio</p>
    </div>
</div>

<!-- Filtros y Acciones -->
<div class="filters-section">
    <div class="filters-container">
        <!-- Filtro de Mes -->
        <div class="filter-group">
            <label>
                <i class="fas fa-calendar-alt" aria-hidden="true"></i> Mes
            </label>
            <select id="filtroMes" class="form-control">
                <option value="1">Enero 2026</option>
                <option value="2">Febrero 2026</option>
                <option value="3">Marzo 2026</option>
                <option value="4">Abril 2026</option>
                <option value="5">Mayo 2026</option>
                <option value="6">Junio 2026</option>
                <option value="7">Julio 2026</option>
                <option value="8">Agosto 2026</option>
                <option value="9">Septiembre 2026</option>
                <option value="10">Octubre 2026</option>
                <option value="11">Noviembre 2026</option>
                <option value="12">Diciembre 2026</option>
            </select>
        </div>

        <!-- Filtro de Sucursal -->
        <div class="filter-group">
            <label>
                <i class="fas fa-store" aria-hidden="true"></i> Sucursal
            </label>
            <select id="filtroSucursal" class="form-control">
                <option value="">Todas</option>
            </select>
        </div>

        <!-- Filtro de Tipo -->
        <div class="filter-group">
            <label>
                <i class="fas fa-tags" aria-hidden="true"></i> Tipo
            </label>
            <select id="filtroTipo" class="form-control">
                <option value="">Todos</option>
            </select>
        </div>

        <!-- Filtro de Categoría -->
        <div class="filter-group">
            <label>
                <i class="fas fa-folder" aria-hidden="true"></i> Categoría
            </label>
            <select id="filtroCategoria" class="form-control">
                <option value="">Todas</option>
            </select>
        </div>

        <!-- Botón Ordenar por Monto -->
        <div class="filter-group">
            <label>
                <i class="fas fa-sort-amount-down" aria-hidden="true"></i> Ordenar
            </label>
            <select id="ordenMonto" class="form-control">
                <option value="">Sin orden</option>
                <option value="desc">Mayor a menor</option>
                <option value="asc">Menor a mayor</option>
            </select>
        </div>

        <!-- Botón Nuevo Gasto -->
        <button type="button" id="btnNuevoGasto" class="btn-primary" onclick="abrirModalGasto()">
            <i class="fas fa-plus" aria-hidden="true"></i>
            Nuevo Gasto
        </button>

        <!-- Botón Exportar -->
        <button type="button" class="btn-success" onclick="exportarGastos()">
            <i class="fas fa-file-excel" aria-hidden="true"></i>
            Exportar
        </button>
    </div>
</div>

<!-- Resumen de Gastos -->
<div class="summary-cards">
    <div class="summary-card">
        <div class="summary-icon danger">
            <i class="fas fa-money-bill-wave" aria-hidden="true"></i>
        </div>
        <div class="summary-info">
            <span class="summary-label">Total Gastos del Mes</span>
            <span class="summary-value" id="totalGastosMes">$0.00</span>
        </div>
    </div>

    <div class="summary-card">
        <div class="summary-icon primary">
            <i class="fas fa-receipt" aria-hidden="true"></i>
        </div>
        <div class="summary-info">
            <span class="summary-label">Total Gastos Registrados</span>
            <span class="summary-value" id="cantidadGastos">0</span>
        </div>
    </div>

    <div class="summary-card">
        <div class="summary-icon success">
            <i class="fas fa-check-circle" aria-hidden="true"></i>
        </div>
        <div class="summary-info">
            <span class="summary-label">Gastos Facturados</span>
            <span class="summary-value" id="gastosFacturados">0</span>
        </div>
    </div>
</div>

<!-- Tabla de Gastos -->
<div class="section-box">
    <h3 style="margin: 0 0 20px 0;">Gastos Registrados</h3>

    <div class="table-responsive">
        <table class="data-table table-card" id="tablaGastos">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Sucursal</th>
                    <th>Tipo</th>
                    <th>Categoría</th>
                    <th>Descripción</th>
                    <th>Forma de Pago</th>
                    <th>Monto</th>
                    <th>%</th>
                    <th>¿Facturado?</th>
                    <th>Comentarios</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <!-- Los datos se cargarán dinámicamente -->
                <tr>
                    <td colspan="11">
                        <div class="empty-state">
                            <i class="fas fa-inbox empty-state-icon" aria-hidden="true"></i>
                            <h3 class="empty-state-title">No hay gastos registrados</h3>
                            <p class="empty-state-message">
                                Registra tu primer gasto para comenzar el seguimiento financiero de este mes
                            </p>
                            <div class="empty-state-action">
                                <button class="btn btn-primary" onclick="abrirModalGasto()">
                                    <i class="fas fa-plus" aria-hidden="true"></i>
                                    Registrar Gasto
                                </button>
                            </div>
                        </div>
                    </td>
                </tr>
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="6" style="text-align: right; font-weight: bold;">TOTAL:</td>
                    <td style="font-weight: bold;" id="totalTabla">$0.00</td>
                    <td style="font-weight: bold;">100.0%</td>
                    <td colspan="3"></td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<!-- Modal para Nuevo/Editar Gasto -->
<div id="modalGasto" class="modal" role="dialog" aria-labelledby="modalTitulo" aria-modal="true">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2 id="modalTitulo">
                <i class="fas fa-plus-circle" aria-hidden="true"></i>
                Registrar Nuevo Gasto
            </h2>
            <button type="button" class="close" onclick="cerrarModalGasto()" aria-label="Cerrar modal">
                <i class="fas fa-times" aria-hidden="true"></i>
            </button>
        </div>

        <form id="formGasto">
            <div class="modal-body">
                <!-- Sección 1: Información General -->
                <div class="form-section">
                    <h4 class="form-section-title">
                        <i class="fas fa-calendar" aria-hidden="true"></i>
                        Información General
                    </h4>
                    <div class="form-grid-3">
                        <div class="form-group">
                            <label class="required">Fecha</label>
                            <input type="date" id="fecha" name="fecha" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Sucursal</label>
                            <select id="sucursal" name="sucursal" class="form-control" required>
                                <option value="">Seleccionar...</option>
                                <option value="Centro">Centro</option>
                                <option value="LM">LM</option>
                                <option value="Auditorio">Auditorio</option>
                                <option value="Ahumada">Ahumada</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="required">Tipo de Gasto</label>
                            <select id="tipoGasto" name="tipoGasto" class="form-control" required>
                                <option value="">Seleccionar...</option>
                                <option value="Variable">Variable</option>
                                <option value="Fijo">Fijo</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Sección 2: Clasificación -->
                <div class="form-section">
                    <h4 class="form-section-title">
                        <i class="fas fa-folder" aria-hidden="true"></i>
                        Clasificación del Gasto
                    </h4>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label class="required">Categoría</label>
                            <select id="categoria" name="categoria" class="form-control" required onchange="toggleOtraCategoria()">
                                <option value="">Seleccionar...</option>
                                <option value="Insumos">Insumos</option>
                                <option value="Nómina">Nómina</option>
                                <option value="Renta">Renta</option>
                                <option value="Servicios">Servicios</option>
                                <option value="Mantenimiento">Mantenimiento</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Administración">Administración</option>
                                <option value="Otro">Otro (especificar)</option>
                            </select>
                        </div>
                        <div class="form-group" id="otraCategoriaGroup" style="display: none;">
                            <label class="required">Especificar Categoría</label>
                            <input type="text" id="otraCategoria" name="otraCategoria" class="form-control" placeholder="Escribe la categoría">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="required">Descripción</label>
                        <input type="text" id="descripcion" name="descripcion" class="form-control" placeholder="Describe el gasto" required>
                    </div>
                </div>

                <!-- Sección 3: Detalles Financieros -->
                <div class="form-section">
                    <h4 class="form-section-title">
                        <i class="fas fa-dollar-sign" aria-hidden="true"></i>
                        Detalles Financieros
                    </h4>
                    <div class="form-grid-3">
                        <div class="form-group">
                            <label class="required">Monto</label>
                            <input type="number" id="monto" name="monto" class="form-control" placeholder="0.00" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Forma de Pago</label>
                            <select id="formaPago" name="formaPago" class="form-control" required>
                                <option value="">Seleccionar...</option>
                                <option value="Efectivo">Efectivo</option>
                                <option value="Transferencia">Transferencia</option>
                                <option value="Tarjeta">Tarjeta</option>
                                <option value="Vale">Vale</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="required">¿Facturado?</label>
                            <select id="facturado" name="facturado" class="form-control" required>
                                <option value="">Seleccionar...</option>
                                <option value="Sí">Sí</option>
                                <option value="No">No</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Sección 4: Comentarios -->
                <div class="form-section">
                    <h4 class="form-section-title">
                        <i class="fas fa-comment" aria-hidden="true"></i>
                        Comentarios Adicionales
                    </h4>
                    <div class="form-group">
                        <label>Notas (opcional)</label>
                        <textarea id="comentarios" name="comentarios" class="form-control" rows="3" placeholder="Información adicional sobre este gasto..."></textarea>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="cerrarModalGasto()">
                    <i class="fas fa-times" aria-hidden="true"></i>
                    Cancelar
                </button>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-save" aria-hidden="true"></i>
                    Guardar Gasto
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
/* Variables de colores */
:root {
    --primary-color: #8B6914;
    --success-color: #10b981;
    --danger-color: #ef4444;
    --gray-100: #f7fafc;
    --gray-200: #edf2f7;
    --gray-500: #a0aec0;
    --gray-700: #2d3748;
}

/* Filtros Section */
.filters-section {
    background: white;
    padding: 24px;
    border-radius: 12px;
    margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.filters-container {
    display: flex;
    gap: 16px;
    align-items: end;
    flex-wrap: wrap;
}

.filter-group {
    flex: 1;
    min-width: 200px;
}

.filter-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--gray-700);
    font-size: 14px;
}

.filter-group select {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
}

/* Summary Cards */
.summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
}

.summary-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 16px;
}

.summary-icon {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
}

.summary-icon.primary { background: var(--primary-color); }
.summary-icon.success { background: var(--success-color); }
.summary-icon.danger { background: var(--danger-color); }

.summary-info {
    display: flex;
    flex-direction: column;
}

.summary-label {
    font-size: 14px;
    color: var(--gray-500);
    margin-bottom: 4px;
}

.summary-value {
    font-size: 24px;
    font-weight: bold;
    color: var(--gray-700);
}

/* Table */
.table-responsive {
    overflow-x: auto;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

.data-table thead th {
    background: var(--gray-700);
    color: white;
    padding: 12px;
    text-align: left;
    font-weight: 500;
    white-space: nowrap;
}

.data-table tbody td {
    padding: 12px;
    border-bottom: 1px solid var(--gray-200);
}

.data-table tbody tr:hover {
    background: var(--gray-100);
}

.total-row {
    background: var(--gray-100);
    font-weight: bold;
}

.total-row td {
    border-top: 2px solid var(--gray-700);
    padding: 16px 12px;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
}

.modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: 16px;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: modalSlideIn 0.3s ease;
}

.modal-large {
    max-width: 1000px;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal-header {
    padding: 24px;
    border-bottom: 1px solid var(--gray-200);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    font-size: 20px;
    color: var(--gray-700);
    display: flex;
    align-items: center;
    gap: 8px;
}

.modal-header .close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--gray-500);
    transition: color 0.2s;
}

.modal-header .close:hover {
    color: var(--danger-color);
}

.modal-body {
    padding: 24px;
}

.modal-footer {
    padding: 24px;
    border-top: 1px solid var(--gray-200);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

/* Form Grid */
.form-grid-3 {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
}

@media (max-width: 768px) {
    .form-grid-3 {
        grid-template-columns: 1fr;
    }
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--gray-700);
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.form-group label.required::after {
    content: '*';
    color: var(--danger-color);
    margin-left: 4px;
}

.form-control {
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.2s;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(139, 105, 20, 0.1);
}

textarea.form-control {
    resize: vertical;
    min-height: 80px;
}

/* Buttons */
.btn-primary, .btn-secondary, .btn-success, .btn-danger {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    transition: all 0.2s;
}

.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background: #6d5310;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(139, 105, 20, 0.3);
}

.btn-secondary {
    background: var(--gray-200);
    color: var(--gray-700);
}

.btn-secondary:hover {
    background: var(--gray-500);
    color: white;
}

.btn-success {
    background: var(--success-color);
    color: white;
}

.btn-success:hover {
    background: #059669;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.btn-danger {
    background: var(--danger-color);
    color: white;
}

.btn-danger:hover {
    background: #dc2626;
}

/* Action Buttons */
.btn-action {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s;
}

.btn-action.edit {
    background: #3b82f6;
    color: white;
}

.btn-action.delete {
    background: var(--danger-color);
    color: white;
}

.btn-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

/* Badges */
.badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
    white-space: nowrap;
}

.badge.variable {
    background: #fef3c7;
    color: #92400e;
}

.badge.fijo {
    background: #dbeafe;
    color: #1e40af;
}

.badge.sí,
.badge.si {
    background: #d1fae5;
    color: #065f46;
}

.badge.no {
    background: #fee2e2;
    color: #991b1b;
}

/* Notificaciones Toast */
.toast-container {
    position: fixed;
    top: 24px;
    right: 24px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.toast {
    min-width: 350px;
    max-width: 450px;
    padding: 18px 22px;
    border-radius: 16px;
    background: white;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08);
    display: flex;
    align-items: center;
    gap: 14px;
    animation: slideInBounce 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), fadeOut 0.3s ease 2.7s;
    border: 2px solid;
    position: relative;
    overflow: hidden;
}

.toast::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
}

.toast.success {
    border-color: #8B6914;
    color: #2d3748;
}

.toast.success::before {
    background: linear-gradient(135deg, #8B6914 0%, #6F5936 100%);
}

.toast.success i {
    color: #8B6914;
    background: linear-gradient(135deg, rgba(139, 105, 20, 0.1) 0%, rgba(111, 89, 54, 0.1) 100%);
    padding: 8px;
    border-radius: 10px;
}

.toast.error {
    border-color: #ef4444;
    color: #2d3748;
}

.toast.error::before {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}

.toast.error i {
    color: #ef4444;
    background: rgba(239, 68, 68, 0.1);
    padding: 8px;
    border-radius: 10px;
}

.toast i {
    font-size: 22px;
    flex-shrink: 0;
}

.toast-message {
    flex: 1;
    font-weight: 500;
    font-size: 14px;
    line-height: 1.5;
}

@keyframes slideInBounce {
    0% {
        transform: translateX(400px);
        opacity: 0;
    }
    60% {
        transform: translateX(-8px);
        opacity: 1;
    }
    80% {
        transform: translateX(4px);
    }
    100% {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes fadeOut {
    from {
        opacity: 1;
    }
    to {
        opacity: 0;
    }
}

/* ==================== FORM SECTIONS ==================== */

.form-section {
    padding: var(--space-xl) 0;
    border-bottom: 1px solid var(--gray-200);
}

.form-section:last-child {
    border-bottom: none;
    padding-bottom: 0;
}

.form-section:first-child {
    padding-top: 0;
}

.form-section-title {
    font-size: var(--font-size-md);
    font-weight: var(--font-weight-semibold);
    color: var(--gray-800);
    margin-bottom: var(--space-lg);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.form-section-title i {
    color: var(--primary-color);
    font-size: var(--font-size-lg);
}

.form-grid-2 {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-lg);
}

@media (max-width: 768px) {
    .form-grid-2,
    .form-grid-3 {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales
let gastosData = [];
let gastoEditando = null;

// Obtener mes y año actual
const hoy = new Date();
let mesActual = hoy.getMonth() + 1; // getMonth() retorna 0-11, necesitamos 1-12
let anioActual = hoy.getFullYear();

// ==================== FUNCIONES API ====================

async function cargarGastos() {
    showLoading('Cargando gastos...');

    try {
        const response = await fetch(`/contabilidad/api/gastos?mes=${mesActual}&anio=${anioActual}`);
        const result = await response.json();

        if (result.success) {
            gastosData = result.data.gastos;
            renderizarTabla();
            actualizarResumen(result.data);
        } else {
            console.error('Error cargando gastos:', result.error);
            mostrarMensaje('Error al cargar los gastos', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarMensaje('Error de conexión al cargar los gastos', 'error');
    } finally {
        hideLoading();
    }
}

async function guardarGasto(gastoData) {
    showLoading('Guardando gasto...');

    try {
        console.log('Enviando datos:', gastoData);

        const url = gastoEditando
            ? `/contabilidad/api/gastos/${gastoEditando.id}`
            : '/contabilidad/api/gastos';

        const method = gastoEditando ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(gastoData)
        });

        console.log('Response status:', response.status);

        const result = await response.json();
        console.log('Response data:', result);

        if (result.success) {
            mostrarMensaje(result.message, 'success');
            cerrarModalGasto();
            cargarGastos();
        } else {
            const errorMsg = result.error || 'Error desconocido al guardar';
            console.error('Error del servidor:', errorMsg);
            mostrarMensaje(errorMsg, 'error');
            hideLoading();
        }
    } catch (error) {
        console.error('Error completo:', error);
        mostrarMensaje('Error de conexión: ' + error.message, 'error');
        hideLoading();
    }
}

async function eliminarGasto(id) {
    if (!confirm('¿Está seguro de eliminar este gasto?')) {
        return;
    }

    showLoading('Eliminando...');

    try {
        const response = await fetch(`/contabilidad/api/gastos/${id}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            mostrarMensaje(result.message, 'success');
            cargarGastos();
        } else {
            mostrarMensaje(result.error, 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarMensaje('Error al eliminar el gasto', 'error');
    } finally {
        hideLoading();
    }
}

// ==================== FUNCIONES UI ====================

function abrirModalGasto(gasto = null) {
    const modal = document.getElementById('modalGasto');
    const form = document.getElementById('formGasto');

    if (gasto) {
        // Editar gasto existente
        document.getElementById('modalTitulo').innerHTML = '<i class="fas fa-edit" aria-hidden="true"></i> Editar Gasto';
        gastoEditando = gasto;

        // Llenar formulario
        document.getElementById('fecha').value = gasto.fecha;
        document.getElementById('sucursal').value = gasto.sucursal;
        document.getElementById('tipoGasto').value = gasto.tipo_gasto;
        document.getElementById('categoria').value = gasto.categoria;
        document.getElementById('descripcion').value = gasto.descripcion || '';
        document.getElementById('formaPago').value = gasto.forma_pago;
        document.getElementById('monto').value = gasto.monto;
        document.getElementById('facturado').value = gasto.facturado ? 'Sí' : 'No';
        document.getElementById('comentarios').value = gasto.comentarios || '';
    } else {
        // Nuevo gasto
        document.getElementById('modalTitulo').innerHTML = '<i class="fas fa-plus-circle" aria-hidden="true"></i> Registrar Nuevo Gasto';
        gastoEditando = null;
        form.reset();

        // Establecer fecha del mes actual
        const hoy = new Date();
        const primerDiaMes = new Date(anioActual, mesActual - 1, 1);
        document.getElementById('fecha').valueAsDate = primerDiaMes;
    }

    modal.classList.add('active');

    // Setup focus trap
    setupFocusTrap('modalGasto');
}

function cerrarModalGasto() {
    // Remover focus trap
    removeFocusTrap('modalGasto');

    const modal = document.getElementById('modalGasto');
    modal.classList.remove('active');
    gastoEditando = null;
}

function toggleOtraCategoria() {
    const categoria = document.getElementById('categoria').value;
    const otraGroup = document.getElementById('otraCategoriaGroup');
    const otraInput = document.getElementById('otraCategoria');

    if (categoria === 'Otro') {
        otraGroup.style.display = 'block';
        otraInput.required = true;
    } else {
        otraGroup.style.display = 'none';
        otraInput.required = false;
        otraInput.value = '';
    }
}

function poblarFiltros() {
    const sucursales = [...new Set(gastosData.map(g => g.sucursal))].sort();
    const tipos = [...new Set(gastosData.map(g => g.tipo_gasto))].sort();
    const categorias = [...new Set(gastosData.map(g => g.categoria))].sort();

    const filtroSucursal = document.getElementById('filtroSucursal');
    const filtroTipo = document.getElementById('filtroTipo');
    const filtroCategoria = document.getElementById('filtroCategoria');

    // Guardar valores seleccionados
    const valSucursal = filtroSucursal.value;
    const valTipo = filtroTipo.value;
    const valCategoria = filtroCategoria.value;

    filtroSucursal.innerHTML = '<option value="">Todas</option>' + sucursales.map(s => `<option value="${s}">${s}</option>`).join('');
    filtroTipo.innerHTML = '<option value="">Todos</option>' + tipos.map(t => `<option value="${t}">${t}</option>`).join('');
    filtroCategoria.innerHTML = '<option value="">Todas</option>' + categorias.map(c => `<option value="${c}">${c}</option>`).join('');

    // Restaurar valores si aún existen
    filtroSucursal.value = valSucursal;
    filtroTipo.value = valTipo;
    filtroCategoria.value = valCategoria;
}

function obtenerGastosFiltrados() {
    const filtroSucursal = document.getElementById('filtroSucursal').value;
    const filtroTipo = document.getElementById('filtroTipo').value;
    const filtroCategoria = document.getElementById('filtroCategoria').value;
    const ordenMonto = document.getElementById('ordenMonto').value;

    let datos = [...gastosData];

    // Aplicar filtros
    if (filtroSucursal) {
        datos = datos.filter(g => g.sucursal === filtroSucursal);
    }
    if (filtroTipo) {
        datos = datos.filter(g => g.tipo_gasto === filtroTipo);
    }
    if (filtroCategoria) {
        datos = datos.filter(g => g.categoria === filtroCategoria);
    }

    // Aplicar orden
    if (ordenMonto === 'desc') {
        datos.sort((a, b) => b.monto - a.monto);
    } else if (ordenMonto === 'asc') {
        datos.sort((a, b) => a.monto - b.monto);
    }

    return datos;
}

function renderizarTabla() {
    const tbody = document.querySelector('#tablaGastos tbody');

    if (gastosData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="11">
                    <div class="empty-state">
                        <i class="fas fa-inbox empty-state-icon" aria-hidden="true"></i>
                        <h3 class="empty-state-title">No hay gastos registrados</h3>
                        <p class="empty-state-message">
                            Registra tu primer gasto para comenzar el seguimiento financiero de este mes
                        </p>
                        <div class="empty-state-action">
                            <button class="btn btn-primary" onclick="abrirModalGasto()">
                                <i class="fas fa-plus" aria-hidden="true"></i>
                                Registrar Gasto
                            </button>
                        </div>
                    </div>
                </td>
            </tr>
        `;
        document.getElementById('totalTabla').textContent = '$0.00';
        return;
    }

    // Poblar opciones de filtros dinámicamente
    poblarFiltros();

    // Obtener datos filtrados y ordenados
    const datosFiltrados = obtenerGastosFiltrados();

    // Actualizar tarjetas de resumen con datos filtrados
    actualizarResumenFiltrado(datosFiltrados);

    if (datosFiltrados.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="11">
                    <div class="empty-state">
                        <i class="fas fa-filter empty-state-icon" aria-hidden="true"></i>
                        <h3 class="empty-state-title">Sin resultados</h3>
                        <p class="empty-state-message">
                            No se encontraron gastos con los filtros seleccionados
                        </p>
                        <div class="empty-state-action">
                            <button class="btn btn-secondary" onclick="limpiarFiltros()">
                                <i class="fas fa-times" aria-hidden="true"></i>
                                Limpiar Filtros
                            </button>
                        </div>
                    </div>
                </td>
            </tr>
        `;
        document.getElementById('totalTabla').textContent = '$0.00';
        return;
    }

    const totalFiltrado = datosFiltrados.reduce((sum, g) => sum + g.monto, 0);

    tbody.innerHTML = datosFiltrados.map(gasto => {
        const porcentaje = gasto.porcentaje || 0;
        const facturadoTexto = gasto.facturado ? 'Sí' : 'No';
        const facturadoClass = gasto.facturado ? 'si' : 'no';

        return `
            <tr>
                <td data-label="Fecha">${new Date(gasto.fecha + 'T00:00:00').toLocaleDateString('es-MX')}</td>
                <td data-label="Sucursal">${gasto.sucursal}</td>
                <td data-label="Tipo"><span class="badge ${gasto.tipo_gasto.toLowerCase()}">${gasto.tipo_gasto}</span></td>
                <td data-label="Categoría">${gasto.categoria}</td>
                <td data-label="Descripción">${gasto.descripcion || '-'}</td>
                <td data-label="Forma de Pago">${gasto.forma_pago}</td>
                <td data-label="Monto">$${gasto.monto.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td data-label="%">${porcentaje.toFixed(1)}%</td>
                <td data-label="¿Facturado?"><span class="badge ${facturadoClass}">${facturadoTexto}</span></td>
                <td data-label="Comentarios">${gasto.comentarios || '-'}</td>
                <td data-label="Acciones" style="white-space: nowrap;">
                    <button class="btn-action edit" onclick='editarGastoById(${gasto.id})' title="Editar">
                        <i class="fas fa-edit" aria-hidden="true"></i>
                        <span class="sr-only">Editar gasto</span>
                    </button>
                    <button class="btn-action delete" onclick="eliminarGasto(${gasto.id})" title="Eliminar">
                        <i class="fas fa-trash" aria-hidden="true"></i>
                        <span class="sr-only">Eliminar gasto</span>
                    </button>
                </td>
            </tr>
        `;
    }).join('');

    document.getElementById('totalTabla').textContent = `$${totalFiltrado.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
}

function limpiarFiltros() {
    document.getElementById('filtroSucursal').value = '';
    document.getElementById('filtroTipo').value = '';
    document.getElementById('filtroCategoria').value = '';
    document.getElementById('ordenMonto').value = '';
    renderizarTabla();
}

function editarGastoById(id) {
    const gasto = gastosData.find(g => g.id === id);
    if (gasto) {
        abrirModalGasto(gasto);
    }
}

function actualizarResumen(data) {
    const totalMes = data.total_mes || 0;
    const cantidadGastos = data.cantidad_gastos || 0;
    const totalFacturado = data.total_facturado || 0;

    document.getElementById('totalGastosMes').textContent = `$${totalMes.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    document.getElementById('cantidadGastos').textContent = cantidadGastos;
    document.getElementById('gastosFacturados').textContent = `$${totalFacturado.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
}

function actualizarResumenFiltrado(datosFiltrados) {
    const total = datosFiltrados.reduce((sum, g) => sum + g.monto, 0);
    const cantidad = datosFiltrados.length;
    const totalFacturado = datosFiltrados
        .filter(g => g.facturado)
        .reduce((sum, g) => sum + g.monto, 0);

    document.getElementById('totalGastosMes').textContent = `$${total.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    document.getElementById('cantidadGastos').textContent = cantidad;
    document.getElementById('gastosFacturados').textContent = `$${totalFacturado.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
}

function mostrarMensaje(mensaje, tipo) {
    const container = document.getElementById('toastContainer');

    // Crear elemento toast
    const toast = document.createElement('div');
    toast.className = `toast ${tipo}`;

    // Icono según tipo
    const icon = tipo === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';

    toast.innerHTML = `
        <i class="fas ${icon}"></i>
        <span class="toast-message">${mensaje}</span>
    `;

    // Agregar al contenedor
    container.appendChild(toast);

    // Eliminar después de 3 segundos
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

function exportarGastos() {
    // Construir URL con parámetros
    const url = `/contabilidad/exportar-excel?mes=${mesActual}&anio=${anioActual}`;

    // Abrir en nueva ventana para descargar
    window.location.href = url;

    // Mostrar mensaje
    mostrarMensaje('Descargando archivo Excel...', 'success');
}

// ==================== EVENT HANDLERS ====================

// Filtro de mes
document.getElementById('filtroMes').addEventListener('change', function() {
    mesActual = parseInt(this.value);
    cargarGastos();
});

// Filtros de sucursal, tipo, categoría y orden
['filtroSucursal', 'filtroTipo', 'filtroCategoria', 'ordenMonto'].forEach(id => {
    document.getElementById(id).addEventListener('change', function() {
        renderizarTabla();
    });
});

// Submit del formulario
document.getElementById('formGasto').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    // Preparar datos para el API
    const gastoData = {
        fecha: formData.get('fecha'),
        sucursal: formData.get('sucursal'),
        tipo_gasto: formData.get('tipoGasto'),
        categoria: formData.get('categoria') === 'Otro' ? formData.get('otraCategoria') : formData.get('categoria'),
        descripcion: formData.get('descripcion'),
        forma_pago: formData.get('formaPago'),
        monto: parseFloat(formData.get('monto')),
        facturado: formData.get('facturado'),
        comentarios: formData.get('comentarios') || ''
    };

    guardarGasto(gastoData);
});

// Cerrar modal al hacer clic fuera
window.onclick = function(event) {
    const modal = document.getElementById('modalGasto');
    if (event.target === modal) {
        cerrarModalGasto();
    }
}

// ==================== FOCUS TRAP PARA MODALES ====================

function setupFocusTrap(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;

    // Obtener todos los elementos focusables
    const focusableElements = modal.querySelectorAll(
        'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
    );

    if (focusableElements.length === 0) return;

    const firstElement = focusableElements[0];
    const lastElement = focusableElements[focusableElements.length - 1];

    // Guardar elemento que abrió el modal
    const activeElement = document.activeElement;
    modal.dataset.triggerElement = activeElement && activeElement.id ? activeElement.id : '';

    // Handler para teclado
    function handleKeyDown(e) {
        if (e.key === 'Escape') {
            cerrarModalGasto();
            return;
        }

        if (e.key === 'Tab') {
            if (e.shiftKey) {
                // Shift+Tab: si estamos en el primero, ir al último
                if (document.activeElement === firstElement) {
                    e.preventDefault();
                    lastElement.focus();
                }
            } else {
                // Tab: si estamos en el último, ir al primero
                if (document.activeElement === lastElement) {
                    e.preventDefault();
                    firstElement.focus();
                }
            }
        }
    }

    // Agregar listener
    modal.addEventListener('keydown', handleKeyDown);

    // Almacenar handler para poder removerlo después
    modal._focusTrapHandler = handleKeyDown;

    // Focus al primer elemento
    setTimeout(() => firstElement.focus(), 100);
}

function removeFocusTrap(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal || !modal._focusTrapHandler) return;

    // Remover listener
    modal.removeEventListener('keydown', modal._focusTrapHandler);
    delete modal._focusTrapHandler;

    // Restaurar foco al elemento que abrió el modal
    if (modal.dataset.triggerElement) {
        const trigger = document.getElementById(modal.dataset.triggerElement);
        if (trigger) {
            trigger.focus();
        }
    }
}

// ==================== INICIALIZACIÓN ====================

document.addEventListener('DOMContentLoaded', function() {
    // Establecer mes actual en el selector
    document.getElementById('filtroMes').value = mesActual;

    // Cargar gastos iniciales
    cargarGastos();
});
</script>
{% endblock %}
