{% extends "layout.html" %}

{% block content %}
<style>
    /* Zoom base para el modal - se ve bien al 70% en laptops */
    #modalDetalleDiario .modal-content {
        zoom: 0.70;
    }

    /* Estilos para los botones de tipo de meta en el modal */
    #modal-tipo-meta-grupo .btn-outline-secondary {
        border: 2px solid #D4AF37;
        color: #D4AF37;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    #modal-tipo-meta-grupo .btn-outline-secondary:hover {
        background: linear-gradient(135deg, #D4AF37, #B8941F);
        color: white;
        border-color: #D4AF37;
    }

    #modal-tipo-meta-grupo .btn-check:checked + .btn-outline-secondary {
        background: linear-gradient(135deg, #D4AF37, #B8941F);
        color: white;
        border-color: #D4AF37;
    }

    /* Ajustes responsivos para laptops - Reducir tamaños sin transform scale */
    @media (max-width: 1600px) {
        .container {
            max-width: 100%;
            padding: 0 1.2rem;
        }

        h2 {
            font-size: 1.5rem !important;
        }

        .btn {
            font-size: 0.85rem;
            padding: 0.4rem 0.75rem;
        }

        /* AJUSTE ESPECÍFICO PARA TARJETAS DE METAS EN LAPTOPS */
        #metricsContainer {
            gap: 0.7rem !important;
        }

        #metricsContainer .col {
            flex: 0 0 auto;
            width: calc(25% - 0.525rem);
        }

        #metricsContainer .col > div {
            height: 100px !important;
            padding: 0.4rem !important;
        }

        #metricsContainer .icon-circle {
            width: 32px !important;
            height: 32px !important;
            margin-bottom: 0.25rem !important;
        }

        #metricsContainer .icon-circle i {
            font-size: 0.85rem !important;
        }

        #metricsContainer h6 {
            font-size: 0.65rem !important;
            margin-bottom: 0.25rem !important;
        }

        #metricsContainer p {
            font-size: 0.75rem !important;
            margin-bottom: 0.15rem !important;
        }

        #metricsContainer small {
            font-size: 0.5rem !important;
        }

        #metricsContainer .badge {
            font-size: 0.45rem !important;
            padding: 1px 4px !important;
        }

        /* REDUCIR TAMAÑO DE BARÓMETROS EN LAPTOPS - PANTALLA PRINCIPAL */
        #canales-container .barometer-container {
            width: 220px !important;
            height: 115px !important;
            margin: 0 auto !important;
        }

        #canales-container .barometer-container svg {
            width: 220px !important;
            height: 115px !important;
        }

        /* Ajustar cards de canales */
        #canales-container .canal-card {
            min-height: 300px !important;
        }

        #canales-container .card-body {
            padding: 1rem !important;
        }
    }

    @media (max-width: 1440px) {
        h2 {
            font-size: 1.3rem !important;
        }

        .card-body {
            padding: 0.8rem !important;
        }

        .btn {
            font-size: 0.8rem;
            padding: 0.35rem 0.7rem;
        }

        /* AJUSTE MÁS AGRESIVO PARA TARJETAS DE METAS EN LAPTOPS 1440px */
        #metricsContainer {
            gap: 0.9rem !important;
        }

        #metricsContainer .col {
            width: calc(25% - 0.675rem);
        }

        #metricsContainer .col > div {
            height: 130px !important;
            padding: 0.6rem !important;
        }

        #metricsContainer .icon-circle {
            width: 40px !important;
            height: 40px !important;
            margin-bottom: 0.4rem !important;
        }

        #metricsContainer .icon-circle i {
            font-size: 1rem !important;
        }

        #metricsContainer h6 {
            font-size: 0.75rem !important;
            margin-bottom: 0.3rem !important;
        }

        #metricsContainer p {
            font-size: 0.9rem !important;
            margin-bottom: 0.25rem !important;
        }

        #metricsContainer small {
            font-size: 0.6rem !important;
        }

        #metricsContainer .badge {
            font-size: 0.55rem !important;
            padding: 2px 5px !important;
        }

        /* REDUCIR BARÓMETROS PARA 1440px */
        #canales-container .barometer-container {
            width: 200px !important;
            height: 105px !important;
        }

        #canales-container .barometer-container svg {
            width: 200px !important;
            height: 105px !important;
        }

        #canales-container .canal-card {
            min-height: 280px !important;
        }

        #canales-container .card-body {
            padding: 0.8rem !important;
        }
    }

    @media (max-width: 1366px) {
        /* Para laptops estándar (1366x768) - Reducir todo proporcionalmente */
        h2 {
            font-size: 1.1rem !important;
            margin-bottom: 0.7rem !important;
        }

        h5 {
            font-size: 0.85rem !important;
        }

        h6 {
            font-size: 0.75rem !important;
        }

        .container {
            padding: 0 0.8rem;
        }

        .card-body {
            padding: 0.6rem !important;
        }

        .btn {
            font-size: 0.7rem;
            padding: 0.3rem 0.6rem;
        }

        /* AJUSTE CRÍTICO PARA TARJETAS DE METAS EN LAPTOPS 1366px */
        #metricsContainer {
            gap: 0.8rem !important;
        }

        #metricsContainer .col {
            width: calc(25% - 0.6rem);
        }

        #metricsContainer .col > div {
            height: 115px !important;
            padding: 0.5rem !important;
        }

        #metricsContainer .icon-circle {
            width: 35px !important;
            height: 35px !important;
            margin-bottom: 0.3rem !important;
        }

        #metricsContainer .icon-circle i {
            font-size: 0.9rem !important;
        }

        #metricsContainer h6 {
            font-size: 0.7rem !important;
            margin-bottom: 0.25rem !important;
        }

        #metricsContainer p {
            font-size: 0.85rem !important;
            margin-bottom: 0.2rem !important;
        }

        #metricsContainer small {
            font-size: 0.55rem !important;
        }

        #metricsContainer .badge {
            font-size: 0.5rem !important;
            padding: 2px 4px !important;
        }

        /* REDUCIR BARÓMETROS PARA 1366px - MÁS PEQUEÑOS AÚN */
        #canales-container .barometer-container {
            width: 180px !important;
            height: 95px !important;
        }

        #canales-container .barometer-container svg {
            width: 180px !important;
            height: 95px !important;
        }

        #canales-container .canal-card {
            min-height: 260px !important;
        }

        #canales-container .card-body {
            padding: 0.6rem !important;
        }

        #canales-container .card-header h6 {
            font-size: 0.9rem !important;
        }

        /* Modal más compacto */
        #modalDetalleDiario .modal-dialog {
            max-width: 95% !important;
            width: 95% !important;
        }

        #modalDetalleDiario .modal-header {
            padding: 0.6rem 0.8rem !important;
        }

        #modalDetalleDiario .modal-header h5 {
            font-size: 0.85rem !important;
        }

        #modalDetalleDiario .modal-body {
            padding: 0.7rem !important;
        }

        #modalDetalleDiario .card-body {
            padding: 0.5rem !important;
        }

        #modalDetalleDiario h6 {
            font-size: 0.7rem !important;
            margin-bottom: 0.4rem !important;
        }

        /* Reducir cards de totales */
        #modalDetalleDiario .card {
            margin-bottom: 0.8rem !important;
        }

        /* Barómetros más pequeños */
        #modal-barometros-container {
            gap: 0.6rem !important;
        }

        #modal-barometros-container .barometer-container {
            width: 170px !important;
            height: 95px !important;
        }

        #modal-barometros-container svg {
            width: 170px !important;
            height: 95px !important;
        }

        /* Tablas más compactas */
        .detalle-diario-tabla {
            max-height: 170px !important;
            margin-top: 0.5rem !important;
        }

        #modal-barometros-container table {
            font-size: 0.65rem !important;
        }

        #modal-barometros-container thead {
            font-size: 0.6rem !important;
        }

        #modal-barometros-container .table td,
        #modal-barometros-container .table th {
            padding: 0.2rem 0.3rem !important;
        }

        /* Reducir form controls */
        #modalDetalleDiario .form-label {
            font-size: 0.7rem !important;
            margin-bottom: 0.25rem !important;
        }

        #modalDetalleDiario .form-select,
        #modalDetalleDiario .btn-group label {
            font-size: 0.7rem !important;
            padding: 0.3rem 0.5rem !important;
        }

        /* Reducir iconos */
        #modalDetalleDiario i {
            font-size: 0.8rem;
        }
    }

    @media (max-width: 1280px) {
        /* Para laptops más pequeñas (1280x720, 1280x800) */
        h2 {
            font-size: 1rem !important;
        }

        .container {
            padding: 0 0.6rem;
        }

        .card-body {
            padding: 0.5rem !important;
        }

        .btn {
            font-size: 0.65rem;
            padding: 0.25rem 0.5rem;
        }

        /* Modal aún más compacto */
        #modalDetalleDiario .modal-header {
            padding: 0.5rem 0.7rem !important;
        }

        #modalDetalleDiario .modal-body {
            padding: 0.6rem !important;
        }

        /* Barómetros más pequeños */
        #modal-barometros-container .barometer-container {
            width: 150px !important;
            height: 85px !important;
        }

        #modal-barometros-container svg {
            width: 150px !important;
            height: 85px !important;
        }

        .detalle-diario-tabla {
            max-height: 140px !important;
        }

        #modal-barometros-container table {
            font-size: 0.6rem !important;
        }

        #modal-barometros-container thead {
            font-size: 0.55rem !important;
        }
    }

    /* Para monitores grandes (1920px+) mantener el diseño actual */
    @media (min-width: 1920px) {
        .container {
            max-width: 1800px;
        }
    }

    /* ========================================== */
    /* ESTILOS PARA TABLA UNIFICADA */
    /* ========================================== */

    /* Eliminar espacios entre las cards de los canales */
    /* Container del modal - sin grid (cada fila maneja su propio grid) */
    #modal-barometros-container {
        gap: 0 !important;
    }

    /* Ajustes para laptops - reducir tamaños pero mantener 4 columnas */
    @media screen and (max-width: 1600px) {
        #modal-barometros-container .barometer-container {
            width: 180px !important;
            height: 100px !important;
        }

        #modal-barometros-container svg {
            width: 180px !important;
            height: 100px !important;
        }

        #modal-barometros-container .metric-card {
            padding: 0.5rem !important;
        }

        #modal-barometros-container .metric-value {
            font-size: 0.75rem !important;
        }

        #modal-barometros-container .metric-label {
            font-size: 0.65rem !important;
        }

        .detalle-diario-tabla {
            max-height: 200px !important;
        }

        #modal-barometros-container table {
            font-size: 0.7rem !important;
        }

        #modal-barometros-container thead {
            font-size: 0.65rem !important;
        }

        #modal-barometros-container .card-header h6 {
            font-size: 0.75rem !important;
        }

        #modal-barometros-container .percentage-value {
            font-size: 1.1rem !important;
        }
    }

    /* Ajustes más agresivos para laptops pequeñas (1366px) */
    @media screen and (max-width: 1366px) {
        #modal-barometros-container .barometer-container {
            width: 160px !important;
            height: 90px !important;
        }

        #modal-barometros-container svg {
            width: 160px !important;
            height: 90px !important;
        }

        #modal-barometros-container .metric-card {
            padding: 0.4rem !important;
        }

        #modal-barometros-container .metric-value {
            font-size: 0.7rem !important;
        }

        #modal-barometros-container .metric-label {
            font-size: 0.6rem !important;
        }

        .detalle-diario-tabla {
            max-height: 180px !important;
        }

        #modal-barometros-container table {
            font-size: 0.65rem !important;
        }

        #modal-barometros-container thead {
            font-size: 0.6rem !important;
        }

        #modal-barometros-container .percentage-value {
            font-size: 1rem !important;
        }
    }

    /* Eliminar bordes y espacios de las cards para que se vean continuas */
    #modal-barometros-container .canal-card {
        margin: 0 !important;
        padding: 0 !important;
    }

    /* QUITAR TODAS LAS LÍNEAS ENTRE GRÁFICOS */
    #modal-barometros-container .canal-card .card {
        border-radius: 0 !important;
        border: none !important;
        margin: 0 !important;
        box-shadow: none !important;
    }

    /* Hacer que las tablas se vean como parte de una tabla unificada */
    #modal-barometros-container .detalle-diario-tabla {
        margin-top: 0.5rem !important;
        border-radius: 0 !important;
    }

    /* ESTILOS PARA TABLA UNIFICADA */
    .tabla-unificada-container {
        overflow-x: auto;
        overflow-y: auto;
    }

    .tabla-unificada-container table {
        width: 100%;
        border-collapse: collapse;
    }

    .tabla-unificada-container thead th {
        position: sticky;
        top: 0;
        background: #fff;
        z-index: 2;
    }

    .tabla-unificada-container thead th:first-child {
        position: sticky;
        left: 0;
        z-index: 3 !important;
        background: #e9ecef;
    }

    .fila-completa .graficos-container .card {
        margin: 0 !important;
        border-radius: 0 !important;
    }

    /* Eliminar bordes de las tablas individuales */
    #modal-barometros-container .detalle-diario-tabla table {
        border: none !important;
        margin-bottom: 0 !important;
    }

    /* Hacer que los headers se vean como una fila continua */
    #modal-barometros-container .detalle-diario-tabla thead {
        background: #f8f9fa !important;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    #modal-barometros-container .detalle-diario-tabla thead th {
        border-bottom: 2px solid #dee2e6 !important;
        border-right: 1px solid #e9ecef;
    }

    /* Última columna de cada tabla sin borde derecho */
    #modal-barometros-container .detalle-diario-tabla thead th:last-child {
        border-right: none;
    }

    /* Hacer que las filas se vean alineadas */
    #modal-barometros-container .detalle-diario-tabla tbody td {
        border-right: 1px solid #e9ecef;
        border-bottom: 1px solid #f1f3f5;
    }

    /* Última columna sin borde derecho */
    #modal-barometros-container .detalle-diario-tabla tbody td:last-child {
        border-right: none;
    }

    /* Efecto hover unificado */
    #modal-barometros-container .detalle-diario-tabla tbody tr:hover {
        background-color: rgba(212, 175, 55, 0.05) !important;
    }

    /* Sincronizar altura mínima de las cards */
    #modal-barometros-container .canal-card {
        display: flex;
        flex-direction: column;
    }

    #modal-barometros-container .canal-card .card {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    /* Asegurar que todas las tablas tengan la misma altura */
    #modal-barometros-container .detalle-diario-tabla {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
    }
</style>
<div id="content-wrapper-cumplimiento">
<div class="container mt-4">
    <h2 class="mb-4" data-aos="fade-down" style="color: #2C2C2C; font-weight: 700;">
        <i class="bi bi-bullseye me-3" style="color: #D4AF37;"></i>Cumplimiento de Metas por Canal
    </h2>

    <!-- FILTRO PRINCIPAL DE MES -->
    <form method="GET" action="{{ url_for('cumplimiento_metas.cumplimiento_metas') }}" class="row g-3 align-items-end mb-4" data-aos="fade-down">
        <div class="col-md-3">
            <label for="mes_filtro" class="form-label" style="color: #2C2C2C; font-weight: 600;"><strong>Filtrar por Mes:</strong></label>
            <select class="form-select" name="mes_filtro" id="mes_filtro" style="border: 2px solid #f8f9fa; transition: all 0.3s ease;">
                <!-- Enero -->
                <option value="1" {% if mes_seleccionado == 1 %}selected{% endif %}>
                    Enero 2026
                </option>
                <!-- Agosto -->
                <option value="8" {% if mes_seleccionado == 8 %}selected{% endif %}>
                    Agosto 2025
                </option>
                <!-- Septiembre -->
                <option value="9" {% if mes_seleccionado == 9 %}selected{% endif %}>
                    Septiembre 2025
                </option>
                <!-- Octubre -->
                <option value="10" {% if mes_seleccionado == 10 %}selected{% endif %}>
                    Octubre 2025
                </option>
                <!-- Noviembre -->
                <option value="11" {% if mes_seleccionado == 11 %}selected{% endif %}>
                    Noviembre 2025
                </option>
                <!-- Diciembre -->
                <option value="12" {% if mes_seleccionado == 12 %}selected{% endif %}>
                    Diciembre 2025
                </option>
            </select>
        </div>
        
        <div class="col-md-3">
            <label class="form-label d-block invisible">Acción</label>
            <button type="submit" class="btn btn-warning w-100"
                    style="background-color: #D4AF37; border-color: #D4AF37; color: #2C2C2C; font-weight: 600; transition: all 0.3s ease;">
                <i class="bi bi-funnel-fill me-2"></i>Aplicar Filtro
            </button>
        </div>

        <!-- Botón Cumplimiento Hoy -->
        <div class="col-md-3">
            <label class="form-label d-block invisible">Hoy</label>
            <button type="button" class="btn btn-primary w-100" id="btn-cumplimiento-hoy"
                    style="background: linear-gradient(135deg, #17a2b8, #138496); border: none; color: white; font-weight: 600; padding: 12px 20px; transition: all 0.3s ease;">
                <i class="bi bi-calendar-check me-2"></i>Cumplimiento Hoy
            </button>
        </div>
    </form>

    {% if error %}
    <div class="alert alert-danger" role="alert" data-aos="shake">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>{{ error }}
    </div>
    {% endif %}




    <!-- SECCIÓN ORIGINAL: CUMPLIMIENTO DE METAS -->
    <h3 class="mb-4" data-aos="fade-down" style="color: #2C2C2C; font-weight: 600; font-size: 1.5rem;">
        <i class="bi bi-bullseye me-3" style="color: #D4AF37;"></i>Cumplimiento de Metas por Canal
    </h3>
    
    <!-- SELECTOR TIPO DE METAS -->
    <div class="mb-4" data-aos="fade-up" data-aos-delay="50">
        <div class="d-flex justify-content-center">
            <div class="btn-group" role="group" aria-label="Tipo de metas" style="box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 12px; overflow: hidden;">
                <button type="button" class="btn tipo-meta-btn active" data-tipo="ventas" data-tipo-meta="ventas"
                        onclick="window.cambiarTipoMetaInstantaneo('ventas')"
                        style="background: linear-gradient(135deg, #D4AF37, #B8941F); color: white; border: none; padding: 12px 20px; font-weight: 600; transition: all 0.3s ease;">
                    <i class="bi bi-currency-dollar me-2"></i>Metas de Ventas
                </button>
                <button type="button" class="btn tipo-meta-btn" data-tipo="costo" data-tipo-meta="costo"
                        onclick="window.cambiarTipoMetaInstantaneo('costo')"
                        style="background: #f8f9fa; color: #2C2C2C; border: none; padding: 12px 20px; font-weight: 600; transition: all 0.3s ease;">
                    <i class="bi bi-graph-down me-2"></i>Metas de Costo
                </button>
                <button type="button" class="btn tipo-meta-btn" data-tipo="ingreso_real_nominal" data-tipo-meta="ingreso_real_nominal"
                        onclick="window.cambiarTipoMetaInstantaneo('ingreso_real_nominal')"
                        style="background: #f8f9fa; color: #2C2C2C; border: none; padding: 12px 20px; font-weight: 600; transition: all 0.3s ease;">
                    <i class="bi bi-coin me-2"></i>Metas Ingreso Real Nominal
                </button>
            </div>
        </div>
    </div>
    
    <!-- FILTROS PARA CUMPLIMIENTO DE METAS -->
    <form class="metas-form row g-3 align-items-end mb-4" id="metas-form-ajax" data-aos="fade-up" data-aos-delay="100">
        
        <div class="col-md-3">
            <label for="preset_main" class="form-label" style="color: #2C2C2C; font-weight: 600;"><strong>Período a analizar:</strong></label>
            <select name="preset_main" id="preset_main" class="form-select" style="border: 2px solid #f8f9fa; transition: all 0.3s ease;">
                <option value="hoy" {% if selected_preset_main == "hoy" %}selected{% endif %}>Hoy</option>
                <option value="7" {% if selected_preset_main == "7" %}selected{% endif %}>Últimos 7 días</option>
                <option value="15" {% if selected_preset_main == "15" %}selected{% endif %}>Últimos 15 días</option>
                <option value="mes_actual" {% if selected_preset_main == "mes_actual" %}selected{% endif %}>Mes actual hasta hoy</option>
                <option value="mes_completo" {% if selected_preset_main == "mes_completo" %}selected{% endif %}>Mes completo (anterior)</option>
                <option value="personalizado" {% if selected_preset_main == "personalizado" %}selected{% endif %}>Fecha personalizada</option>
            </select>
        </div>

        <div class="col-md-3" id="main_range_group" {% if selected_preset_main != "personalizado" %}style="display:none;"{% endif %}>
            <label for="main_range" class="form-label" style="color: #2C2C2C; font-weight: 600;">Rango personalizado:</label>
            <input type="text" id="main_range" name="main_range" class="form-control" 
                   value="{{ selected_main_range }}" placeholder="Selecciona un rango" readonly
                   style="border: 2px solid #f8f9fa; transition: all 0.3s ease;">
        </div>

        <div class="col-md-3">
            <label for="canales_filter" class="form-label" style="color: #2C2C2C; font-weight: 600;"><strong>Filtrar Canales:</strong></label>
            <div class="dropdown w-100">
                <button class="btn dropdown-toggle w-100 text-start" type="button" id="canalesDropdown" 
                        data-bs-toggle="dropdown" aria-expanded="false"
                        style="border: 2px solid #f8f9fa; background: white; color: #2C2C2C; transition: all 0.3s ease;">
                    <i class="bi bi-broadcast me-2" style="color: #D4AF37;"></i>
                    <span id="canales-selected-text">Todos los canales</span>
                    <span class="badge bg-warning ms-2" id="canales-count" style="background-color: #D4AF37 !important; display: none;"></span>
                </button>
                <ul class="dropdown-menu" aria-labelledby="canalesDropdown" 
                    style="max-height: 250px; overflow-y: auto; border: 2px solid rgba(212, 175, 55, 0.3); border-radius: 8px; min-width: 350px; width: 350px; left: 50%; transform: translateX(-60%);">
                    
                    <!-- Opción para seleccionar todos -->
                    <li>
                        <div class="form-check dropdown-item-check" style="padding: 8px 30px;">
                            <input class="form-check-input" type="checkbox" id="canal_todos" 
                                   onchange="toggleAllCanales(this)" checked>
                            <label class="form-check-label fw-semibold" for="canal_todos" style="color: #D4AF37;">
                                <i class="bi bi-check-all me-2"></i>Seleccionar Todos
                            </label>
                        </div>
                    </li>
                    <li><hr class="dropdown-divider" style="border-color: rgba(212, 175, 55, 0.3);"></li>
                    
                    {% if cumplimiento_data %}
                    {% for canal in cumplimiento_data %}
                    {% if canal.es_fila_principal %}
                    <li>
                        <div class="form-check dropdown-item-check" style="padding: 8px 30px;">
                            <input class="form-check-input canal-checkbox" type="checkbox" 
                                   name="canales_seleccionados" value="{{ canal.canal }}" 
                                   id="canal_{{ loop.index }}" checked
                                   onchange="updateCanalesSelection()">
                            <label class="form-check-label d-flex align-items-center justify-content-between" 
                                   for="canal_{{ loop.index }}" style="width: 100%; font-size: 0.9rem;">
                                <span class="text-truncate" style="max-width: 260px;">
                                    {{ canal.canal }}
                                </span>
                                <div class="canal-status-mini" style="width: 8px; height: 8px; border-radius: 50%; margin-left: 2px;
                                                                background: {% if canal.cumplimiento >= 100 %}#28a745{% elif canal.cumplimiento >= 50 %}#ffc107{% else %}#dc3545{% endif %};
                                                                flex-shrink: 0;"></div>
                            </label>
                        </div>
                    </li>
                    {% endif %}
                    {% endfor %}
                    {% endif %}
                </ul>
            </div>
        </div>

        <div class="col-md-3">
            <label class="form-label d-block invisible">Acción</label>
            <div class="d-flex gap-2">
                <!-- Botón principal para analizar con datos precalculados -->
                <button type="button" class="btn btn-warning flex-grow-1" id="btn-analizar-rapido"
                        style="background-color: #D4AF37; border-color: #D4AF37; color: #2C2C2C; font-weight: 600; transition: all 0.3s ease;">
                    <i class="bi bi-bullseye me-2"></i>Analizar Cumplimiento
                </button>

                <!-- Botón pequeño para actualizar datos desde servidor -->
                <button type="button" class="btn btn-outline-secondary" id="btn-actualizar-datos"
                        style="width: 45px; height: 38px; padding: 0; border-radius: 8px; transition: all 0.3s ease;"
                        data-bs-toggle="tooltip"
                        data-bs-placement="top"
                        data-bs-title="Actualizar datos desde servidor">
                    <i class="bi bi-arrow-clockwise" style="font-size: 1rem;"></i>
                </button>
            </div>
        </div>

        <!-- Botón para Ver Detalle Diario -->
        <div class="col-md-3">
            <label class="form-label d-block invisible">Detalle</label>
            <button type="button" class="btn btn-primary w-100" id="btn-ver-detalle-diario"
                    style="background: linear-gradient(135deg, #D4AF37, #B8941F); border: none; color: white; font-weight: 600; padding: 12px 20px; transition: all 0.3s ease;">
                <i class="bi bi-calendar-week me-2"></i>Ver Detalle Diario
            </button>
        </div>
    </form>
    
    <!-- CONTENEDOR AJAX PARA LA SECCIÓN DE CUMPLIMIENTO DE METAS -->
    <div id="cumplimiento-section-content">
    
    <!-- RESUMEN GENERAL - DISEÑO HÍBRIDO: MODERNO + ÍCONOS CIRCULARES -->
    <div class="row g-4 mb-4" id="metricsContainer" data-aos="fade-up" data-aos-delay="200" style="overflow: visible;">
        
        <!-- Tarjeta Dinámica: Período / Ventas del Período / Ingreso Real del Período -->
        <div class="col" data-aos="fade-up" data-aos-delay="700">
            <div class="p-4 shadow-sm border rounded-3 bg-white position-relative text-center"
                 style="height: 170px; transition: all 0.3s ease; cursor: pointer; border: 1px solid rgba(212, 175, 55, 0.2);"
                 onmouseenter="animateMetricCard(this)"
                 onmouseleave="resetMetricCard(this)">

                <!-- Efecto de fondo sutil -->
                <div class="position-absolute top-0 start-0 w-100 h-100 opacity-5"
                     style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.08) 0%, transparent 100%);"></div>

                <!-- Ícono dinámico según tipo de meta -->
                <div class="icon-circle mb-3 mx-auto position-relative"
                     style="width: 60px; height: 60px; background: linear-gradient(135deg, #D4AF37, #B8941F);
                            border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="bi tarjeta-periodo-icono {% if resumen_general.tipo_meta == 'ventas' %}bi-currency-dollar{% elif resumen_general.tipo_meta == 'ingreso_real_nominal' %}bi-cash-coin{% else %}bi-calendar-check{% endif %} text-white" style="font-size: 1.5rem;"></i>
                </div>

                <!-- Título dinámico según tipo de meta -->
                <h6 class="mb-2 position-relative tarjeta-periodo-titulo" style="color: #2C2C2C; font-weight: 600;">
                    {% if resumen_general.tipo_meta == 'ventas' %}
                        Ventas del Período
                    {% elif resumen_general.tipo_meta == 'ingreso_real_nominal' %}
                        Ingreso Real del Período
                    {% else %}
                        Período
                    {% endif %}
                </h6>

                <!-- Contenido dinámico según tipo de meta -->
                <p class="position-relative tarjeta-periodo-contenido" style="color: {% if resumen_general.tipo_meta == 'costo' %}#6c757d{% else %}#D4AF37{% endif %}; font-size: {% if resumen_general.tipo_meta == 'costo' %}0.9rem{% else %}1.1rem{% endif %}; margin-bottom: 8px; font-weight: {% if resumen_general.tipo_meta == 'costo' %}400{% else %}700{% endif %};">
                    {% if resumen_general.tipo_meta == 'ventas' %}
                        <span class="animated-number"
                              data-value="{{ resumen_general.ventas_periodo_total }}"
                              data-type="currency">
                            ${{ "{:,.0f}".format(resumen_general.ventas_periodo_total) }}
                        </span>
                    {% elif resumen_general.tipo_meta == 'ingreso_real_nominal' %}
                        <span class="animated-number"
                              data-value="{{ resumen_general.ingreso_real_periodo_total }}"
                              data-type="currency">
                            ${{ "{:,.0f}".format(resumen_general.ingreso_real_periodo_total) }}
                        </span>
                    {% else %}
                        {{ periodo_texto }}
                    {% endif %}
                </p>

                <!-- Barra de progreso sutil en la parte inferior -->
                <div class="position-absolute bottom-0 start-0 w-100" style="height: 3px; background: rgba(212, 175, 55, 0.1);">
                    <div class="h-100 transition-all"
                         style="background: linear-gradient(90deg, #D4AF37, #F4E4A6);
                                width: 0%;
                                transition: width 1.5s ease 1.8s;"></div>
                </div>
            </div>
        </div>
        <!-- Meta Período -->
        <div class="col" data-aos="fade-up" data-aos-delay="800">
            <div class="p-4 shadow-sm border rounded-3 bg-white position-relative text-center" 
                 style="height: 170px; transition: all 0.3s ease; cursor: pointer; border: 1px solid rgba(212, 175, 55, 0.2);"
                 onmouseenter="animateMetricCard(this)"
                 onmouseleave="resetMetricCard(this)">
                
                <!-- Efecto de fondo sutil -->
                <div class="position-absolute top-0 start-0 w-100 h-100 opacity-5" 
                     style="background: linear-gradient(135deg, rgba(23, 162, 184, 0.08) 0%, transparent 100%);"></div>
                
                <div class="icon-circle mb-3 mx-auto position-relative" 
                     style="width: 60px; height: 60px; background: linear-gradient(135deg, #17a2b8, #6f42c1); 
                            border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-bullseye text-white" style="font-size: 1.5rem;"></i>
                </div>
                
                <h6 class="mb-2 position-relative" style="color: #2C2C2C; font-weight: 600;">Meta Período</h6>
                <p class="mb-0 fw-bold position-relative" style="color: #17a2b8; font-size: 1.1rem;">
                    <span class="animated-number" 
                          data-value="{{ resumen_general.meta_total }}"
                          data-type="currency">
                        ${{ "{:,.0f}".format(resumen_general.meta_total) }}
                    </span>
                </p>
                
                <!-- Barra de progreso sutil en la parte inferior -->
                <div class="position-absolute bottom-0 start-0 w-100" style="height: 3px; background: rgba(212, 175, 55, 0.1);">
                    <div class="h-100 transition-all" 
                         style="background: linear-gradient(90deg, #17a2b8, #6f42c1); 
                                width: 0%; 
                                transition: width 1.5s ease 2.0s;"></div>
                </div>
            </div>
        </div>
        
        <!-- Meta Total del Mes -->
        <div class="col" data-aos="fade-up" data-aos-delay="900">
            <div class="p-3 shadow-sm border rounded-3 bg-white position-relative text-center d-flex flex-column justify-content-center" 
                 style="height: 170px; transition: all 0.3s ease; cursor: pointer; border: 1px solid rgba(212, 175, 55, 0.2);"
                 onmouseenter="animateMetricCard(this)"
                 onmouseleave="resetMetricCard(this)">
                
                <!-- Efecto de fondo sutil -->
                <div class="position-absolute top-0 start-0 w-100 h-100 opacity-5" 
                     style="background: linear-gradient(135deg, rgba(111, 66, 193, 0.08) 0%, transparent 100%);"></div>
                
                <div class="icon-circle mb-2 mx-auto position-relative" 
                     style="width: 50px; height: 50px; background: linear-gradient(135deg, #6f42c1, #e83e8c); 
                            border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-calendar-month text-white" style="font-size: 1.2rem;"></i>
                </div>
                
                <h6 class="mb-1 position-relative" style="color: #2C2C2C; font-weight: 600; font-size: 0.9rem;">Meta Total del Mes</h6>
                <p class="mb-1 fw-bold position-relative" style="color: #6f42c1; font-size: 1rem;">
                    <span class="animated-number" 
                          data-value="{{ resumen_general.meta_total_mes }}"
                          data-type="currency">
                        ${{ "{:,.0f}".format(resumen_general.meta_total_mes) }}
                    </span>
                </p>
                <small class="text-center position-relative d-block">
                    <span class="badge" style="font-size: 0.7rem; color: #2C2C2C; font-weight: 600; 
                                              background-color: {% if resumen_general.cumplimiento_vs_meta_mes >= 100 %}rgba(40, 167, 69, 0.15){% elif resumen_general.cumplimiento_vs_meta_mes >= 50 %}rgba(255, 193, 7, 0.15){% else %}rgba(108, 117, 125, 0.15){% endif %}; 
                                              border: 1px solid {% if resumen_general.cumplimiento_vs_meta_mes >= 100 %}rgba(40, 167, 69, 0.3){% elif resumen_general.cumplimiento_vs_meta_mes >= 50 %}rgba(255, 193, 7, 0.3){% else %}rgba(108, 117, 125, 0.3){% endif %}; 
                                              border-radius: 12px; padding: 4px 8px;">
                        {{ "{:.1f}".format(resumen_general.cumplimiento_vs_meta_mes) }}% del período
                    </span>
                </small>
                
                <!-- Barra de progreso sutil en la parte inferior -->
                <div class="position-absolute bottom-0 start-0 w-100" style="height: 3px; background: rgba(212, 175, 55, 0.1);">
                    <div class="h-100 transition-all" 
                         style="background: linear-gradient(90deg, #6f42c1, #e83e8c); 
                                width: 0%; 
                                transition: width 1.5s ease 2.2s;"></div>
                </div>
            </div>
        </div>
        
        <!-- Cumplimiento de Período -->
        <div class="col" data-aos="fade-up" data-aos-delay="1000">
            <div class="p-3 shadow-sm border rounded-3 bg-white position-relative text-center d-flex flex-column justify-content-center"
                 style="height: 170px; transition: all 0.3s ease; cursor: pointer; border: 1px solid rgba(212, 175, 55, 0.2);"
                 onmouseenter="animateMetricCard(this)"
                 onmouseleave="resetMetricCard(this)">

                <!-- Efecto de fondo sutil con color dinámico -->
                <div class="position-absolute top-0 start-0 w-100 h-100 opacity-5"
                     style="background: linear-gradient(135deg, {{ 'rgba(40, 167, 69, 0.08)' if resumen_general.cumplimiento_global >= 100 else 'rgba(255, 193, 7, 0.08)' if resumen_general.cumplimiento_global >= 50 else 'rgba(220, 53, 69, 0.08)' }} 0%, transparent 100%);"></div>

                <div class="icon-circle mb-2 mx-auto position-relative"
                     style="width: 50px; height: 50px; background: linear-gradient(135deg,
                            {% if resumen_general.cumplimiento_global >= 100 %}#28a745{% elif resumen_general.cumplimiento_global >= 50 %}#ffc107{% else %}#dc3545{% endif %},
                            {% if resumen_general.cumplimiento_global >= 100 %}#20c997{% elif resumen_general.cumplimiento_global >= 50 %}#ffca2c{% else %}#e55353{% endif %});
                            border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-percent text-white" style="font-size: 1.2rem;"></i>
                </div>

                <h6 class="mb-1 position-relative" style="color: #2C2C2C; font-weight: 600; font-size: 0.9rem;">Cumplimiento de Período</h6>
                <p class="mb-1 fw-bold position-relative" style="font-size: 1.1rem; color: {% if resumen_general.cumplimiento_global >= 100 %}#28a745{% elif resumen_general.cumplimiento_global >= 50 %}#ffc107{% else %}#dc3545{% endif %};">
                    <span class="animated-number"
                          data-value="{{ resumen_general.cumplimiento_global }}"
                          data-type="percentage">
                        {{ "{:.1f}".format(resumen_general.cumplimiento_global) }}%
                    </span>
                </p>
                <small class="text-muted text-center position-relative d-block" style="font-size: 0.7rem;">
                    Del período seleccionado
                </small>

                <!-- Barra de progreso sutil en la parte inferior con color dinámico -->
                <div class="position-absolute bottom-0 start-0 w-100" style="height: 3px; background: rgba(212, 175, 55, 0.1);">
                    <div class="h-100 transition-all"
                         style="background: linear-gradient(90deg, {% if resumen_general.cumplimiento_global >= 100 %}#28a745, #20c997{% elif resumen_general.cumplimiento_global >= 50 %}#ffc107, #ffca2c{% else %}#dc3545, #e55353{% endif %});
                                width: 0%;
                                transition: width 1.5s ease 2.4s;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- GRÁFICOS MEJORADOS POR CANAL -->
    <div class="row g-4 mb-4" id="canales-container" data-aos="fade-up" data-aos-delay="300" 
         style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem;">
        {% for canal in cumplimiento_data %}
        {% if canal.es_fila_principal %}
        <div class="canal-card" data-canal="{{ canal.canal }}" style="min-height: 400px;">
            <div class="card h-100 shadow-sm" style="border: none; border-radius: 16px; overflow: hidden; 
                                                    background: linear-gradient(145deg, #ffffff, #f8f9fa);">
                <div class="card-header border-0 pb-2" style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.08), rgba(212, 175, 55, 0.04));">
                    <div class="d-flex align-items-center justify-content-between">
                        <h6 class="mb-0 fw-bold canal-title" style="color: #2C2C2C; font-size: 1.1rem;">
                            <i class="bi bi-broadcast me-2" style="color: #D4AF37;"></i>{{ canal.canal }}
                        </h6>
                        <div class="canal-status-indicator" style="width: 12px; height: 12px; border-radius: 50%; 
                                                                   background: {% if canal.cumplimiento >= 100 %}#28a745{% elif canal.cumplimiento >= 50 %}#ffc107{% else %}#dc3545{% endif %};
                                                                   box-shadow: 0 0 8px {% if canal.cumplimiento >= 100 %}rgba(40, 167, 69, 0.4){% elif canal.cumplimiento >= 50 %}rgba(255, 193, 7, 0.4){% else %}rgba(220, 53, 69, 0.4){% endif %};"></div>
                    </div>
                </div>
                <div class="card-body text-center p-4">
                    <!-- BARÓMETRO PARA VENTAS (por defecto visible) -->
                    <div class="barometer-container mb-4 sales-barometer" style="position: relative; width: 320px; height: 170px; margin: 0 auto;">
                        <svg width="320" height="170" viewBox="0 0 320 170">
                            <!-- Fondo para el texto "META" -->
                            <rect x="275" y="35" 
                                  width="30" height="16" 
                                  rx="3" ry="3"
                                  fill="rgba(255, 255, 255, 0.9)" 
                                  stroke="rgba(44, 44, 44, 0.2)" 
                                  stroke-width="1"/>
                            
                            <!-- Texto "META" -->
                            <text x="290" y="47" 
                                  font-family="Arial, sans-serif" 
                                  font-size="9" 
                                  font-weight="600" 
                                  fill="{% if canal.cumplimiento > 100 %}#1e7e34{% else %}#2C2C2C{% endif %}" 
                                  text-anchor="middle"
                                  opacity="1">META</text>
                            
                            <!-- Arco de fondo -->
                            <path d="M 20 150 A 140 140 0 0 1 300 150" 
                                  fill="none" 
                                  stroke="#e9ecef" 
                                  stroke-width="16" 
                                  stroke-linecap="round"/>
                            
                            <!-- Gradiente para ventas -->
                            <defs>
                                <linearGradient id="barometer-gradient-{{ loop.index }}" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#dc3545;stop-opacity:1" />
                                    <stop offset="20%" style="stop-color:#e8722b;stop-opacity:1" />
                                    <stop offset="21%" style="stop-color:#ffc107;stop-opacity:1" />
                                    <stop offset="60%" style="stop-color:#7cb342;stop-opacity:1" />
                                    <stop offset="61%" style="stop-color:#28a745;stop-opacity:1" />
                                    <stop offset="80%" style="stop-color:#28a745;stop-opacity:1" />
                                    <stop offset="81%" style="stop-color:#28a745;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#1e7e34;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            
                            <!-- Arco de progreso para ventas -->
                            <path d="M 20 150 A 140 140 0 0 1 300 150"
                                  fill="none"
                                  stroke="url(#barometer-gradient-{{ loop.index }})"
                                  stroke-width="16"
                                  stroke-linecap="round"
                                  stroke-dasharray="439.8"
                                  stroke-dashoffset="{{ 439.8 * (1 - [1.0, (canal.cumplimiento * 0.8 / 100)]|min) }}"
                                  style="transition: stroke-dashoffset 2s ease-in-out;
                                         filter: drop-shadow(0 0 8px rgba(212, 175, 55, 0.3));"/>
                            
                            <!-- Línea de meta para ventas -->
                            <g transform="translate(160,150)">
                                <g transform="rotate(144)">
                                    <line x1="0" y1="0" x2="-150" y2="0" 
                                          stroke="#2C2C2C" 
                                          stroke-width="2" 
                                          stroke-linecap="round"
                                          opacity="0.8"/>
                                    <circle cx="-150" cy="0" r="3" 
                                            fill="#2C2C2C" 
                                            opacity="0.8"/>
                                </g>
                            </g>
                            
                            <!-- Aguja para ventas -->
                            <g transform="translate(160,150)">
                                <g transform="rotate({{ [144, (canal.cumplimiento * 180 * 0.8 / 100)]|min }})"
                                   style="transition: transform 2s ease-in-out;">
                                    <line x1="0" y1="0" x2="-140" y2="0"
                                          stroke="rgba(0,0,0,0.2)"
                                          stroke-width="3"
                                          stroke-linecap="round"
                                          transform="translate(1,1)"/>
                                    <line x1="0" y1="0" x2="-140" y2="0"
                                          stroke="{% if canal.cumplimiento <= 25 %}#dc3545{% elif canal.cumplimiento <= 50 %}#e8722b{% elif canal.cumplimiento <= 75 %}#ffc107{% elif canal.cumplimiento <= 100 %}#28a745{% else %}#20c997{% endif %}"
                                          stroke-width="3"
                                          stroke-linecap="round"/>
                                </g>
                                <circle cx="0" cy="0" r="8"
                                        fill="{% if canal.cumplimiento <= 25 %}#dc3545{% elif canal.cumplimiento <= 40 %}#e8722b{% elif canal.cumplimiento <= 60 %}#ffc107{% elif canal.cumplimiento <= 80 %}#7cb342{% elif canal.cumplimiento <= 100 %}#28a745{% else %}#20c997{% endif %}"
                                        stroke="white"
                                        stroke-width="2"
                                        style="filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));"/>
                            </g>
                        </svg>
                        
                        <!-- Contenido central para ventas -->
                        <div class="barometer-content" style="position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); text-align: center;">
                            <div class="percentage-value" style="font-size: 1.4rem; font-weight: 800; color: #2C2C2C; line-height: 1;">
                                {{ "{:.0f}".format(canal.cumplimiento) }}%
                            </div>
                        </div>
                        
                        <!-- Indicador de meta para ventas -->
                        {% if canal.cumplimiento >= 100 %}
                        <div class="achievement-icon" style="position: absolute; top: -5px; right: 10px; 
                                                            background: linear-gradient(135deg, #28a745, #20c997); 
                                                            border-radius: 50%; width: 28px; height: 28px; 
                                                            display: flex; align-items: center; justify-content: center;
                                                            color: white; font-size: 0.8rem; 
                                                            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
                                                            animation: pulse 2s infinite;">
                            <i class="bi bi-check2"></i>
                        </div>
                        {% endif %}
                    </div>

                    <!-- ESPACIO PARA GRÁFICO DE METAS DE COSTO -->
                    <div class="cost-barometer-new mb-4" style="position: relative; width: 320px; height: 200px; margin: 0 auto; display: none;">
                        <!-- Espacio reservado para gráfico Plotly de metas de costo -->
                    </div>

                    <!-- ESPACIO PARA GRÁFICO DE METAS INGRESO REAL -->
                    <div class="ultima-milla-barometer-new mb-4" style="position: relative; width: 320px; height: 170px; margin: 0 auto; display: none;">
                        <!-- Espacio en blanco para el gráfico -->
                    </div>

                    
                    
                    <!-- MÉTRICAS MEJORADAS -->
                    <div class="metrics-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="metric-card" style="background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.05)); 
                                                        border-radius: 12px; padding: 1rem; text-align: center; 
                                                        border: 1px solid rgba(40, 167, 69, 0.1);">
                            <div class="metric-icon mb-2" style="color: #28a745; font-size: 1.2rem;">
                                <i class="bi bi-graph-up-arrow"></i>
                            </div>
                            <div class="metric-value" style="font-size: 1.1rem; font-weight: 700; color: #28a745; line-height: 1;">
                                ${{ "{:,.0f}".format(canal.ventas_reales) }}
                            </div>
                            <div class="metric-label" style="font-size: 0.8rem; color: #6c757d; margin-top: 2px;">
                                Ventas Reales
                            </div>
                        </div>
                        
                        <div class="metric-card" style="background: linear-gradient(135deg, rgba(23, 162, 184, 0.1), rgba(23, 162, 184, 0.05)); 
                                                        border-radius: 12px; padding: 1rem; text-align: center; 
                                                        border: 1px solid rgba(23, 162, 184, 0.1);">
                            <div class="metric-icon mb-2" style="color: #17a2b8; font-size: 1.2rem;">
                                <i class="bi bi-bullseye"></i>
                            </div>
                            <div class="metric-value" style="font-size: 1.1rem; font-weight: 700; color: #17a2b8; line-height: 1;">
                                ${{ "{:,.0f}".format(canal.meta_periodo) }}
                            </div>
                            <div class="metric-label" style="font-size: 0.8rem; color: #6c757d; margin-top: 2px;">
                                Meta Período
                            </div>
                        </div>
                    </div>
                    
                    <!-- DIFERENCIA Y STATUS -->
                    <div class="difference-status">
                        <div class="difference-amount mb-2" style="font-size: 1rem; font-weight: 600; 
                                                                  color: {% if canal.diferencia >= 0 %}#28a745{% else %}#dc3545{% endif %};">
                            {% if canal.diferencia >= 0 %}+{% endif %}${{ "{:,.0f}".format(canal.diferencia) }}
                            <small style="font-size: 0.8rem; color: #6c757d; font-weight: 400;">diferencia</small>
                        </div>
                        
                        {% if canal.cumplimiento >= 100 %}
                        <span class="badge px-3 py-2" style="background: linear-gradient(135deg, #28a745, #20c997); 
                                                            border: none; font-size: 0.85rem; border-radius: 20px;
                                                            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2);">
                            <i class="bi bi-trophy-fill me-1"></i>Meta Superada
                        </span>
                        {% elif canal.cumplimiento >= 50 %}
                        <span class="badge px-3 py-2" style="background: linear-gradient(135deg, #ffc107, #ffca2c); 
                                                            border: none; font-size: 0.85rem; border-radius: 20px;
                                                            color: #2C2C2C; box-shadow: 0 4px 12px rgba(255, 193, 7, 0.2);">
                            <i class="bi bi-clock-fill me-1"></i>En Progreso
                        </span>
                        {% else %}
                        <span class="badge px-3 py-2" style="background: linear-gradient(135deg, #dc3545, #e55353); 
                                                            border: none; font-size: 0.85rem; border-radius: 20px;
                                                            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.2);">
                            <i class="bi bi-exclamation-diamond-fill me-1"></i>Requiere Acción
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
</div>

<!-- MODAL: DETALLE DIARIO DE METAS -->
<div class="modal fade" id="modalDetalleDiario" tabindex="-1" aria-labelledby="modalDetalleDiarioLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable" style="max-width: 90%; width: 90%;">
        <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.15);">
            <!-- Header del Modal -->
            <div class="modal-header" style="background: linear-gradient(135deg, #D4AF37, #B8941F); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <h5 class="modal-title fw-bold" id="modalDetalleDiarioLabel">
                    <i class="bi bi-calendar-week me-2"></i>Detalle Diario: Metas vs Ventas Reales
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Body del Modal -->
            <div class="modal-body" style="padding: 2rem; background: #f8f9fa;">
                <!-- Filtros del Modal -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <label class="form-label fw-semibold"><i class="bi bi-cash-stack me-2" style="color: #D4AF37;"></i>Tipo de Meta:</label>
                        <div class="btn-group w-100" role="group" id="modal-tipo-meta-grupo">
                            <input type="radio" class="btn-check" name="modal-tipo-meta" id="modal-tipo-nominal" value="nominal" autocomplete="off" checked>
                            <label class="btn btn-outline-secondary" for="modal-tipo-nominal">Ingreso Nominal</label>

                            <input type="radio" class="btn-check" name="modal-tipo-meta" id="modal-tipo-real" value="real" autocomplete="off">
                            <label class="btn btn-outline-secondary" for="modal-tipo-real">Ingreso Real</label>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-semibold"><i class="bi bi-calendar-event me-2" style="color: #17a2b8;"></i>Fecha Inicio:</label>
                        <input type="date" class="form-control" id="modal-fecha-inicio" style="border-radius: 8px;">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-semibold"><i class="bi bi-calendar-check me-2" style="color: #28a745;"></i>Fecha Fin:</label>
                        <input type="date" class="form-control" id="modal-fecha-fin" style="border-radius: 8px;">
                    </div>
                    <div class="col-md-5 d-flex align-items-end justify-content-end gap-2">
                        <button type="button" class="btn btn-success" id="btn-modal-exportar-excel" style="background: linear-gradient(135deg, #28a745, #218838); border: none;">
                            <i class="bi bi-file-earmark-excel me-2"></i>Exportar a Excel
                        </button>
                        <button type="button" class="btn btn-primary" id="btn-modal-actualizar" style="background: linear-gradient(135deg, #17a2b8, #138496); border: none;">
                            <i class="bi bi-arrow-clockwise me-2"></i>Actualizar
                        </button>
                    </div>
                </div>

                <!-- Tarjetas de Totales -->
                <div class="row g-3 mb-4" id="modal-totales-container">
                    <!-- Meta Total -->
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm position-relative overflow-hidden"
                             style="border-radius: 16px; transition: all 0.3s ease; cursor: pointer; border: 1px solid rgba(23, 162, 184, 0.2) !important;"
                             onmouseenter="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 25px rgba(23,162,184,0.2)'"
                             onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                            <!-- Fondo degradado sutil -->
                            <div class="position-absolute top-0 start-0 w-100 h-100"
                                 style="background: linear-gradient(135deg, rgba(23, 162, 184, 0.05) 0%, transparent 100%); z-index: 0;"></div>

                            <div class="card-body text-center position-relative" style="z-index: 1; padding: 1.5rem;">
                                <!-- Ícono circular -->
                                <div class="d-flex justify-content-center mb-3">
                                    <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #17a2b8, #138496);
                                                border-radius: 50%; display: flex; align-items: center; justify-content: center;
                                                box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);">
                                        <i class="bi bi-bullseye text-white" style="font-size: 1.4rem;"></i>
                                    </div>
                                </div>

                                <small class="text-muted d-block mb-2" style="font-weight: 600; font-size: 0.85rem; letter-spacing: 0.5px;">Meta Total</small>
                                <h3 class="mb-0 fw-bold" style="color: #17a2b8; font-size: 1.6rem;" id="modal-total-meta">$0</h3>
                            </div>

                            <!-- Barra inferior decorativa -->
                            <div class="position-absolute bottom-0 start-0 w-100" style="height: 4px; background: linear-gradient(90deg, #17a2b8, #138496);"></div>
                        </div>
                    </div>

                    <!-- Ventas Totales -->
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm position-relative overflow-hidden"
                             style="border-radius: 16px; transition: all 0.3s ease; cursor: pointer; border: 1px solid rgba(40, 167, 69, 0.2) !important;"
                             onmouseenter="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 25px rgba(40,167,69,0.2)'"
                             onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                            <!-- Fondo degradado sutil -->
                            <div class="position-absolute top-0 start-0 w-100 h-100"
                                 style="background: linear-gradient(135deg, rgba(40, 167, 69, 0.05) 0%, transparent 100%); z-index: 0;"></div>

                            <div class="card-body text-center position-relative" style="z-index: 1; padding: 1.5rem;">
                                <!-- Ícono circular -->
                                <div class="d-flex justify-content-center mb-3">
                                    <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #28a745, #218838);
                                                border-radius: 50%; display: flex; align-items: center; justify-content: center;
                                                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);">
                                        <i class="bi bi-cash-stack text-white" style="font-size: 1.4rem;"></i>
                                    </div>
                                </div>

                                <small class="text-muted d-block mb-2" style="font-weight: 600; font-size: 0.85rem; letter-spacing: 0.5px;" id="modal-ventas-label">Ventas Totales</small>
                                <h3 class="mb-0 fw-bold" style="color: #28a745; font-size: 1.6rem;" id="modal-total-ventas">$0</h3>
                            </div>

                            <!-- Barra inferior decorativa -->
                            <div class="position-absolute bottom-0 start-0 w-100" style="height: 4px; background: linear-gradient(90deg, #28a745, #218838);"></div>
                        </div>
                    </div>

                    <!-- Variación -->
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm position-relative overflow-hidden"
                             style="border-radius: 16px; transition: all 0.3s ease; cursor: pointer; border: 1px solid rgba(108, 117, 125, 0.2) !important;"
                             onmouseenter="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 25px rgba(108,117,125,0.2)'"
                             onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                            <!-- Fondo degradado sutil -->
                            <div class="position-absolute top-0 start-0 w-100 h-100"
                                 style="background: linear-gradient(135deg, rgba(108, 117, 125, 0.05) 0%, transparent 100%); z-index: 0;"></div>

                            <div class="card-body text-center position-relative" style="z-index: 1; padding: 1.5rem;">
                                <!-- Ícono circular -->
                                <div class="d-flex justify-content-center mb-3">
                                    <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #6c757d, #5a6268);
                                                border-radius: 50%; display: flex; align-items: center; justify-content: center;
                                                box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);">
                                        <i class="bi bi-graph-up-arrow text-white" style="font-size: 1.4rem;"></i>
                                    </div>
                                </div>

                                <small class="text-muted d-block mb-2" style="font-weight: 600; font-size: 0.85rem; letter-spacing: 0.5px;">Variación</small>
                                <h3 class="mb-0 fw-bold" style="font-size: 1.6rem;" id="modal-total-variacion">$0</h3>
                            </div>

                            <!-- Barra inferior decorativa -->
                            <div class="position-absolute bottom-0 start-0 w-100" style="height: 4px; background: linear-gradient(90deg, #6c757d, #5a6268);"></div>
                        </div>
                    </div>

                    <!-- Cumplimiento -->
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm position-relative overflow-hidden"
                             style="border-radius: 16px; transition: all 0.3s ease; cursor: pointer; border: 1px solid rgba(212, 175, 55, 0.2) !important;"
                             onmouseenter="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 25px rgba(212,175,55,0.2)'"
                             onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                            <!-- Fondo degradado sutil -->
                            <div class="position-absolute top-0 start-0 w-100 h-100"
                                 style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.05) 0%, transparent 100%); z-index: 0;"></div>

                            <div class="card-body text-center position-relative" style="z-index: 1; padding: 1.5rem;">
                                <!-- Ícono circular -->
                                <div class="d-flex justify-content-center mb-3">
                                    <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #D4AF37, #B8941F);
                                                border-radius: 50%; display: flex; align-items: center; justify-content: center;
                                                box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);">
                                        <i class="bi bi-percent text-white" style="font-size: 1.4rem;"></i>
                                    </div>
                                </div>

                                <small class="text-muted d-block mb-2" style="font-weight: 600; font-size: 0.85rem; letter-spacing: 0.5px;">Cumplimiento</small>
                                <h3 class="mb-0 fw-bold" style="color: #D4AF37; font-size: 1.6rem;" id="modal-total-cumplimiento">0%</h3>
                            </div>

                            <!-- Barra inferior decorativa -->
                            <div class="position-absolute bottom-0 start-0 w-100" style="height: 4px; background: linear-gradient(90deg, #D4AF37, #B8941F);"></div>
                        </div>
                    </div>
                </div>

                <!-- Barómetros por Canal -->
                <div class="card border-0 shadow-sm mb-4" style="border-radius: 12px;">
                    <div class="card-body">
                        <h6 class="mb-4 fw-semibold"><i class="bi bi-speedometer2 me-2" style="color: #D4AF37;"></i>Cumplimiento por Canal</h6>

                        <!-- Grid de Barómetros -->
                        <div class="row g-3" id="modal-barometros-container">
                            <!-- Los barómetros se cargarán dinámicamente aquí -->
                        </div>
                    </div>
                </div>

            </div>

            <!-- Footer del Modal -->
            <div class="modal-footer" style="background: #f8f9fa; border-radius: 0 0 16px 16px;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: CUMPLIMIENTO HOY -->
<div class="modal fade" id="modalCumplimientoHoy" tabindex="-1" aria-labelledby="modalCumplimientoHoyLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-xl" style="max-width: 1600px;">
        <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.15);">
            <!-- Header del Modal -->
            <div class="modal-header" style="background: linear-gradient(135deg, #17a2b8, #138496); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <h5 class="modal-title fw-bold" id="modalCumplimientoHoyLabel">
                    <i class="bi bi-calendar-check me-2"></i>Cumplimiento del Día Actual
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Body del Modal -->
            <div class="modal-body" style="padding: 1.5rem 2rem; background: #f8f9fa;">
                <!-- Selector de Tipo de Meta y Fecha en una sola fila compacta -->
                <div class="row g-2 mb-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold mb-1" style="font-size: 0.85rem;"><i class="bi bi-cash-stack me-1" style="color: #17a2b8;"></i>Tipo de Meta:</label>
                        <div class="btn-group w-100" role="group" id="hoy-tipo-meta-grupo">
                            <input type="radio" class="btn-check" name="hoy-tipo-meta" id="hoy-tipo-nominal" value="nominal" autocomplete="off" checked>
                            <label class="btn btn-outline-secondary btn-sm" for="hoy-tipo-nominal" style="padding: 0.4rem 0.7rem; font-size: 0.85rem;">Ingreso Nominal</label>

                            <input type="radio" class="btn-check" name="hoy-tipo-meta" id="hoy-tipo-real" value="real" autocomplete="off">
                            <label class="btn btn-outline-secondary btn-sm" for="hoy-tipo-real" style="padding: 0.4rem 0.7rem; font-size: 0.85rem;">Ingreso Real</label>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <label class="form-label fw-semibold mb-1" style="font-size: 0.85rem;"><i class="bi bi-calendar-event me-1" style="color: #17a2b8;"></i>Fecha:</label>
                        <div class="alert alert-info mb-0" style="background: linear-gradient(135deg, rgba(23, 162, 184, 0.1), rgba(23, 162, 184, 0.05)); border: 1px solid rgba(23, 162, 184, 0.3); border-radius: 8px; padding: 0.45rem 0.75rem;">
                            <span id="hoy-fecha-texto" style="font-size: 0.9rem; font-weight: 600;"></span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-primary btn-sm w-100" id="btn-hoy-actualizar" style="background: linear-gradient(135deg, #17a2b8, #138496); border: none; padding: 0.5rem 0.9rem; font-size: 0.85rem;">
                            <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                        </button>
                    </div>
                </div>

                <!-- Barómetro Global del Día -->
                <div class="card border-0 shadow-sm mb-3" style="border-radius: 12px; overflow: hidden;">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(23, 162, 184, 0.1), rgba(23, 162, 184, 0.05)); border-bottom: 2px solid rgba(23, 162, 184, 0.2); padding: 0.6rem 0.9rem;">
                        <h6 class="mb-0 fw-bold" style="color: #17a2b8; font-size: 0.9rem;">
                            <i class="bi bi-speedometer2 me-1"></i>Cumplimiento Global del Día
                        </h6>
                    </div>
                    <div class="card-body text-center" style="padding: 0.8rem 0.7rem;">
                        <!-- Barómetro SVG Compacto -->
                        <div class="barometer-container-hoy mb-2" style="position: relative; width: 280px; height: 150px; margin: 0 auto;">
                            <svg id="hoy-barometro-svg" width="280" height="150" viewBox="0 0 280 150">
                                <!-- Fondo para el texto "META" -->
                                <rect x="237" y="28" width="35" height="18" rx="3" ry="3" fill="rgba(255, 255, 255, 0.9)" stroke="rgba(44, 44, 44, 0.2)" stroke-width="1"/>
                                <text x="254.5" y="40" font-family="Arial, sans-serif" font-size="10" font-weight="600" fill="#2C2C2C" text-anchor="middle" opacity="1">META</text>

                                <!-- Arco de fondo -->
                                <path d="M 20 128 A 120 120 0 0 1 260 128" fill="none" stroke="#e9ecef" stroke-width="15" stroke-linecap="round"/>

                                <!-- Gradiente para el arco de progreso -->
                                <defs>
                                    <linearGradient id="hoy-barometer-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                        <stop offset="0%" style="stop-color:#dc3545;stop-opacity:1" />
                                        <stop offset="20%" style="stop-color:#e8722b;stop-opacity:1" />
                                        <stop offset="21%" style="stop-color:#ffc107;stop-opacity:1" />
                                        <stop offset="60%" style="stop-color:#7cb342;stop-opacity:1" />
                                        <stop offset="61%" style="stop-color:#28a745;stop-opacity:1" />
                                        <stop offset="80%" style="stop-color:#28a745;stop-opacity:1" />
                                        <stop offset="81%" style="stop-color:#28a745;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#1e7e34;stop-opacity:1" />
                                    </linearGradient>
                                </defs>

                                <!-- Arco de progreso -->
                                <path id="hoy-arco-progreso" d="M 20 128 A 120 120 0 0 1 260 128" fill="none" stroke="url(#hoy-barometer-gradient)"
                                      stroke-width="15" stroke-linecap="round" stroke-dasharray="377"
                                      stroke-dashoffset="377"
                                      style="transition: stroke-dashoffset 2s ease-in-out; filter: drop-shadow(0 0 6px rgba(23, 162, 184, 0.4));"/>

                                <!-- Línea de meta -->
                                <g transform="translate(140,128)">
                                    <g transform="rotate(144)">
                                        <line x1="0" y1="0" x2="-128" y2="0" stroke="#2C2C2C" stroke-width="2" stroke-linecap="round" opacity="0.8"/>
                                        <circle cx="-128" cy="0" r="3" fill="#2C2C2C" opacity="0.8"/>
                                    </g>
                                </g>

                                <!-- Aguja -->
                                <g id="hoy-aguja-grupo" transform="translate(140,128)">
                                    <g id="hoy-aguja-rotacion" transform="rotate(0)" style="transition: transform 2s ease-in-out;">
                                        <line x1="0" y1="0" x2="-120" y2="0" stroke="rgba(0,0,0,0.2)" stroke-width="3.5" stroke-linecap="round" transform="translate(1,1)"/>
                                        <line id="hoy-aguja-linea" x1="0" y1="0" x2="-120" y2="0" stroke="#17a2b8" stroke-width="3.5" stroke-linecap="round"/>
                                    </g>
                                    <circle id="hoy-aguja-circulo" cx="0" cy="0" r="7" fill="#17a2b8" stroke="white" stroke-width="2.5" style="filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3));"/>
                                </g>
                            </svg>

                            <!-- Valor de porcentaje -->
                            <div class="barometer-content" style="position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%); text-align: center;">
                                <div id="hoy-cumplimiento-valor" class="percentage-value" style="font-size: 1.7rem; font-weight: 800; color: #2C2C2C; line-height: 1;">
                                    0%
                                </div>
                                <small class="text-muted" style="font-size: 0.75rem; font-weight: 600;">Cumplimiento</small>
                            </div>
                        </div>

                        <!-- Métricas del Día -->
                        <div class="row g-2 mt-1">
                            <div class="col-md-4">
                                <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, rgba(23, 162, 184, 0.1), rgba(23, 162, 184, 0.05)); border-radius: 10px;">
                                    <div class="card-body text-center" style="padding: 0.7rem 0.5rem;">
                                        <i class="bi bi-bullseye" style="font-size: 1.1rem; color: #17a2b8;"></i>
                                        <p class="mb-1 mt-1 text-muted" style="font-size: 0.72rem; font-weight: 600;">Meta del Día</p>
                                        <h5 class="mb-0 fw-bold" style="color: #17a2b8; font-size: 1.1rem;" id="hoy-meta-total">$0</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.05)); border-radius: 10px;">
                                    <div class="card-body text-center" style="padding: 0.7rem 0.5rem;">
                                        <i class="bi bi-cash-stack" style="font-size: 1.1rem; color: #28a745;"></i>
                                        <p class="mb-1 mt-1 text-muted" style="font-size: 0.72rem; font-weight: 600;" id="hoy-ventas-label">Ventas del Día</p>
                                        <h5 class="mb-0 fw-bold" style="color: #28a745; font-size: 1.1rem;" id="hoy-ventas-total">$0</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, rgba(108, 117, 125, 0.1), rgba(108, 117, 125, 0.05)); border-radius: 10px;">
                                    <div class="card-body text-center" style="padding: 0.7rem 0.5rem;">
                                        <i class="bi bi-graph-up-arrow" style="font-size: 1.1rem; color: #6c757d;"></i>
                                        <p class="mb-1 mt-1 text-muted" style="font-size: 0.72rem; font-weight: 600;">Variación</p>
                                        <h5 class="mb-0 fw-bold" style="font-size: 1.1rem;" id="hoy-variacion-total">$0</h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla Resumen por Canal -->
                <div class="card border-0 shadow-sm" style="border-radius: 16px;">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(23, 162, 184, 0.1), rgba(23, 162, 184, 0.05)); border-bottom: 2px solid rgba(23, 162, 184, 0.2); padding: 0.9rem 1rem;">
                        <h6 class="mb-0 fw-bold" style="color: #17a2b8; font-size: 1rem;">
                            <i class="bi bi-table me-2"></i>Resumen por Canal
                        </h6>
                    </div>
                    <div class="card-body" style="padding: 1.2rem;">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle" style="margin-bottom: 0; font-size: 0.88rem;">
                                <thead style="background: linear-gradient(135deg, rgba(23, 162, 184, 0.08), rgba(23, 162, 184, 0.04)); border-radius: 8px;">
                                    <tr>
                                        <th style="padding: 0.7rem 0.9rem; font-weight: 700; color: #2C2C2C; font-size: 0.9rem;">
                                            <i class="bi bi-broadcast me-2" style="color: #17a2b8;"></i>Canal
                                        </th>
                                        <th class="text-end" style="padding: 0.7rem 0.9rem; font-weight: 700; color: #2C2C2C; font-size: 0.9rem;">
                                            <i class="bi bi-bullseye me-2" style="color: #17a2b8;"></i>Meta Diaria
                                        </th>
                                        <th class="text-end" style="padding: 0.7rem 0.9rem; font-weight: 700; color: #2C2C2C; font-size: 0.9rem;">
                                            <i class="bi bi-cash-stack me-2" style="color: #28a745;"></i>Ventas Reales
                                        </th>
                                        <th class="text-end" style="padding: 0.7rem 0.9rem; font-weight: 700; color: #2C2C2C; font-size: 0.9rem;">
                                            <i class="bi bi-graph-up-arrow me-2" style="color: #6c757d;"></i>Variación
                                        </th>
                                        <th class="text-center" style="padding: 0.7rem 0.9rem; font-weight: 700; color: #2C2C2C; font-size: 0.9rem; min-width: 200px;">
                                            <i class="bi bi-percent me-2" style="color: #D4AF37;"></i>Cumplimiento
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="hoy-tabla-body">
                                    <!-- Las filas se cargarán dinámicamente aquí -->
                                    <tr>
                                        <td colspan="5" class="text-center py-5 text-muted">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Cargando...</span>
                                            </div>
                                            <p class="mt-3">Cargando datos...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer del Modal -->
            <div class="modal-footer" style="background: #f8f9fa; border-radius: 0 0 16px 16px;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Estilos personalizados para paleta Loomber */
    .form-control:focus, .form-select:focus {
        border-color: #D4AF37 !important;
        box-shadow: 0 0 0 0.2rem rgba(212, 175, 55, 0.25) !important;
    }
    
    .btn-warning:hover {
        background-color: #B8941F !important;
        border-color: #B8941F !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
    }
    
    /* Efectos suavizados para las cards */
    .card:hover {
        transform: translateY(-2px) scale(1.005);
        box-shadow: 0 6px 20px rgba(212, 175, 55, 0.08), 0 4px 12px rgba(0, 0, 0, 0.06);
        transition: all 0.3s ease;
    }
    
    /* Animación para círculos de progreso */
    .progress-ring circle {
        transition: stroke-dashoffset 2s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    /* Hover effects para métricas */
    .metric-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.06);
        transition: all 0.2s ease;
    }
    
    /* Personalizacion simple de progress circles */
    .progress-circle {
        transition: transform 0.2s ease;
    }
    
    .progress-circle:hover {
        transform: scale(1.05);
    }
    
    /* Hover effects para badges */
    .badge {
        transition: all 0.3s ease;
    }
    
    
    
    
    .badge:hover {
        transform: scale(1.05);
    }
    
    /* Estilos para filas principales de canal */
    .canal-table-row {
        position: relative;
    }
    
    
    /* Efectos de transición suave */
    .canal-table-row td {
        transition: all 0.3s ease;
    }
    
    /* Badges con mejores estilos */
    .badge {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        letter-spacing: 0.3px;
        transition: all 0.3s ease;
    }
    
    .badge:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    /* Optimización de tabla para evitar scroll horizontal */
    .table-responsive {
        overflow-x: visible !important;
    }
    
    .table th, .table td {
        white-space: nowrap;
        padding-left: 8px !important;
        padding-right: 8px !important;
    }
    
    .table th:first-child, .table td:first-child {
        min-width: 200px;
        max-width: 250px;
    }
    
    .table th:not(:first-child), .table td:not(:first-child) {
        min-width: 100px;
        max-width: 120px;
        text-align: center !important;
    }
    
    /* Ajustar tamaño de fuente para columnas compactas */
    .table td span.fw-bold {
        font-size: 0.9rem !important;
    }
    
    
    /* Mejoras para el indicador de estado */
    .canal-status-indicator {
        animation: statusPulse 2s infinite;
    }
    
    @keyframes statusPulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.7;
            transform: scale(1.1);
        }
    }
    
    /* Gradientes animados para las métricas */
    .metric-card {
        position: relative;
        overflow: hidden;
    }
    
    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s;
    }
    
    .metric-card:hover::before {
        left: 100%;
    }
    
    /* Animación de pulso para logros */
    @keyframes pulse {
        0% {
            transform: scale(1);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        50% {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(40, 167, 69, 0.4);
        }
        100% {
            transform: scale(1);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
    }
    
    /* Animación de entrada para valores */
    .percentage-value {
        animation: countUp 1.5s ease-out;
    }
    
    @keyframes countUp {
        from {
            transform: scale(0.8);
            opacity: 0;
        }
        to {
            transform: scale(1);
            opacity: 1;
        }
    }
    
    /* Efecto glassmorphism para las cards */
    .card {
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
</style>
</div>
<!-- FIN CONTENEDOR AJAX CUMPLIMIENTO METAS -->

<!-- Cargar Plotly para gráficos de Metas de Costo -->
<script src="https://cdn.plot.ly/plotly-3.0.1.min.js"></script>

<!-- OPTIMIZACIÓN: DATOS PRECALCULADOS DE LOS 3 TIPOS DE META -->
<script>
// ===========================================
// FUNCIONES DE ANIMACIÓN GLOBALES (DECLARADAS PRIMERO)
// ===========================================

// Funciones de animación para las métricas
function animateMetricCard(element) {
    element.style.transform = 'translateY(-8px) scale(1.02)';
    element.style.boxShadow = '0 8px 25px rgba(212, 175, 55, 0.15), 0 4px 12px rgba(0, 0, 0, 0.1)';
}

function resetMetricCard(element) {
    element.style.transform = 'translateY(0) scale(1)';
    element.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
}

// Funciones de animación para las tablas
function highlightTableRow(row) {
    row.style.background = 'linear-gradient(135deg, rgba(212, 175, 55, 0.08), rgba(212, 175, 55, 0.04))';
    row.style.transform = 'translateY(-2px)';
    row.style.boxShadow = '0 4px 12px rgba(212, 175, 55, 0.15)';
    
    // Destacar también la card correspondiente si existe
    const canalName = row.getAttribute('data-canal');
    const correspondingCard = document.querySelector(`.canal-card[data-canal="${canalName}"]`);
    if (correspondingCard) {
        correspondingCard.style.transform = 'translateY(-4px) scale(1.02)';
        correspondingCard.style.boxShadow = '0 8px 25px rgba(212, 175, 55, 0.2)';
    }
}

function resetTableRow(row) {
    row.style.background = '';
    row.style.transform = '';
    row.style.boxShadow = '';
    
    // Resetear también la card correspondiente
    const canalName = row.getAttribute('data-canal');
    const correspondingCard = document.querySelector(`.canal-card[data-canal="${canalName}"]`);
    if (correspondingCard) {
        correspondingCard.style.transform = '';
        correspondingCard.style.boxShadow = '';
    }
}

// OPTIMIZACIÓN: Almacenar todos los datos precalculados del servidor
window.preCalculatedData = {
    ventas: {
        cumplimiento_data: {{ cumplimiento_data_ventas | tojson }},
        resumen_general: {{ resumen_general_ventas | tojson }},
        html: {{ html_ventas | tojson }}
    },
    costo: {
        cumplimiento_data: {{ cumplimiento_data_costo | tojson }},
        resumen_general: {{ resumen_general_costo | tojson }},
        html: {{ html_costo | tojson }}
    },
    ingreso_real_nominal: {
        cumplimiento_data: {{ cumplimiento_data_ingreso_nominal | tojson }},
        resumen_general: {{ resumen_general_ingreso_nominal | tojson }},
        html: {{ html_ingreso_nominal | tojson }}
    },
    periodo_texto: {{ periodo_texto | tojson }}
};

console.log('🚀 OPTIMIZACIÓN: Datos precalculados cargados', window.preCalculatedData);

// OPTIMIZACIÓN: Función para cambio INSTANTÁNEO usando HTML precalculado
window.cambiarTipoMetaInstantaneo = function(tipoMeta) {
    console.log('⚡ CAMBIO INSTANTÁNEO:', tipoMeta);
    
    const data = window.preCalculatedData[tipoMeta];
    if (!data) {
        console.error('Tipo de meta no encontrado:', tipoMeta);
        return;
    }
    
    // Activar botón correspondiente inmediatamente
    window.activarBotonTipoMeta(tipoMeta);
    
    // Cambio INSTANTÁNEO usando HTML precalculado
    const container = document.getElementById('cumplimiento-section-content');
    container.innerHTML = data.html;
    
    // Ejecutar renderizado específico según el tipo
    setTimeout(() => {
        if (tipoMeta === 'costo') {
            console.log('🔍 DEBUG Plotly: Tipo meta:', tipoMeta);
            console.log('🔍 DEBUG Plotly: Total canales:', data.cumplimiento_data.length);
            
            // Debug específico de cada canal
            data.cumplimiento_data.forEach((canal, index) => {
                console.log(`Canal ${index}: ${canal.canal} - es_fila_principal: ${canal.es_fila_principal}, es_subfila: ${canal.es_subfila}, tiene_gauge: ${!!canal.gauge_config}`);
            });
            
            // Renderizar gauges de Plotly - SOLO FILAS PRINCIPALES (CANALES)
            const gaugeConfigs = data.cumplimiento_data.filter(canal => {
                const hasGauge = !!canal.gauge_config;
                const isPrincipal = canal.es_fila_principal == 1 || canal.es_fila_principal === true;
                const isNotSubfila = canal.es_subfila == 0 || canal.es_subfila === false;
                console.log(`Filtro - ${canal.canal}: gauge=${hasGauge}, principal=${isPrincipal}, notSub=${isNotSubfila}`);
                return hasGauge && isPrincipal && isNotSubfila;
            }).map(canal => canal.gauge_config);
            console.log('🔍 DEBUG Plotly: Configuraciones encontradas:', gaugeConfigs.length);
            console.log('🔍 DEBUG Plotly: renderPlotlyGaugesFromData disponible:', typeof window.renderPlotlyGaugesFromData === 'function');
            
            if (gaugeConfigs.length > 0 && typeof window.renderPlotlyGaugesFromData === 'function') {
                console.log('🎯 DEBUG Plotly: Llamando a renderPlotlyGaugesFromData');
                window.renderPlotlyGaugesFromData(gaugeConfigs);
            } else {
                console.warn('⚠️ DEBUG Plotly: No se puede renderizar -', 'Configs:', gaugeConfigs.length, 'Función:', typeof window.renderPlotlyGaugesFromData);
            }
        }
        
        // Refresh de AOS
        if (typeof AOS !== 'undefined') {
            AOS.refresh();
        }

        // ✅ FALLBACK: Asegurar que la tarjeta se actualice correctamente
        // (necesario cuando el HTML precalculado es viejo o no tiene las clases CSS correctas)
        setTimeout(() => {
            window.actualizarTarjetaPeriodoSiFaltaClases(tipoMeta, data.resumen_general);
        }, 100);
    }, 50);

    console.log('✅ CAMBIO COMPLETADO EN:', performance.now() - performance.now(), 'ms');
};

// ✅ FUNCIÓN FALLBACK: Solo actualiza si las clases CSS están presentes
window.actualizarTarjetaPeriodoSiFaltaClases = function(tipoMeta, resumenGeneral) {
    const icono = document.querySelector('.tarjeta-periodo-icono');
    const titulo = document.querySelector('.tarjeta-periodo-titulo');
    const contenido = document.querySelector('.tarjeta-periodo-contenido');

    // Si los elementos con las clases existen, ejecutar actualización
    if (icono && titulo && contenido) {
        console.log('✅ Elementos de tarjeta período encontrados, actualizando...');
        window.actualizarTarjetaPeriodo(tipoMeta, resumenGeneral);
    } else {
        console.warn('⚠️ No se encontraron elementos de tarjeta período con las clases CSS correctas. HTML precalculado podría estar desactualizado.');
    }
};

// ✅ NUEVA FUNCIÓN: Actualizar tarjeta dinámica de Período/Ventas/Ingreso Real
window.actualizarTarjetaPeriodo = function(tipoMeta, resumenGeneral) {
    console.log('🔄 Actualizando tarjeta período para tipo:', tipoMeta);

    // Buscar elementos de la tarjeta
    const icono = document.querySelector('.tarjeta-periodo-icono');
    const titulo = document.querySelector('.tarjeta-periodo-titulo');
    const contenido = document.querySelector('.tarjeta-periodo-contenido');

    if (!icono || !titulo || !contenido) {
        console.warn('⚠️ No se encontraron elementos de la tarjeta período');
        return;
    }

    // Actualizar según el tipo de meta
    if (tipoMeta === 'ventas') {
        // Cambiar a "Ventas del Período"
        icono.className = 'bi tarjeta-periodo-icono bi-currency-dollar text-white';
        titulo.textContent = 'Ventas del Período';

        const valor = resumenGeneral.ventas_periodo_total || 0;
        contenido.style.color = '#D4AF37';
        contenido.style.fontSize = '1.1rem';
        contenido.style.fontWeight = '700';
        contenido.innerHTML = `<span class="animated-number" data-value="${valor}" data-type="currency">$${Number(valor).toLocaleString('es-MX', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</span>`;

    } else if (tipoMeta === 'ingreso_real_nominal') {
        // Cambiar a "Ingreso Real del Período"
        icono.className = 'bi tarjeta-periodo-icono bi-cash-coin text-white';
        titulo.textContent = 'Ingreso Real del Período';

        const valor = resumenGeneral.ingreso_real_periodo_total || 0;
        contenido.style.color = '#D4AF37';
        contenido.style.fontSize = '1.1rem';
        contenido.style.fontWeight = '700';
        contenido.innerHTML = `<span class="animated-number" data-value="${valor}" data-type="currency">$${Number(valor).toLocaleString('es-MX', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</span>`;

    } else {
        // Cambiar a "Período" (para costo)
        icono.className = 'bi tarjeta-periodo-icono bi-calendar-check text-white';
        titulo.textContent = 'Período';

        const periodoTexto = window.preCalculatedData.periodo_texto || '';
        contenido.style.color = '#6c757d';
        contenido.style.fontSize = '0.9rem';
        contenido.style.fontWeight = '400';
        contenido.textContent = periodoTexto;
    }

    console.log('✅ Tarjeta período actualizada correctamente');
};

// OPTIMIZACIÓN: AJAX que usa datos precalculados en lugar de recalcular
window.ejecutarCambioMetaOptimizado = function(tipoMeta) {
    const container = document.getElementById('cumplimiento-section-content');
    
    // Efecto visual mínimo (más rápido)
    container.style.opacity = '0.7';
    container.style.transition = 'opacity 0.2s ease';
    
    // Crear FormData con el tipo de meta
    const formData = new FormData();
    formData.append('tipo_meta', tipoMeta);
    formData.append('preset_main', document.querySelector('[name="preset_main"]')?.value || 'mes_actual');
    formData.append('usar_precalculados', 'true'); // Bandera para usar datos precalculados
    
    let ajaxUrl = '{{ url_for("cumplimiento_metas.cumplimiento_metas_ajax") }}';
    const mesGlobal = document.getElementById('mes_filtro').value;
    if (mesGlobal) {
        ajaxUrl += '?mes_filtro=' + encodeURIComponent(mesGlobal);
    }
    
    fetch(ajaxUrl, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            container.innerHTML = data.html;
            
            // Renderizar gauges si los hay - SOLO CANALES PRINCIPALES
            if (data.gauge_configs && data.gauge_configs.length > 0 && typeof window.renderPlotlyGaugesFromData === 'function') {
                // Filtrar solo configuraciones que no sean de sub-filas
                const filteredConfigs = data.gauge_configs.filter(config => 
                    config && !config.canal.includes('├──') && !config.canal.includes('└──')
                );
                setTimeout(() => window.renderPlotlyGaugesFromData(filteredConfigs), 100);
            }
            
            // Efectos finales
            setTimeout(() => {
                container.style.opacity = '1';
                if (typeof AOS !== 'undefined') {
                    AOS.refresh();
                }
            }, 50);
        } else {
            throw new Error(data.error || 'Error desconocido');
        }
    })
    .catch(error => {
        console.error('Error en AJAX optimizado:', error);
        container.style.opacity = '1';
    });
};

// Función auxiliar para activar el botón correcto
window.activarBotonTipoMeta = function(tipoMeta) {
    // Desactivar todos los botones
    document.querySelectorAll('[data-tipo-meta]').forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = '';
        btn.style.color = '';
        btn.style.boxShadow = '';
    });
    
    // Activar botón específico
    const botonActivo = document.querySelector(`[data-tipo-meta="${tipoMeta}"]`);
    if (botonActivo) {
        botonActivo.classList.add('active');
        botonActivo.style.background = 'linear-gradient(135deg, rgba(212, 175, 55, 0.9), rgba(212, 175, 55, 0.7))';
        botonActivo.style.color = 'white';
        botonActivo.style.boxShadow = '0 4px 15px rgba(212, 175, 55, 0.3)';
    }
};

// OPTIMIZACIÓN: Función para actualizar texto del período en las 4 tarjetas principales
window.actualizarTextoPeriodo = function(nuevoTexto) {
    console.log('📅 Actualizando texto del período:', nuevoTexto);
    
    // Buscar el elemento que contiene el texto del período en las tarjetas principales
    const periodoElements = document.querySelectorAll('#metricsContainer p');
    periodoElements.forEach(element => {
        // Si el elemento contiene texto similar a un período, actualizarlo
        if (element.textContent && (
            element.textContent.includes('01 de') || 
            element.textContent.includes('al') ||
            element.textContent.includes('Hoy') ||
            element.textContent.includes('Últimos') ||
            element.textContent.includes(' - ')
        )) {
            element.textContent = nuevoTexto;
            console.log('✅ Texto del período actualizado:', nuevoTexto);
        }
    });
};
</script>

<!-- FUNCIÓN GLOBAL PARA PLOTLY GAUGES (COSTO E INGRESO REAL) -->
<script>
// Función global para renderizar gauges de Plotly después de AJAX
window.renderPlotlyGaugesFromData = function(gaugeConfigsData) {
    console.log('🚀 DEBUG: renderPlotlyGaugesFromData LLAMADA con', gaugeConfigsData.length, 'configuraciones');
    console.log('🔍 DEBUG: Verificando Plotly...');
    console.log('🔍 DEBUG: typeof Plotly:', typeof Plotly);
    console.log('🔍 DEBUG: Plotly object:', Plotly);
    
    if (typeof Plotly === 'undefined') {
        console.warn('❌ DEBUG: Plotly no está disponible para renderizar gauges');
        return false;
    }
    
    console.log('✅ DEBUG: Plotly está disponible, continuando...');
    
    if (!gaugeConfigsData || gaugeConfigsData.length === 0) {
        console.log('No hay configuraciones de gauges para renderizar');
        return true; // No error, simplemente no hay datos
    }
    
    console.log(`🎯 Renderizando ${gaugeConfigsData.length} gauges de Plotly...`);
    
    // Ya no necesitamos filtro adicional aquí porque el filtro principal ya funciona correctamente
    
    let successCount = 0;
    const totalGauges = gaugeConfigsData.length;
    
    // Renderizar cada gauge con delay escalonado
    gaugeConfigsData.forEach((config, index) => {
        setTimeout(() => {
            try {
                const divElement = document.getElementById(config.div_id);
                if (!divElement) {
                    console.warn(`Elemento div no encontrado: ${config.div_id}`);
                    return;
                }
                
                // Limpiar contenedor existente
                try {
                    Plotly.purge(config.div_id);
                } catch (e) {
                    // Normal en primera carga
                }
                
                // Crear nuevo gráfico Plotly
                Plotly.newPlot(config.div_id, config.data, config.layout, config.config)
                    .then(() => {
                        successCount++;
                        console.log(`✅ Gauge ${config.div_id} renderizado exitosamente`);
                        
                        // Si es el último gauge, reportar éxito total
                        if (successCount === totalGauges) {
                            console.log(`🎉 Todos los ${totalGauges} gauges renderizados exitosamente`);
                        }
                    })
                    .catch((error) => {
                        console.error(`❌ Error renderizando gauge ${config.div_id}:`, error);
                        divElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f8d7da; border-radius: 8px; color: #721c24; padding: 20px;"><div class="text-center"><i class="bi bi-x-circle" style="font-size: 2rem;"></i><br>Error al cargar gráfico</div></div>';
                    });
                    
            } catch (error) {
                console.error(`❌ Error procesando gauge ${index}:`, error);
            }
        }, index * 250); // Delay escalonado de 250ms
    });
    
    return true;
};

</script>

<script>
    let mainPicker;
    
    // Inicializar cuando la página esté lista
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar Flatpickr
        mainPicker = flatpickr("#main_range", {
            mode: "range",
            dateFormat: "Y-m-d",
            altInput: true,
            altFormat: "d/m/Y",
            allowSingleDateSelection: true,
        });

        // Función para mostrar/ocultar campos
        function toggleMainRange() {
            const show = document.getElementById("preset_main").value === "personalizado";
            const element = document.getElementById("main_range_group");
            
            if (show) {
                element.style.display = "block";
                element.style.opacity = "0";
                element.style.transform = "translateY(-10px)";
                
                setTimeout(() => {
                    element.style.transition = "all 0.3s ease";
                    element.style.opacity = "1";
                    element.style.transform = "translateY(0)";
                }, 10);
            } else {
                element.style.transition = "all 0.3s ease";
                element.style.opacity = "0";
                element.style.transform = "translateY(-10px)";
                
                setTimeout(() => {
                    element.style.display = "none";
                    document.getElementById("main_range").value = "";
                }, 300);
            }
        }

        // Event listener
        document.getElementById("preset_main").addEventListener("change", toggleMainRange);
        
        // Inicializar estado
        toggleMainRange();

        {% if cumplimiento_data %}
        // Animar círculos de progreso con delay escalonado
        setTimeout(() => {
            animateProgressCircles();
        }, 300);
        
        // Animar barras de progreso de las tarjetas principales
        setTimeout(() => {
            animateMetricProgressBars();
        }, 500);
        {% endif %}
        
        // Agregar efectos de hover mejorados
        enhanceHoverEffects();
        
        // Inicializar filtro de canales
        initializeCanalesFilter();
        
        // Inicializar tooltips de Bootstrap
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        {% if cumplimiento_data %}
        // Inicializar ambos mini gráficos (costo y ventas)
        let chartInitAttempts = 0;
        const maxAttempts = 10;
        
        function tryInitCharts() {
            chartInitAttempts++;
            console.log(`🚀 Intento ${chartInitAttempts} de inicializar gráficos...`);
            
            const costoSuccess = initializeCostoEvolucionChart();
            const ventasSuccess = initializeVentasEvolucionChart();
            const ingresoSuccess = initializeIngresoEvolucionChart();
            
            if ((!costoSuccess || !ventasSuccess || !ingresoSuccess) && chartInitAttempts < maxAttempts) {
                setTimeout(tryInitCharts, 500);
            } else if (costoSuccess && ventasSuccess && ingresoSuccess) {
                console.log('✅ Todos los gráficos inicializados exitosamente');
            } else {
                console.log('❌ No se pudieron inicializar todos los gráficos después de varios intentos');
            }
        }
        
        // Iniciar después de un pequeño delay
        setTimeout(tryInitCharts, 1000);
        
        // Reinicializar cuando el formulario AJAX se procese
        // Nota: Como es AJAX, no hay evento 'submit', se maneja en el success del fetch
        const metasFormAjax = document.getElementById('metas-form-ajax');
        if (metasFormAjax) {
            // Escuchar cuando se complete el AJAX exitosamente (se maneja en el fetch success)
            // Este listener se mantiene para compatibilidad pero el reinicio real ocurre en el AJAX success
        }
        {% endif %}
    });

    // Función para animar círculos de progreso
    function animateProgressCircles() {
        const progressRings = document.querySelectorAll('.progress-ring circle:last-child');
        
        progressRings.forEach((circle, index) => {
            setTimeout(() => {
                // Agregar clase para activar animación
                circle.style.transition = 'stroke-dashoffset 2s cubic-bezier(0.25, 0.8, 0.25, 1)';
                
                // Animar contador de porcentaje
                const percentageElement = circle.closest('.modern-progress-container').querySelector('.percentage-value');
                if (percentageElement) {
                    animateCounter(percentageElement);
                }
            }, index * 200); // Delay escalonado de 200ms entre cada círculo
        });
    }
    
    // Función para animar contadores
    function animateCounter(element) {
        const finalValue = parseInt(element.textContent);
        const duration = 1500;
        const startTime = Date.now();
        
        function updateCounter() {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            // Easing function (ease-out)
            const easedProgress = 1 - Math.pow(1 - progress, 3);
            const currentValue = Math.round(finalValue * easedProgress);
            
            element.textContent = currentValue + '%';
            
            if (progress < 1) {
                requestAnimationFrame(updateCounter);
            }
        }
        
        updateCounter();
    }
    
    // Función para mejorar efectos hover
    function enhanceHoverEffects() {
        // Efectos simples para las cards (sin paralax)
        document.querySelectorAll('.card').forEach(card => {
            // Solo hover básico sin animaciones complejas
        });
        
        // Efecto de ondas en métricas
        document.querySelectorAll('.metric-card').forEach(metric => {
            metric.addEventListener('click', function(e) {
                const ripple = document.createElement('span');
                const rect = metric.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = e.clientX - rect.left - size / 2;
                const y = e.clientY - rect.top - size / 2;
                
                ripple.style.cssText = `
                    position: absolute;
                    border-radius: 50%;
                    background: rgba(255, 255, 255, 0.6);
                    transform: scale(0);
                    animation: ripple 0.6s linear;
                    width: ${size}px;
                    height: ${size}px;
                    left: ${x}px;
                    top: ${y}px;
                    pointer-events: none;
                `;
                
                metric.appendChild(ripple);
                
                setTimeout(() => {
                    ripple.remove();
                }, 600);
            });
        });
    }
    
    // ===== FUNCIONES PARA ANIMACIONES DE TARJETAS ===== 
    // (Funciones ya declaradas globalmente al inicio del script)
    
    function animateMetricProgressBars() {
        const progressBars = document.querySelectorAll('#metricsContainer .position-absolute.bottom-0 .h-100');
        
        progressBars.forEach((bar) => {
            // Activar la animación cambiando el width
            bar.style.width = '100%';
        });
    }
    
    // ===== FUNCIONES PARA FILTRO DE CANALES =====
    
    function initializeCanalesFilter() {
        // Actualizar texto inicial
        updateCanalesSelection();
        
        // Evitar que el dropdown se cierre al hacer clic en checkboxes
        document.querySelectorAll('.dropdown-item-check').forEach(item => {
            item.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        });
    }
    
    function toggleAllCanales(checkbox) {
        const canalCheckboxes = document.querySelectorAll('.canal-checkbox');
        
        canalCheckboxes.forEach(cb => {
            cb.checked = checkbox.checked;
        });
        
        updateCanalesSelection();
    }
    
    function updateCanalesSelection() {
        const todoscheckbox = document.getElementById('canal_todos');
        const canalCheckboxes = document.querySelectorAll('.canal-checkbox');
        const selectedText = document.getElementById('canales-selected-text');
        const countBadge = document.getElementById('canales-count');
        
        // Contar seleccionados
        const selected = Array.from(canalCheckboxes).filter(cb => cb.checked);
        const total = canalCheckboxes.length;
        
        // Actualizar estado de "Todos"
        if (selected.length === total) {
            todoscheckbox.checked = true;
            todoscheckbox.indeterminate = false;
        } else if (selected.length === 0) {
            todoscheckbox.checked = false;
            todoscheckbox.indeterminate = false;
        } else {
            todoscheckbox.checked = false;
            todoscheckbox.indeterminate = true;
        }
        
        // Actualizar texto del botón
        if (selected.length === total || selected.length === 0) {
            selectedText.textContent = 'Todos los canales';
            countBadge.style.display = 'none';
        } else if (selected.length === 1) {
            selectedText.textContent = selected[0].value;
            countBadge.style.display = 'none';
        } else {
            selectedText.textContent = `${selected.length} canales seleccionados`;
            countBadge.textContent = selected.length;
            countBadge.style.display = 'inline-block';
        }
        
        // Filtrar cards de canales en tiempo real
        filterCanalesCards();
    }
    
    function filterCanalesCards() {
        const canalCheckboxes = document.querySelectorAll('.canal-checkbox');
        const selected = Array.from(canalCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
        
        // Si no hay ninguno seleccionado, mostrar todos
        const showAll = selected.length === 0;
        
        // Buscar todas las cards de canales usando la nueva estructura
        const canalCards = document.querySelectorAll('.canal-card');
        
        canalCards.forEach(card => {
            const canalName = card.getAttribute('data-canal');
            
            // Determinar si debe mostrarse
            const shouldShow = showAll || selected.includes(canalName);
            
            if (shouldShow) {
                card.style.display = 'block';
                card.style.opacity = '1';
                card.style.transform = 'scale(1)';
                card.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
            } else {
                card.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                card.style.opacity = '0';
                card.style.transform = 'scale(0.92)';
                
                setTimeout(() => {
                    if (card.style.opacity === '0') {
                        card.style.display = 'none';
                    }
                }, 400);
            }
        });
        
        // Contar cards visibles para debugging
        const visibleCards = Array.from(canalCards).filter(card => card.style.display !== 'none').length;
        console.log(`Filtro aplicado: ${selected.length ? selected.join(', ') : 'Todos'} - ${visibleCards} cards visibles`);
    }
    
    // ===== FUNCIONES PARA TABLA DE RESUMEN =====
    // (Funciones ya declaradas globalmente al inicio del script)

    // Agregar animación de ripple
    const style = document.createElement('style');
    style.textContent = `
        @keyframes ripple {
            to {
                transform: scale(2);
                opacity: 0;
            }
        }
        
        /* Estilos para el dropdown de canales */
        .dropdown-item-check:hover {
            background-color: rgba(212, 175, 55, 0.1);
        }
        
        .canal-checkbox:checked + .form-check-label {
            color: #D4AF37;
            font-weight: 600;
        }
        
        .dropdown-toggle:focus {
            border-color: #D4AF37 !important;
            box-shadow: 0 0 0 0.2rem rgba(212, 175, 55, 0.25) !important;
        }
        
        /* Grid responsivo para canales */
        #canales-container {
            display: grid !important;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }
        
        @media (max-width: 1200px) {
            #canales-container {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 1rem;
            }
        }
        
        @media (max-width: 768px) {
            #canales-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }
        
        /* Animación suave para las cards filtradas */
        .canal-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .canal-card.filtered-out {
            opacity: 0;
            transform: scale(0.92);
        }
        
        /* Reglas responsivas para el contenedor de rentabilidad */
        @media (max-width: 1400px) {
            /* En pantallas medianas: mantener horizontal pero ajustar espaciado */
            #rentabilidadContainer .col-md-2 {
                flex: 0 0 calc(16.666667% - 0.5rem);
                max-width: calc(16.666667% - 0.5rem);
            }
        }
        
        @media (max-width: 1200px) {
            /* En tablets: 3 tarjetas por fila, divisor oculto */
            #rentabilidadContainer .col-md-2 {
                flex: 0 0 calc(33.333333% - 1rem);
                max-width: calc(33.333333% - 1rem);
            }
            
            /* Ocultar divisor en tablets */
            #rentabilidadContainer .col-auto {
                display: none !important;
            }
        }
        
        @media (max-width: 992px) {
            /* En móviles: 2 tarjetas por fila */
            #rentabilidadContainer .col-md-2 {
                flex: 0 0 calc(50% - 0.5rem);
                max-width: calc(50% - 0.5rem);
            }
        }
        
        @media (max-width: 768px) {
            /* En móviles pequeños: 1 tarjeta por fila */
            #rentabilidadContainer .col-md-2 {
                flex: 0 0 100%;
                max-width: 100%;
            }
            
            #rentabilidadContainer .row {
                gap: 1rem !important;
            }
        }
        
        /* Estilos específicos para la línea divisoria personalizada */
        .vr-custom {
            transition: all 0.3s ease;
        }
        
        .vr-custom:hover {
            background: linear-gradient(180deg, 
                       rgba(212, 175, 55, 0.2) 0%, 
                       rgba(212, 175, 55, 0.6) 50%, 
                       rgba(212, 175, 55, 0.2) 100%) !important;
            box-shadow: 0 0 12px rgba(212, 175, 55, 0.4) !important;
        }
    `;
    document.head.appendChild(style);
    
    // ====== FUNCIONALIDAD AJAX PARA FILTRO DE CUMPLIMIENTO DE METAS ======
    
    // OPTIMIZACIÓN: Botón principal - MISMA FUNCIONALIDAD que botón pequeño (recalcula desde servidor)
    document.getElementById('btn-analizar-rapido').addEventListener('click', function() {
        const button = this;
        const originalText = button.innerHTML;
        const formData = new FormData(document.getElementById('metas-form-ajax'));
        
        // Detectar qué tipo de meta está actualmente seleccionado
        let tipoMetaActivo = 'ventas';
        const botonActivo = document.querySelector('.tipo-meta-btn.active');
        if (botonActivo) {
            tipoMetaActivo = botonActivo.getAttribute('data-tipo-meta') || botonActivo.getAttribute('data-tipo');
            console.log(`🔄 BOTÓN PRINCIPAL: Recalculando los 3 tipos de meta, mostrando: ${tipoMetaActivo}`);
        }
        
        // MISMA FUNCIONALIDAD: Agregar tipo de meta activo para mantener la vista actual
        formData.append('tipo_meta_activo', tipoMetaActivo);
        
        // Obtener mes global
        const mesGlobal = new URLSearchParams(window.location.search).get('mes_filtro') || '';
        
        // EFECTOS VISUALES ÚNICOS DEL BOTÓN PRINCIPAL (más prominentes)
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Analizando...';
        button.disabled = true;
        button.style.opacity = '0.8';
        
        // Efectos visuales más prominentes para el botón principal
        const container = document.getElementById('cumplimiento-section-content');
        container.style.filter = 'blur(2px)';
        container.style.opacity = '0.4';
        container.style.pointerEvents = 'none';
        container.style.transition = 'filter 0.3s ease, opacity 0.3s ease';
        
        // MISMA FUNCIONALIDAD: Usar endpoint que recalcula los 3 tipos de meta
        let ajaxUrl = '{{ url_for("cumplimiento_metas.cumplimiento_metas_actualizar") }}';
        if (mesGlobal) {
            ajaxUrl += '?mes_filtro=' + encodeURIComponent(mesGlobal);
        }
        
        fetch(ajaxUrl, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('🔄 BOTÓN PRINCIPAL: Datos recalculados recibidos', data);
                
                // MISMA FUNCIONALIDAD: Actualizar datos precalculados con los nuevos datos
                if (data.datos_actualizados) {
                    window.preCalculatedData = data.datos_actualizados;
                    console.log('✅ BOTÓN PRINCIPAL: Datos precalculados actualizados', window.preCalculatedData);
                    
                    // Actualizar el texto del período en las tarjetas principales
                    window.actualizarTextoPeriodo(data.datos_actualizados.periodo_texto);
                }
                
                // Actualizar la vista actual con los nuevos datos
                container.innerHTML = data.html;
                
                // Renderizar gauges si los hay - SOLO CANALES PRINCIPALES
                if (data.gauge_configs && data.gauge_configs.length > 0 && typeof window.renderPlotlyGaugesFromData === 'function') {
                    // Filtrar solo configuraciones que no sean de sub-filas
                    const filteredConfigs = data.gauge_configs.filter(config => 
                        config && !config.canal.includes('├──') && !config.canal.includes('└──')
                    );
                    setTimeout(() => window.renderPlotlyGaugesFromData(filteredConfigs), 200);
                }
                
                // Efectos finales
                setTimeout(() => {
                    container.style.filter = 'none';
                    container.style.opacity = '1';
                    container.style.pointerEvents = 'auto';
                    if (typeof AOS !== 'undefined') {
                        AOS.refresh();
                    }
                }, 200);
                
                console.log('✅ BOTÓN PRINCIPAL: Actualización completa exitosa');
            } else {
                throw new Error(data.error || 'Error desconocido');
            }
        })
        .catch(error => {
            console.error('Error en botón principal:', error);
            container.style.filter = 'none';
            container.style.opacity = '1';
            container.style.pointerEvents = 'auto';
            alert('Error al actualizar los datos: ' + error.message);
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
            button.style.opacity = '1';
        });
    });
    
    // OPTIMIZACIÓN: Botón pequeño - Actualizar datos completos desde servidor (RECALCULA LOS 3 TIPOS)
    document.getElementById('btn-actualizar-datos').addEventListener('click', function() {
        const button = this;
        const originalIcon = button.innerHTML;
        const formData = new FormData(document.getElementById('metas-form-ajax'));
        
        // Detectar qué tipo de meta está actualmente seleccionado
        let tipoMetaActivo = 'ventas';
        const botonActivo = document.querySelector('.tipo-meta-btn.active');
        if (botonActivo) {
            tipoMetaActivo = botonActivo.getAttribute('data-tipo-meta') || botonActivo.getAttribute('data-tipo');
            console.log(`🔄 ACTUALIZACIÓN COMPLETA: Recalculando los 3 tipos de meta, mostrando: ${tipoMetaActivo}`);
        }
        
        formData.append('tipo_meta_activo', tipoMetaActivo);
        
        // Obtener mes global
        const mesGlobal = new URLSearchParams(window.location.search).get('mes_filtro') || '';
        
        // Efectos visuales para botón pequeño
        button.innerHTML = '<i class="bi bi-arrow-clockwise" style="animation: spin 1s linear infinite;"></i>';
        button.disabled = true;
        button.style.opacity = '0.6';
        
        // Agregar estilos de animación si no existen
        if (!document.getElementById('spin-animation')) {
            const spinStyle = document.createElement('style');
            spinStyle.id = 'spin-animation';
            spinStyle.textContent = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
            document.head.appendChild(spinStyle);
        }
        
        // Efecto visual en contenedor
        const container = document.getElementById('cumplimiento-section-content');
        container.style.filter = 'blur(1px)';
        container.style.opacity = '0.6';
        container.style.pointerEvents = 'none';
        container.style.transition = 'filter 0.3s ease, opacity 0.3s ease';
        
        // OPTIMIZACIÓN: Usar endpoint que recalcula los 3 tipos de meta
        let ajaxUrl = '{{ url_for("cumplimiento_metas.cumplimiento_metas_actualizar") }}';
        if (mesGlobal) {
            ajaxUrl += '?mes_filtro=' + encodeURIComponent(mesGlobal);
        }
        
        fetch(ajaxUrl, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                console.log('🔄 ACTUALIZACIÓN: Datos recalculados recibidos', data);
                
                // OPTIMIZACIÓN: Actualizar datos precalculados con los nuevos datos
                if (data.datos_actualizados) {
                    window.preCalculatedData = data.datos_actualizados;
                    console.log('✅ ACTUALIZACIÓN: Datos precalculados actualizados', window.preCalculatedData);
                    
                    // Actualizar el texto del período en las tarjetas principales
                    window.actualizarTextoPeriodo(data.datos_actualizados.periodo_texto);
                }
                
                // Actualizar la vista actual con los nuevos datos
                container.innerHTML = data.html;
                
                // Reinicializar animaciones AOS
                if (typeof AOS !== 'undefined') {
                    AOS.refresh();
                }
                
                // Reinicializar gráficos después de un pequeño delay
                setTimeout(() => {
                    // Reinicializar SOLO los mini-gráficos de evolución (costo, ventas, ingreso)
                    if (typeof tryInitCharts === 'function') {
                        chartInitAttempts = 0;
                        tryInitCharts();
                    }
                    
                    // Reinicializar animaciones de progreso
                    if (typeof animateProgressCircles === 'function') {
                        animateProgressCircles();
                    }
                    
                    // NUEVO: Renderizar gauges de Plotly desde contexto global (SOLO para costo)
                    if (data.gauge_configs && data.gauge_configs.length > 0) {
                        // Filtrar solo configuraciones que no sean de sub-filas
                        const filteredConfigs = data.gauge_configs.filter(config => 
                            config && !config.canal.includes('├──') && !config.canal.includes('└──')
                        );
                        console.log(`🎯 Encontradas ${filteredConfigs.length} configuraciones de gauges válidas (filtradas de ${data.gauge_configs.length} totales) para tipo: ${data.tipo_meta}`);
                        setTimeout(() => {
                            if (typeof window.renderPlotlyGaugesFromData === 'function') {
                                window.renderPlotlyGaugesFromData(filteredConfigs);
                            } else {
                                console.error('❌ Función renderPlotlyGaugesFromData no disponible');
                            }
                        }, 200); // Delay adicional para asegurar que DOM esté listo
                    }
                    
                    // CRÍTICO: Reactive el botón correcto después del AJAX
                    if (data.tipo_meta) {
                        console.log(`🔄 Reactivando botón tipo: ${data.tipo_meta}`);
                        setTimeout(() => {
                            // Desactivar todos los botones
                            document.querySelectorAll('.tipo-meta-btn').forEach(btn => {
                                btn.classList.remove('active');
                                btn.style.background = '#f8f9fa';
                                btn.style.color = '#2C2C2C';
                                btn.style.boxShadow = 'none';
                            });
                            
                            // Activar el botón correcto
                            const botonCorrect = document.querySelector(`.tipo-meta-btn[data-tipo="${data.tipo_meta}"]`);
                            if (botonCorrect) {
                                botonCorrect.classList.add('active');
                                botonCorrect.style.background = 'linear-gradient(135deg, rgba(212, 175, 55, 0.9), rgba(212, 175, 55, 0.7))';
                                botonCorrect.style.color = 'white';
                                botonCorrect.style.boxShadow = '0 4px 15px rgba(212, 175, 55, 0.3)';
                                console.log(`✅ Botón ${data.tipo_meta} reactivado exitosamente`);
                            }
                            
                            // Mostrar/ocultar barómetros según el tipo activo
                            mostrarBarometrosSegunTipo(data.tipo_meta);
                        }, 300); // Dar tiempo para que el DOM se actualice
                    }
                    
                    // IMPORTANTE: Para metas de ventas, los SVGs ya vienen renderizados correctamente
                    // desde el template parcial con animaciones CSS, no necesitan JavaScript adicional
                }, 500);
                
            } else {
                throw new Error(data.error || 'Error desconocido');
            }
        })
        .catch(error => {
            console.error('Error en AJAX:', error);
            
            // Mostrar mensaje de error amigable
            container.innerHTML = `
                <div class="alert alert-danger" role="alert" data-aos="shake">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Error al actualizar los datos: ${error.message}
                </div>
            `;
        })
        .finally(() => {
            // Restaurar contenedor (quitar difuminado)
            container.style.filter = 'none';
            container.style.opacity = '1';
            container.style.pointerEvents = 'auto';
            
            // Restaurar botón pequeño con icono original
            button.innerHTML = originalIcon;
            button.disabled = false;
            button.style.opacity = '1';
        });
    });

    // ====== FUNCIÓN REUTILIZABLE PARA MOSTRAR BARÓMETROS ======
    function mostrarBarometrosSegunTipo(tipoMeta) {
        console.log(`🔄 Alternando barómetros para tipo: ${tipoMeta}`);
        
        // Primero ocultar todos
        document.querySelectorAll('.sales-barometer').forEach(el => {
            el.style.display = 'none';
        });
        document.querySelectorAll('.cost-barometer-new').forEach(el => {
            el.style.display = 'none';
        });
        document.querySelectorAll('.ultima-milla-barometer-new').forEach(el => {
            el.style.display = 'none';
        });
        
        // Mostrar según la pestaña seleccionada
        if (tipoMeta === 'costo') {
            document.querySelectorAll('.cost-barometer-new').forEach(el => {
                el.style.display = 'block';
            });
            console.log('👁️ Mostrando barómetros de costo');
        } else if (tipoMeta === 'ingreso_real_nominal') {
            document.querySelectorAll('.ultima-milla-barometer-new').forEach(el => {
                el.style.display = 'block';
            });
            console.log('👁️ Mostrando barómetros de ingreso real nominal');
        } else { // ventas
            document.querySelectorAll('.sales-barometer').forEach(el => {
                el.style.display = 'block';
            });
            console.log('👁️ Mostrando barómetros de ventas');
        }
    }

    // MANEJO DE BOTONES TIPO DE META
    document.querySelectorAll('.tipo-meta-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Remover clase active de todos los botones
            document.querySelectorAll('.tipo-meta-btn').forEach(b => {
                b.classList.remove('active');
                b.style.background = '#f8f9fa';
                b.style.color = '#2C2C2C';
            });
            
            // Activar botón clickeado
            this.classList.add('active');
            this.style.background = 'linear-gradient(135deg, #D4AF37, #B8941F)';
            this.style.color = 'white';
            
            // Obtener tipo de meta seleccionado
            const tipoMeta = this.getAttribute('data-tipo');
            
            // Usar función reutilizable para mostrar barómetros
            mostrarBarometrosSegunTipo(tipoMeta);
            
            // Trigger del análisis con el nuevo tipo usando función optimizada
            if (typeof window.cambiarTipoMetaInstantaneo === 'function') {
                window.cambiarTipoMetaInstantaneo(tipoMeta);
            } else {
                console.error('❌ Función cambiarTipoMetaInstantaneo no disponible');
            }
        });
    });

    function triggerAnalisisConTipo(tipoMeta) {
        // Obtener formulario y datos actuales
        const form = document.getElementById('metas-form-ajax');
        const formData = new FormData(form);
        
        // Agregar tipo de meta a los datos
        formData.append('tipo_meta', tipoMeta);
        
        // Reutilizar la lógica del análisis AJAX existente
        const button = document.getElementById('btn-analizar-ajax');
        if (!button) {
            console.error('❌ Botón btn-analizar-ajax no encontrado');
            return;
        }
        
        const originalText = button.innerHTML;
        
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Analizando...';
        button.disabled = true;
        button.style.opacity = '0.8';
        
        const container = document.getElementById('cumplimiento-section-content');
        if (!container) {
            console.error('❌ Contenedor cumplimiento-section-content no encontrado');
            return;
        }
        
        container.style.filter = 'blur(2px)';
        container.style.opacity = '0.4';
        container.style.pointerEvents = 'none';
        container.style.transition = 'filter 0.3s ease, opacity 0.3s ease';
        
        let ajaxUrl = '{{ url_for("cumplimiento_metas.cumplimiento_metas_ajax") }}';
        const mesGlobalElement = document.getElementById('mes_filtro');
        if (mesGlobalElement && mesGlobalElement.value) {
            ajaxUrl += '?mes_filtro=' + encodeURIComponent(mesGlobalElement.value);
        }
        
        fetch(ajaxUrl, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Guardar respuesta AJAX globalmente para future reference
                window.lastAjaxResponse = data;
                
                container.innerHTML = data.html;
                
                // EJECUTAR SCRIPTS MANUALMENTE después de cargar contenido AJAX
                // NOTA: Para gauges de Plotly (costo) usamos función global
                // Solo ejecutamos otros scripts que NO sean de renderizado de gauges
                const scripts = container.querySelectorAll('script');
                scripts.forEach((script, index) => {
                    try {
                        const scriptContent = script.innerHTML;
                        // NO ejecutar scripts que contengan renderAllGauges (ya se maneja globalmente)
                        if (!scriptContent.includes('renderAllGauges') && !scriptContent.includes('gaugeConfigs')) {
                            eval(scriptContent);
                        } else {
                            console.log(`⏭️ Saltando script ${index + 1} (renderización de gauges manejada globalmente)`);
                        }
                    } catch (error) {
                        console.error(`Error ejecutando script ${index + 1}:`, error);
                    }
                });
                
                setTimeout(() => {
                    container.style.filter = 'none';
                    container.style.opacity = '1';
                    container.style.pointerEvents = 'auto';
                    
                    if (typeof AOS !== 'undefined') {
                        AOS.refresh();
                    }
                    
                    if (typeof animateProgressCircles === 'function') {
                        animateProgressCircles();
                    }
                    
                    // TAMBIÉN reactivar botón correcto en este AJAX
                    if (data.tipo_meta) {
                        setTimeout(() => {
                            // Desactivar todos los botones
                            document.querySelectorAll('.tipo-meta-btn').forEach(btn => {
                                btn.classList.remove('active');
                                btn.style.background = '#f8f9fa';
                                btn.style.color = '#2C2C2C';
                                btn.style.boxShadow = 'none';
                            });
                            
                            // Activar el botón correcto
                            const botonCorrect = document.querySelector(`.tipo-meta-btn[data-tipo="${data.tipo_meta}"]`);
                            if (botonCorrect) {
                                botonCorrect.classList.add('active');
                                botonCorrect.style.background = 'linear-gradient(135deg, rgba(212, 175, 55, 0.9), rgba(212, 175, 55, 0.7))';
                                botonCorrect.style.color = 'white';
                                botonCorrect.style.boxShadow = '0 4px 15px rgba(212, 175, 55, 0.3)';
                            }
                            
                            // Mostrar barómetros correctos
                            mostrarBarometrosSegunTipo(data.tipo_meta);
                            
                            // Renderizar gauges si los hay - SOLO CANALES PRINCIPALES
                            if (data.gauge_configs && data.gauge_configs.length > 0 && typeof window.renderPlotlyGaugesFromData === 'function') {
                                // Filtrar solo configuraciones que no sean de sub-filas
                                const filteredConfigs = data.gauge_configs.filter(config => 
                                    config && !config.canal.includes('├──') && !config.canal.includes('└──')
                                );
                                setTimeout(() => window.renderPlotlyGaugesFromData(filteredConfigs), 300);
                            }
                        }, 200);
                    }
                }, 500);
                
            } else {
                throw new Error(data.error || 'Error desconocido');
            }
        })
        .catch(error => {
            console.error('Error en AJAX:', error);
            container.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Error al actualizar los datos: ${error.message}
                </div>`;
        })
        .finally(() => {
            setTimeout(() => {
                container.style.filter = 'none';
                container.style.opacity = '1';
                container.style.pointerEvents = 'auto';
                
                // Reinicializar gráficos después de cualquier operación AJAX
                if (typeof tryInitCharts === 'function') {
                    chartInitAttempts = 0;
                    tryInitCharts();
                }
                
                // NUEVO: Para botones tipo meta, también renderizar gauges si hay configuraciones - SOLO CANALES PRINCIPALES
                if (window.lastAjaxResponse && window.lastAjaxResponse.gauge_configs && window.lastAjaxResponse.gauge_configs.length > 0) {
                    setTimeout(() => {
                        if (typeof window.renderPlotlyGaugesFromData === 'function') {
                            // Filtrar solo configuraciones que no sean de sub-filas
                            const filteredConfigs = window.lastAjaxResponse.gauge_configs.filter(config => 
                                config && !config.canal.includes('├──') && !config.canal.includes('└──')
                            );
                            window.renderPlotlyGaugesFromData(filteredConfigs);
                        }
                    }, 400);
                }
            }, 300);
            
            button.innerHTML = originalText;
            button.disabled = false;
            button.style.opacity = '1';
        });
    }

    // ================================
    // FUNCIONALIDAD DEL MODAL DE DETALLE DIARIO
    // ================================

    // Variable global para almacenar el gráfico
    let modalGraficoChart = null;

    // Función para obtener el tipo de meta actual
    function obtenerTipoMetaActual() {
        const botonActivo = document.querySelector('.tipo-meta-btn.active');
        return botonActivo ? botonActivo.getAttribute('data-tipo') : 'ventas';
    }

    // Función para cargar datos del modal
    function cargarDatosModal(canalFiltro = 'TODOS') {
        const mesSeleccionado = document.getElementById('mes_filtro').value;

        // Obtener el tipo de meta del modal (nominal/real)
        const tipoMetaModal = document.querySelector('input[name="modal-tipo-meta"]:checked');
        const tipoMeta = tipoMetaModal ? tipoMetaModal.value : 'nominal';

        // Obtener fechas seleccionadas
        const fechaInicio = document.getElementById('modal-fecha-inicio').value;
        const fechaFin = document.getElementById('modal-fecha-fin').value;

        // Actualizar el label según el tipo de meta
        const ventasLabel = document.getElementById('modal-ventas-label');
        if (ventasLabel) {
            ventasLabel.textContent = tipoMeta === 'real' ? 'Ingreso Totales' : 'Ventas Totales';
        }

        console.log(`Cargando modal - Mes: ${mesSeleccionado}, Canal: ${canalFiltro}, Tipo: ${tipoMeta}, Fechas: ${fechaInicio} a ${fechaFin}`);

        // Preparar datos para enviar
        const formData = new FormData();
        formData.append('mes_filtro', mesSeleccionado);
        formData.append('canal_filtro', canalFiltro);
        formData.append('tipo_meta', tipoMeta);
        formData.append('fecha_inicio', fechaInicio);
        formData.append('fecha_fin', fechaFin);

        // Llamar al endpoint
        fetch('/cumplimiento-metas-detalle-diario', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            console.log('🔍 Respuesta completa del servidor:', data);

            if (data.success) {
                // COMENTADO: Filtro de canales eliminado del modal
                // if (canalFiltro === 'TODOS') {
                //     actualizarFiltroCanales(data.canales_disponibles);
                // }

                // Actualizar totales
                actualizarTotalesModal(data.totales);

                // COMENTADO: Tabla grande eliminada - ahora cada barómetro tiene su propia mini-tabla
                // actualizarTablaModal(data.datos_tabla, tipoMeta);

                // Actualizar barómetros (usar datos_por_canal si está disponible, si no usar datos_grafico)
                const datosParaBarometros = data.datos_por_canal && data.datos_por_canal.length > 0
                    ? data.datos_por_canal
                    : data.datos_grafico;

                console.log('📊 Datos para barómetros:', datosParaBarometros);
                console.log('📊 Detalle por canal:', data.detalle_por_canal);
                actualizarGraficoModal(datosParaBarometros, tipoMeta, canalFiltro, data.detalle_por_canal);
            } else {
                mostrarErrorModal(data.error || 'Error cargando datos');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarErrorModal('Error de conexión al servidor');
        });
    }

    // Función para actualizar filtro de canales
    function actualizarFiltroCanales(canales) {
        const select = document.getElementById('modal-canal-filtro');
        const valorActual = select.value;

        // Mantener la opción TODOS
        select.innerHTML = '<option value="TODOS">Todos los canales (Acumulado)</option>';

        // Agregar canales disponibles
        canales.forEach(canal => {
            const option = document.createElement('option');
            option.value = canal;
            option.textContent = canal;
            select.appendChild(option);
        });

        // Restaurar valor si existe
        if (valorActual && Array.from(select.options).some(opt => opt.value === valorActual)) {
            select.value = valorActual;
        }
    }

    // Función para actualizar totales del modal
    function actualizarTotalesModal(totales) {
        document.getElementById('modal-total-meta').textContent =
            '$' + Math.round(totales.meta).toLocaleString('es-MX');

        document.getElementById('modal-total-ventas').textContent =
            '$' + Math.round(totales.ventas).toLocaleString('es-MX');

        const variacionElement = document.getElementById('modal-total-variacion');
        variacionElement.textContent =
            (totales.variacion >= 0 ? '+' : '') + '$' + Math.round(totales.variacion).toLocaleString('es-MX');
        variacionElement.style.color = totales.variacion >= 0 ? '#28a745' : '#dc3545';

        const cumplimientoElement = document.getElementById('modal-total-cumplimiento');
        cumplimientoElement.textContent = totales.cumplimiento.toFixed(1) + '%';
        cumplimientoElement.style.color =
            totales.cumplimiento >= 100 ? '#28a745' :
            totales.cumplimiento >= 50 ? '#ffc107' : '#dc3545';
    }

    // Función para actualizar tabla del modal
    function actualizarTablaModal(datos, tipoMeta) {
        const tbody = document.getElementById('modal-tabla-body');

        if (!datos || datos.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-4 text-muted">
                        <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                        <p class="mt-2">No hay datos disponibles</p>
                    </td>
                </tr>
            `;
            return;
        }

        // Generar filas de la tabla
        tbody.innerHTML = datos.map(row => {
            const cumplimientoClass =
                row.Cumplimiento >= 100 ? 'text-success' :
                row.Cumplimiento >= 50 ? 'text-warning' : 'text-danger';

            return `
                <tr>
                    <td>${formatearFecha(row.Fecha)}</td>
                    <td><span class="badge bg-secondary">${row.Canal}</span></td>
                    <td class="text-end">$${Math.round(row.Meta_Diaria).toLocaleString('es-MX')}</td>
                    <td class="text-end fw-semibold">$${Math.round(row.Ventas_Reales).toLocaleString('es-MX')}</td>
                    <td style="padding: 8px 12px;">
                        ${crearMiniBarometro(row.Cumplimiento)}
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Función para actualizar barómetros del modal por canal
    function actualizarGraficoModal(datos, tipoMeta, canalFiltro, detallePorCanal = {}) {
        const container = document.getElementById('modal-barometros-container');

        if (!datos || datos.length === 0) {
            container.innerHTML = '<p class="text-center text-muted py-5">No hay datos para mostrar</p>';
            return;
        }

        console.log('📊 Datos recibidos:', datos);
        console.log('📊 Tipo de datos:', typeof datos[0]);
        console.log('📊 Detalle por canal recibido:', detallePorCanal);

        // Si los datos ya vienen agrupados por canal (desde datos_por_canal)
        if (datos[0] && datos[0].Canal) {
            console.log('✅ Usando datos_por_canal (ya agrupados)');

            // Transformar directamente
            const datosTransformados = datos
                .map(row => ({
                    canal: row.Canal,
                    ventasReales: row.Ventas_Acumuladas || 0,
                    metaPeriodo: row.Meta_Acumulada || 0,
                    cumplimiento: row.Cumplimiento || 0,
                    diferencia: (row.Ventas_Acumuladas || 0) - (row.Meta_Acumulada || 0),
                    ultimaFecha: row.Fecha
                }))
                .sort((a, b) => b.ventasReales - a.ventasReales); // Ordenar por ventas reales (mayor a menor)

            // NUEVO: Agrupar canales por filas de 4
            const columnasGrid = 4;
            const filas = [];
            for (let i = 0; i < datosTransformados.length; i += columnasGrid) {
                filas.push(datosTransformados.slice(i, i + columnasGrid));
            }

            console.log(`📊 Generando ${filas.length} filas con ${datosTransformados.length} canales`);

            // Generar HTML por filas (gráficos + tabla unificada)
            const filasHTML = filas.map((canalesFila, filaIndex) => {
                return generarFilaConTablaUnificada(canalesFila, detallePorCanal, filaIndex);
            }).join('');

            container.innerHTML = filasHTML;
            console.log(`✅ Se generaron ${filas.length} filas con tablas unificadas`);

        } else {
            // Datos vienen de datos_grafico (sin Canal), necesitamos agrupar
            console.log('⚠️  Usando datos_grafico (necesitan agrupación)');

            const datosAgrupados = {};

            datos.forEach(row => {
                const canal = row.Canal || 'General';

                if (!datosAgrupados[canal]) {
                    datosAgrupados[canal] = {
                        canal: canal,
                        ventasReales: 0,
                        metaPeriodo: 0,
                        cumplimiento: 0,
                        ultimaFecha: null
                    };
                }

                datosAgrupados[canal].ventasReales = row.Ventas_Acumuladas || row.Ventas_Reales || 0;
                datosAgrupados[canal].metaPeriodo = row.Meta_Acumulada || row.Meta_Diaria || 0;
                datosAgrupados[canal].ultimaFecha = row.Fecha;
            });

            // Calcular cumplimiento y diferencia
            Object.keys(datosAgrupados).forEach(canalKey => {
                const data = datosAgrupados[canalKey];
                data.cumplimiento = data.metaPeriodo > 0 ? (data.ventasReales / data.metaPeriodo * 100) : 0;
                data.diferencia = data.ventasReales - data.metaPeriodo;
            });

            // Filtrar AliExpress y ordenar por ventas reales
            const canalesFiltrados = Object.values(datosAgrupados)
                .sort((a, b) => b.ventasReales - a.ventasReales); // Ordenar por ventas reales (mayor a menor)

            const barometrosHTML = canalesFiltrados
                .map((canal, index) => {
                    return generarBarometroHTML(canal, index);
                }).join('');

            container.innerHTML = barometrosHTML;
            console.log(`✅ Se generaron ${canalesFiltrados.length} barómetros`);

            // NUEVO: Llenar las tablas de detalle para cada canal
            canalesFiltrados.forEach((canal, index) => {
                llenarTablaDetalle(canal.canal, detallePorCanal[canal.canal] || [], index);
            });
        }
    }

    // NUEVA FUNCIÓN: Llenar tabla de detalle diario para un canal
    function llenarTablaDetalle(nombreCanal, datos, index = 0, columnasGrid = 4) {
        const tbodyId = `detalle-${nombreCanal.replace(/\s+/g, '-')}`;
        const tbody = document.getElementById(tbodyId);

        if (!tbody) {
            console.warn(`⚠️  No se encontró tbody con id: ${tbodyId}`);
            return;
        }

        // Calcular si es la primera columna de su fila
        const esPrimeraColumnaFila = (index % columnasGrid) === 0;

        // Definir colores degradados por canal
        const coloresPorCanal = {
            'Mercado Libre': 'rgba(255, 235, 59, 0.08)',
            'CrediTienda': 'rgba(33, 150, 243, 0.08)',
            'Walmart': 'rgba(76, 175, 80, 0.08)',
            'Shein': 'rgba(255, 152, 0, 0.08)',
            'Yuhu': 'rgba(233, 30, 99, 0.08)',
            'Liverpool': 'rgba(156, 39, 176, 0.08)',
            'AliExpress': 'rgba(244, 67, 54, 0.08)',
            'Coppel': 'rgba(0, 150, 136, 0.08)'
        };
        const colorFondoCanal = coloresPorCanal[nombreCanal] || 'rgba(158, 158, 158, 0.08)';

        if (!datos || datos.length === 0) {
            const colspan = esPrimeraColumnaFila ? 4 : 3;
            tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center text-muted" style="padding: 0.6rem; font-size: 0.8rem;">Sin datos</td></tr>`;
            return;
        }

        tbody.innerHTML = datos.map(dia => {
            // Detectar si es un día futuro (fecha mayor a hoy)
            const fechaDia = new Date(dia.Fecha + 'T00:00:00');
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            const esDiaFuturo = fechaDia > hoy;

            // Si es día futuro y no hay ventas, mostrar en gris
            let cumplimientoColor;
            if (esDiaFuturo && dia.Ventas_Reales === 0) {
                cumplimientoColor = '#6c757d'; // Gris para días futuros
            } else {
                cumplimientoColor = dia.Cumplimiento >= 100 ? '#28a745' :
                                   dia.Cumplimiento >= 50 ? '#ffc107' : '#dc3545';
            }

            return `
                <tr style="font-size: 0.8rem; background: ${colorFondoCanal};">
                    ${esPrimeraColumnaFila ? `<td style="padding: 0.4rem 0.6rem; width: 15%;">${formatearFecha(dia.Fecha)}</td>` : ''}
                    <td class="text-end" style="padding: 0.4rem 0.6rem; width: ${esPrimeraColumnaFila ? '30%' : '35%'};">$${Math.round(dia.Meta_Diaria).toLocaleString('es-MX', {maximumFractionDigits: 0})}</td>
                    <td class="text-end" style="padding: 0.4rem 0.6rem; width: ${esPrimeraColumnaFila ? '30%' : '35%'};">$${Math.round(dia.Ventas_Reales).toLocaleString('es-MX', {maximumFractionDigits: 0})}</td>
                    <td class="text-end fw-bold" style="padding: 0.4rem 0.6rem; width: ${esPrimeraColumnaFila ? '25%' : '30%'}; color: ${cumplimientoColor};">${Math.round(dia.Cumplimiento)}%</td>
                </tr>
            `;
        }).join('');

        console.log(`✅ Tabla llenada para canal: ${nombreCanal} (${datos.length} filas)`);
    }

    // NUEVA FUNCIÓN: Generar solo el gráfico (sin tabla individual)
    function generarSoloGrafico(canal, indexEnFila) {
        const statusColor = canal.cumplimiento >= 100 ? '#28a745' :
                           canal.cumplimiento >= 50 ? '#ffc107' : '#dc3545';

        const rotation = Math.min(144, (canal.cumplimiento * 180 * 0.8 / 100));

        const agujaColor = canal.cumplimiento <= 25 ? '#dc3545' :
                          canal.cumplimiento <= 50 ? '#e8722b' :
                          canal.cumplimiento <= 75 ? '#ffc107' :
                          canal.cumplimiento <= 100 ? '#28a745' : '#20c997';

        // Definir colores degradados por canal
        const coloresPorCanal = {
            'Mercado Libre': 'linear-gradient(135deg, rgba(255, 235, 59, 0.12), rgba(255, 235, 59, 0.05))',
            'CrediTienda': 'linear-gradient(135deg, rgba(33, 150, 243, 0.12), rgba(33, 150, 243, 0.05))',
            'Walmart': 'linear-gradient(135deg, rgba(76, 175, 80, 0.12), rgba(76, 175, 80, 0.05))',
            'Shein': 'linear-gradient(135deg, rgba(255, 152, 0, 0.12), rgba(255, 152, 0, 0.05))',
            'Yuhu': 'linear-gradient(135deg, rgba(233, 30, 99, 0.12), rgba(233, 30, 99, 0.05))',
            'Liverpool': 'linear-gradient(135deg, rgba(156, 39, 176, 0.12), rgba(156, 39, 176, 0.05))',
            'AliExpress': 'linear-gradient(135deg, rgba(244, 67, 54, 0.12), rgba(244, 67, 54, 0.05))',
            'Coppel': 'linear-gradient(135deg, rgba(0, 150, 136, 0.12), rgba(0, 150, 136, 0.05))'
        };
        const degradadoCanal = coloresPorCanal[canal.canal] || 'linear-gradient(135deg, rgba(158, 158, 158, 0.12), rgba(158, 158, 158, 0.05))';

        return `
            <div class="canal-grafico-solo" data-canal="${canal.canal}">
                <div class="card h-100 shadow-sm" style="border: none; border-radius: 0; background: linear-gradient(145deg, #ffffff, #f8f9fa);">
                    <div class="card-header border-0 pb-1" style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.08), rgba(212, 175, 55, 0.04)); padding: 0.75rem 1rem;">
                        <div class="d-flex align-items-center justify-content-between">
                            <h6 class="mb-0 fw-bold" style="color: #2C2C2C; font-size: 0.9rem;">
                                <i class="bi bi-broadcast me-1" style="color: #D4AF37; font-size: 0.8rem;"></i>${canal.canal}
                            </h6>
                            <div style="width: 10px; height: 10px; border-radius: 50%; background: ${statusColor}; box-shadow: 0 0 6px ${statusColor}40;"></div>
                        </div>
                    </div>
                    <div class="card-body text-center" style="padding: 1rem 0.5rem;">
                        <!-- BARÓMETRO -->
                        <div class="barometer-container mb-3" style="position: relative; width: 260px; height: 145px; margin: 0 auto;">
                            <svg width="260" height="145" viewBox="0 0 260 145">
                                <rect x="222" y="28" width="28" height="15" rx="3" ry="3" fill="rgba(255, 255, 255, 0.9)" stroke="rgba(44, 44, 44, 0.2)" stroke-width="1"/>
                                <text x="236" y="38" font-family="Arial, sans-serif" font-size="8" font-weight="600" fill="${canal.cumplimiento > 100 ? '#1e7e34' : '#2C2C2C'}" text-anchor="middle" opacity="1">META</text>
                                <path d="M 20 125 A 110 110 0 0 1 240 125" fill="none" stroke="#e9ecef" stroke-width="14" stroke-linecap="round"/>
                                <defs>
                                    <linearGradient id="barometer-gradient-${indexEnFila}" x1="0%" y1="0%" x2="100%" y2="0%">
                                        <stop offset="0%" style="stop-color:#dc3545;stop-opacity:1" />
                                        <stop offset="20%" style="stop-color:#e8722b;stop-opacity:1" />
                                        <stop offset="21%" style="stop-color:#ffc107;stop-opacity:1" />
                                        <stop offset="60%" style="stop-color:#7cb342;stop-opacity:1" />
                                        <stop offset="61%" style="stop-color:#28a745;stop-opacity:1" />
                                        <stop offset="80%" style="stop-color:#28a745;stop-opacity:1" />
                                        <stop offset="81%" style="stop-color:#28a745;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#1e7e34;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <path d="M 20 125 A 110 110 0 0 1 240 125" fill="none" stroke="url(#barometer-gradient-${indexEnFila})"
                                      stroke-width="14" stroke-linecap="round" stroke-dasharray="346"
                                      stroke-dashoffset="${346 * (1 - Math.min(1.0, (canal.cumplimiento * 0.8 / 100)))}"
                                      style="transition: stroke-dashoffset 2s ease-in-out; filter: drop-shadow(0 0 6px rgba(212, 175, 55, 0.3));"/>
                                <g transform="translate(130,125)">
                                    <g transform="rotate(144)">
                                        <line x1="0" y1="0" x2="-117" y2="0" stroke="#2C2C2C" stroke-width="1.8" stroke-linecap="round" opacity="0.8"/>
                                        <circle cx="-117" cy="0" r="2.8" fill="#2C2C2C" opacity="0.8"/>
                                    </g>
                                </g>
                                <g transform="translate(130,125)">
                                    <g transform="rotate(${rotation})" style="transition: transform 2s ease-in-out;">
                                        <line x1="0" y1="0" x2="-110" y2="0" stroke="rgba(0,0,0,0.2)" stroke-width="2.8" stroke-linecap="round" transform="translate(1,1)"/>
                                        <line x1="0" y1="0" x2="-110" y2="0" stroke="${agujaColor}" stroke-width="2.8" stroke-linecap="round"/>
                                    </g>
                                    <circle cx="0" cy="0" r="7" fill="${agujaColor}" stroke="white" stroke-width="2" style="filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));"/>
                                </g>
                            </svg>
                            <div class="barometer-content" style="position: absolute; bottom: 0px; left: 50%; transform: translateX(-50%); text-align: center;">
                                <div class="percentage-value" style="font-size: 1.3rem; font-weight: 800; color: #2C2C2C; line-height: 1;">
                                    ${Math.round(canal.cumplimiento)}%
                                </div>
                            </div>
                            ${canal.cumplimiento >= 100 ? `
                                <div class="achievement-icon" style="position: absolute; top: -5px; right: 8px; background: linear-gradient(135deg, #28a745, #20c997); border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3); animation: pulse 2s infinite;">
                                    <i class="bi bi-check2"></i>
                                </div>
                            ` : ''}
                        </div>
                        <!-- MÉTRICAS -->
                        <div class="metrics-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.6rem;">
                            <div class="metric-card" style="background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.05)); border-radius: 10px; padding: 0.75rem; text-align: center; border: 1px solid rgba(40, 167, 69, 0.1);">
                                <div class="metric-icon mb-1" style="color: #28a745; font-size: 1rem;">
                                    <i class="bi bi-graph-up-arrow"></i>
                                </div>
                                <div class="metric-value" style="font-size: 0.9rem; font-weight: 700; color: #28a745; line-height: 1;">
                                    $${Math.round(canal.ventasReales).toLocaleString('es-MX')}
                                </div>
                                <div class="metric-label" style="font-size: 0.7rem; color: #6c757d; margin-top: 3px;">
                                    Ventas Reales
                                </div>
                            </div>
                            <div class="metric-card" style="background: linear-gradient(135deg, rgba(23, 162, 184, 0.1), rgba(23, 162, 184, 0.05)); border-radius: 10px; padding: 0.75rem; text-align: center; border: 1px solid rgba(23, 162, 184, 0.1);">
                                <div class="metric-icon mb-1" style="color: #17a2b8; font-size: 1rem;">
                                    <i class="bi bi-bullseye"></i>
                                </div>
                                <div class="metric-value" style="font-size: 0.9rem; font-weight: 700; color: #17a2b8; line-height: 1;">
                                    $${Math.round(canal.metaPeriodo).toLocaleString('es-MX')}
                                </div>
                                <div class="metric-label" style="font-size: 0.7rem; color: #6c757d; margin-top: 3px;">
                                    Meta Período
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // NUEVA FUNCIÓN: Generar tabla unificada con headers multinivel
    function generarTablaUnificada(canalesFila, detallePorCanal, filaIndex) {
        const numCanales = canalesFila.length;

        // Definir colores degradados por canal con mayor opacidad para mejor visibilidad
        const coloresPorCanal = {
            'Mercado Libre': 'linear-gradient(135deg, rgba(255, 235, 59, 0.30), rgba(255, 235, 59, 0.18))',
            'CrediTienda': 'linear-gradient(135deg, rgba(33, 150, 243, 0.30), rgba(33, 150, 243, 0.18))',
            'Walmart': 'linear-gradient(135deg, rgba(76, 175, 80, 0.30), rgba(76, 175, 80, 0.18))',
            'Shein': 'linear-gradient(135deg, rgba(255, 152, 0, 0.30), rgba(255, 152, 0, 0.18))',
            'Yuhu': 'linear-gradient(135deg, rgba(233, 30, 99, 0.30), rgba(233, 30, 99, 0.18))',
            'Liverpool': 'linear-gradient(135deg, rgba(156, 39, 176, 0.30), rgba(156, 39, 176, 0.18))',
            'AliExpress': 'linear-gradient(135deg, rgba(244, 67, 54, 0.30), rgba(244, 67, 54, 0.18))',
            'Coppel': 'linear-gradient(135deg, rgba(0, 150, 136, 0.30), rgba(0, 150, 136, 0.18))'
        };

        // Generar headers nivel 1: Nombre del canal (colspan=3)
        const headersNivel1 = canalesFila.map((canal) => {
            const degradado = coloresPorCanal[canal.canal] || 'linear-gradient(135deg, rgba(158, 158, 158, 0.15), rgba(158, 158, 158, 0.08))';
            return `<th colspan="3" style="text-align: center; background-color: #ffffff; background-image: ${degradado}; padding: 0.5rem; font-weight: 700; border: 1px solid #dee2e6; color: #2C2C2C; font-size: 0.95rem; position: sticky; top: 0; z-index: 11;">${canal.canal}</th>`;
        }).join('');

        // Generar headers nivel 2: Meta | Ventas | Cumplimiento
        const headersNivel2 = canalesFila.map((canal) => {
            const degradado = coloresPorCanal[canal.canal] || 'linear-gradient(135deg, rgba(158, 158, 158, 0.15), rgba(158, 158, 158, 0.08))';
            return `
                <th style="text-align: center; background-color: #ffffff; background-image: ${degradado}; padding: 0.5rem; font-weight: 600; border: 1px solid #dee2e6; font-size: 0.9rem; width: auto; position: sticky; top: 0; z-index: 11;">Meta</th>
                <th style="text-align: center; background-color: #ffffff; background-image: ${degradado}; padding: 0.5rem; font-weight: 600; border: 1px solid #dee2e6; font-size: 0.9rem; width: auto; position: sticky; top: 0; z-index: 11;">Ventas</th>
                <th style="text-align: center; background-color: #ffffff; background-image: ${degradado}; padding: 0.5rem; font-weight: 600; border: 1px solid #dee2e6; font-size: 0.9rem; width: auto; position: sticky; top: 0; z-index: 11;">Cumplimiento</th>
            `;
        }).join('');

        // Generar las filas de datos
        const filasHTML = generarFilasTablaUnificada(canalesFila, detallePorCanal);

        return `
            <div class="tabla-unificada-container mt-3" style="max-height: 500px; overflow-y: auto;">
                <table class="table table-sm table-bordered" style="margin-bottom: 0; font-size: 0.9rem; table-layout: fixed; width: 100%;">
                    <thead class="sticky-top" style="position: sticky; top: 0; z-index: 10; background-color: #ffffff;">
                        <!-- Nivel 1: Nombre del canal -->
                        <tr style="position: sticky; top: 0;">
                            <th rowspan="2" style="vertical-align: middle; text-align: center; background-color: #e9ecef; padding: 0.5rem; font-weight: 700; border: 1px solid #dee2e6; position: sticky; left: 0; top: 0; z-index: 12; width: 100px; font-size: 0.95rem;">Fecha</th>
                            ${headersNivel1}
                        </tr>
                        <!-- Nivel 2: Meta | Ventas | Cumplimiento -->
                        <tr style="position: sticky; top: 0;">
                            ${headersNivel2}
                        </tr>
                    </thead>
                    <tbody>
                        ${filasHTML}
                    </tbody>
                </table>
            </div>
        `;
    }

    // NUEVA FUNCIÓN: Generar filas de datos de la tabla unificada
    function generarFilasTablaUnificada(canalesFila, detallePorCanal) {
        // Definir colores de fondo por canal con mayor opacidad para mejor visibilidad
        const coloresFondoPorCanal = {
            'Mercado Libre': 'rgba(255, 235, 59, 0.15)',
            'CrediTienda': 'rgba(33, 150, 243, 0.15)',
            'Walmart': 'rgba(76, 175, 80, 0.15)',
            'Shein': 'rgba(255, 152, 0, 0.15)',
            'Yuhu': 'rgba(233, 30, 99, 0.15)',
            'Liverpool': 'rgba(156, 39, 176, 0.15)',
            'AliExpress': 'rgba(244, 67, 54, 0.15)',
            'Coppel': 'rgba(0, 150, 136, 0.15)'
        };

        // Obtener todos los días de todos los canales
        const todosLosDias = {};

        canalesFila.forEach(canal => {
            const detalleCanal = detallePorCanal[canal.canal] || [];
            detalleCanal.forEach(dia => {
                if (!todosLosDias[dia.Fecha]) {
                    todosLosDias[dia.Fecha] = {};
                }
                todosLosDias[dia.Fecha][canal.canal] = dia;
            });
        });

        // Ordenar fechas
        const fechasOrdenadas = Object.keys(todosLosDias).sort();

        // Generar filas
        return fechasOrdenadas.map(fecha => {
            // Columnas de datos para cada canal
            const columnasCanales = canalesFila.map(canal => {
                const diaData = todosLosDias[fecha][canal.canal];
                const colorFondo = coloresFondoPorCanal[canal.canal] || 'rgba(158, 158, 158, 0.08)';

                if (!diaData) {
                    return `
                        <td style="text-align: right; padding: 0.5rem; border: 1px solid #dee2e6; background: ${colorFondo}; font-size: 0.9rem;">-</td>
                        <td style="text-align: right; padding: 0.5rem; border: 1px solid #dee2e6; background: ${colorFondo}; font-size: 0.9rem;">-</td>
                        <td style="text-align: center; padding: 0.5rem; border: 1px solid #dee2e6; background: ${colorFondo}; font-size: 0.9rem; color: #6c757d;">-</td>
                    `;
                }

                // Detectar si es día futuro
                const fechaDia = new Date(diaData.Fecha + 'T00:00:00');
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);
                const esDiaFuturo = fechaDia > hoy;

                let cumplimientoColor;
                if (esDiaFuturo && diaData.Ventas_Reales === 0) {
                    cumplimientoColor = '#6c757d';
                } else {
                    cumplimientoColor = diaData.Cumplimiento >= 100 ? '#28a745' :
                                       diaData.Cumplimiento >= 50 ? '#ffc107' : '#dc3545';
                }

                // Generar barra de progreso para cumplimiento con degradados suaves
                const cumplimientoValor = Math.round(diaData.Cumplimiento);
                const cumplimientoPorcentaje = Math.min(cumplimientoValor, 100); // Limitar a 100% para la barra

                // Definir degradados con rangos ajustados según el cumplimiento
                let barraDegradado, textoColor;
                if (esDiaFuturo && diaData.Ventas_Reales === 0) {
                    // Gris para días futuros sin ventas
                    barraDegradado = 'linear-gradient(90deg, rgba(108, 117, 125, 0.5), rgba(108, 117, 125, 0.25))';
                    textoColor = 'rgba(108, 117, 125, 0.85)';
                } else if (diaData.Cumplimiento >= 100) {
                    // Verde para 100% o más
                    barraDegradado = 'linear-gradient(90deg, rgba(40, 167, 69, 0.65), rgba(40, 167, 69, 0.35))';
                    textoColor = 'rgba(40, 167, 69, 1)';
                } else if (diaData.Cumplimiento >= 95) {
                    // Verde para 95-99%
                    barraDegradado = 'linear-gradient(90deg, rgba(40, 167, 69, 0.65), rgba(40, 167, 69, 0.35))';
                    textoColor = 'rgba(40, 167, 69, 1)';
                } else if (diaData.Cumplimiento >= 85) {
                    // Amarillo para 85-94%
                    barraDegradado = 'linear-gradient(90deg, rgba(255, 193, 7, 0.7), rgba(255, 193, 7, 0.4))';
                    textoColor = 'rgba(255, 193, 7, 1)';
                } else if (diaData.Cumplimiento >= 50) {
                    // Naranja para 50-84%
                    barraDegradado = 'linear-gradient(90deg, rgba(255, 152, 0, 0.7), rgba(255, 152, 0, 0.4))';
                    textoColor = 'rgba(255, 152, 0, 1)';
                } else {
                    // Rojo para menos de 50%
                    barraDegradado = 'linear-gradient(90deg, rgba(220, 53, 69, 0.65), rgba(220, 53, 69, 0.35))';
                    textoColor = 'rgba(220, 53, 69, 1)';
                }

                const barraHTML = `
                    <div style="display: flex; align-items: center; justify-content: flex-end; gap: 0.3rem;">
                        <div style="flex: 1; background: rgba(233, 236, 239, 0.4); border-radius: 5px; height: 18px; position: relative; min-width: 60px;">
                            <div style="background: ${barraDegradado}; width: ${cumplimientoPorcentaje}%; height: 100%; border-radius: 5px; transition: width 0.3s ease;"></div>
                        </div>
                        <span style="font-weight: 700; color: ${textoColor}; font-size: 0.85rem; min-width: 35px;"><strong>${cumplimientoValor}%</strong></span>
                    </div>
                `;

                return `
                    <td style="text-align: right; padding: 0.5rem; border: 1px solid #dee2e6; background: ${colorFondo}; font-size: 0.9rem;">$${Math.round(diaData.Meta_Diaria).toLocaleString('es-MX', {maximumFractionDigits: 0})}</td>
                    <td style="text-align: right; padding: 0.5rem; border: 1px solid #dee2e6; background: ${colorFondo}; font-size: 0.9rem;">$${Math.round(diaData.Ventas_Reales).toLocaleString('es-MX', {maximumFractionDigits: 0})}</td>
                    <td style="padding: 0.5rem; border: 1px solid #dee2e6; background: ${colorFondo};">${barraHTML}</td>
                `;
            }).join('');

            return `
                <tr>
                    <td style="padding: 0.5rem; border: 1px solid #dee2e6; position: sticky; left: 0; background: #fff; z-index: 2; width: 100px; font-size: 0.9rem;">${formatearFecha(fecha)}</td>
                    ${columnasCanales}
                </tr>
            `;
        }).join('');
    }

    // NUEVA FUNCIÓN: Generar una fila completa con gráficos y tabla unificada
    function generarFilaConTablaUnificada(canalesFila, detallePorCanal, filaIndex) {
        const numCanales = canalesFila.length;

        // Generar los gráficos (sin las tablas individuales)
        const graficosHTML = canalesFila.map((canal, indexEnFila) => {
            return generarSoloGrafico(canal, indexEnFila);
        }).join('');

        // Generar la tabla unificada para todos los canales de esta fila
        const tablaUnificadaHTML = generarTablaUnificada(canalesFila, detallePorCanal, filaIndex);

        return `
            <div class="fila-completa mb-4" data-fila="${filaIndex}">
                <!-- Gráficos -->
                <div class="graficos-container" style="display: grid; grid-template-columns: repeat(${numCanales}, 1fr); gap: 0;">
                    ${graficosHTML}
                </div>
                <!-- Tabla unificada -->
                ${tablaUnificadaHTML}
            </div>
        `;
    }

    // Función para generar el HTML de un barómetro
    function generarBarometroHTML(canal, index, totalCanales = 1, columnasGrid = 4) {
        const statusColor = canal.cumplimiento >= 100 ? '#28a745' :
                           canal.cumplimiento >= 50 ? '#ffc107' : '#dc3545';

        // Calcular si debe mostrar scroll y columna fecha
        // Debe tener scroll cada 4 elementos (posiciones 4, 8, 12, etc)
        // En términos de index: 3, 7, 11, etc (index+1 es múltiplo de 4)
        const posicion = index + 1; // Posición real (1-based)
        const filaActual = Math.floor(index / columnasGrid); // Fila actual (0-based)
        const columnaEnFila = index % columnasGrid; // Columna dentro de la fila (0-based)
        const esPrimeraColumnaFila = columnaEnFila === 0; // Primera columna de cada fila
        const debeSerUltimo = posicion % columnasGrid === 0; // Cada 4 posiciones
        const esUltimoElemento = index === totalCanales - 1; // El último elemento siempre tiene scroll
        const mostrarScroll = debeSerUltimo || esUltimoElemento;

        console.log(`🔍 ${canal.canal}: posicion=${posicion}, index=${index}, fila=${filaActual}, columna=${columnaEnFila}, mostrarFecha=${esPrimeraColumnaFila}, mostrarScroll=${mostrarScroll}`);

        const strokeDashoffset = 439.8 * (1 - Math.min(1.0, (canal.cumplimiento * 0.8 / 100)));
        const rotation = Math.min(144, (canal.cumplimiento * 180 * 0.8 / 100));

        const agujaColor = canal.cumplimiento <= 25 ? '#dc3545' :
                          canal.cumplimiento <= 50 ? '#e8722b' :
                          canal.cumplimiento <= 75 ? '#ffc107' :
                          canal.cumplimiento <= 100 ? '#28a745' : '#20c997';

        return `
            <div class="canal-card" data-canal="${canal.canal}" style="min-height: 520px;">
                <div class="card h-100 shadow-sm" style="border: none; border-radius: 12px; overflow: hidden; background: linear-gradient(145deg, #ffffff, #f8f9fa); display: flex; flex-direction: column;">
                    <div class="card-header border-0 pb-1" style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.08), rgba(212, 175, 55, 0.04)); padding: 0.75rem 1rem;">
                        <div class="d-flex align-items-center justify-content-between">
                            <h6 class="mb-0 fw-bold" style="color: #2C2C2C; font-size: 0.9rem;">
                                <i class="bi bi-broadcast me-1" style="color: #D4AF37; font-size: 0.8rem;"></i>${canal.canal}
                            </h6>
                            <div style="width: 10px; height: 10px; border-radius: 50%; background: ${statusColor}; box-shadow: 0 0 6px ${statusColor}40;"></div>
                        </div>
                    </div>
                    <div class="card-body text-center d-flex flex-column justify-content-center align-items-center" style="padding: 1rem 0.5rem;">
                        <!-- BARÓMETRO -->
                        <div class="barometer-container mb-3" style="position: relative; width: 260px; height: 145px; margin: 0 auto;">
                            <svg width="260" height="145" viewBox="0 0 260 145">
                                <!-- Fondo para el texto "META" -->
                                <rect x="222" y="28" width="28" height="15" rx="3" ry="3" fill="rgba(255, 255, 255, 0.9)" stroke="rgba(44, 44, 44, 0.2)" stroke-width="1"/>
                                <text x="236" y="38" font-family="Arial, sans-serif" font-size="8" font-weight="600" fill="${canal.cumplimiento > 100 ? '#1e7e34' : '#2C2C2C'}" text-anchor="middle" opacity="1">META</text>

                                <!-- Arco de fondo -->
                                <path d="M 20 125 A 110 110 0 0 1 240 125" fill="none" stroke="#e9ecef" stroke-width="14" stroke-linecap="round"/>

                                <!-- Gradiente -->
                                <defs>
                                    <linearGradient id="barometer-gradient-modal-${index}" x1="0%" y1="0%" x2="100%" y2="0%">
                                        <stop offset="0%" style="stop-color:#dc3545;stop-opacity:1" />
                                        <stop offset="20%" style="stop-color:#e8722b;stop-opacity:1" />
                                        <stop offset="21%" style="stop-color:#ffc107;stop-opacity:1" />
                                        <stop offset="60%" style="stop-color:#7cb342;stop-opacity:1" />
                                        <stop offset="61%" style="stop-color:#28a745;stop-opacity:1" />
                                        <stop offset="80%" style="stop-color:#28a745;stop-opacity:1" />
                                        <stop offset="81%" style="stop-color:#28a745;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#1e7e34;stop-opacity:1" />
                                    </linearGradient>
                                </defs>

                                <!-- Arco de progreso -->
                                <path d="M 20 125 A 110 110 0 0 1 240 125" fill="none" stroke="url(#barometer-gradient-modal-${index})"
                                      stroke-width="14" stroke-linecap="round" stroke-dasharray="346"
                                      stroke-dashoffset="${346 * (1 - Math.min(1.0, (canal.cumplimiento * 0.8 / 100)))}"
                                      style="transition: stroke-dashoffset 2s ease-in-out; filter: drop-shadow(0 0 6px rgba(212, 175, 55, 0.3));"/>

                                <!-- Línea de meta -->
                                <g transform="translate(130,125)">
                                    <g transform="rotate(144)">
                                        <line x1="0" y1="0" x2="-117" y2="0" stroke="#2C2C2C" stroke-width="1.8" stroke-linecap="round" opacity="0.8"/>
                                        <circle cx="-117" cy="0" r="2.8" fill="#2C2C2C" opacity="0.8"/>
                                    </g>
                                </g>

                                <!-- Aguja -->
                                <g transform="translate(130,125)">
                                    <g transform="rotate(${rotation})" style="transition: transform 2s ease-in-out;">
                                        <line x1="0" y1="0" x2="-110" y2="0" stroke="rgba(0,0,0,0.2)" stroke-width="2.8" stroke-linecap="round" transform="translate(1,1)"/>
                                        <line x1="0" y1="0" x2="-110" y2="0" stroke="${agujaColor}" stroke-width="2.8" stroke-linecap="round"/>
                                    </g>
                                    <circle cx="0" cy="0" r="7" fill="${agujaColor}" stroke="white" stroke-width="2" style="filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));"/>
                                </g>
                            </svg>

                            <!-- Porcentaje central -->
                            <div class="barometer-content" style="position: absolute; bottom: 0px; left: 50%; transform: translateX(-50%); text-align: center;">
                                <div class="percentage-value" style="font-size: 1.3rem; font-weight: 800; color: #2C2C2C; line-height: 1;">
                                    ${Math.round(canal.cumplimiento)}%
                                </div>
                            </div>

                            <!-- Indicador de logro -->
                            ${canal.cumplimiento >= 100 ? `
                                <div class="achievement-icon" style="position: absolute; top: -5px; right: 8px; background: linear-gradient(135deg, #28a745, #20c997); border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3); animation: pulse 2s infinite;">
                                    <i class="bi bi-check2"></i>
                                </div>
                            ` : ''}
                        </div>

                        <!-- MÉTRICAS -->
                        <div class="metrics-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.6rem;">
                            <div class="metric-card" style="background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.05)); border-radius: 10px; padding: 0.75rem; text-align: center; border: 1px solid rgba(40, 167, 69, 0.1);">
                                <div class="metric-icon mb-1" style="color: #28a745; font-size: 1rem;">
                                    <i class="bi bi-graph-up-arrow"></i>
                                </div>
                                <div class="metric-value" style="font-size: 0.9rem; font-weight: 700; color: #28a745; line-height: 1;">
                                    $${Math.round(canal.ventasReales).toLocaleString('es-MX')}
                                </div>
                                <div class="metric-label" style="font-size: 0.7rem; color: #6c757d; margin-top: 3px;">
                                    Ventas Reales
                                </div>
                            </div>

                            <div class="metric-card" style="background: linear-gradient(135deg, rgba(23, 162, 184, 0.1), rgba(23, 162, 184, 0.05)); border-radius: 10px; padding: 0.75rem; text-align: center; border: 1px solid rgba(23, 162, 184, 0.1);">
                                <div class="metric-icon mb-1" style="color: #17a2b8; font-size: 1rem;">
                                    <i class="bi bi-bullseye"></i>
                                </div>
                                <div class="metric-value" style="font-size: 0.9rem; font-weight: 700; color: #17a2b8; line-height: 1;">
                                    $${Math.round(canal.metaPeriodo).toLocaleString('es-MX')}
                                </div>
                                <div class="metric-label" style="font-size: 0.7rem; color: #6c757d; margin-top: 3px;">
                                    Meta Período
                                </div>
                            </div>
                        </div>

                        <!-- NUEVA: Mini tabla de detalle diario -->
                        <div class="detalle-diario-tabla${mostrarScroll ? ' tabla-ultima' : ''} mt-3" data-fila="${filaActual}" style="max-height: 300px;">
                            <table class="table table-sm table-hover" style="font-size: 0.85rem; margin-bottom: 0;">
                                <thead class="sticky-top" style="background: ${degradadoCanal}; font-size: 0.8rem;">
                                    <tr>
                                        ${esPrimeraColumnaFila ? '<th style="padding: 0.5rem 0.6rem; width: 15%;">Fecha</th>' : ''}
                                        <th class="text-end" style="padding: 0.5rem 0.6rem; width: ${esPrimeraColumnaFila ? '30%' : '35%'};">Meta</th>
                                        <th class="text-end" style="padding: 0.5rem 0.6rem; width: ${esPrimeraColumnaFila ? '30%' : '35%'};">Ventas</th>
                                        <th class="text-end" style="padding: 0.5rem 0.6rem; width: ${esPrimeraColumnaFila ? '25%' : '30%'};">Cump.</th>
                                    </tr>
                                </thead>
                                <tbody id="detalle-${canal.canal.replace(/\s+/g, '-')}">
                                    <!-- Se llenará dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Función para formatear fecha
    function formatearFecha(fechaStr) {
        const fecha = new Date(fechaStr + 'T00:00:00');
        const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
        const diaSemana = diasSemana[fecha.getDay()];
        const numeroDia = fecha.getDate();
        return `${diaSemana} ${numeroDia}`;
    }

    // Función para mostrar error en modal
    function mostrarErrorModal(mensaje) {
        const tbody = document.getElementById('modal-tabla-body');
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center py-5">
                    <i class="bi bi-exclamation-triangle-fill text-danger" style="font-size: 3rem;"></i>
                    <p class="mt-3 text-danger fw-semibold">${mensaje}</p>
                </td>
            </tr>
        `;
    }

    // Función para inicializar fechas por defecto (inicio del mes actual hasta hoy)
    function inicializarFechasModal() {
        const mesSeleccionado = document.getElementById('mes_filtro').value;
        const [anio, mes] = mesSeleccionado.split('-');

        // Primer día del mes
        const primerDia = `${anio}-${mes}-01`;

        // Día actual
        const hoy = new Date();
        const diaActual = hoy.toISOString().split('T')[0];

        // Establecer valores por defecto
        document.getElementById('modal-fecha-inicio').value = primerDia;
        document.getElementById('modal-fecha-fin').value = diaActual;
    }

    // Event Listeners del Modal
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('modalDetalleDiario');
        const btnVerDetalle = document.getElementById('btn-ver-detalle-diario');
        const btnModalActualizar = document.getElementById('btn-modal-actualizar');
        const btnExportar = document.getElementById('btn-modal-exportar-excel');

        // Abrir modal al hacer clic en el botón
        btnVerDetalle.addEventListener('click', function() {
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();

            // Inicializar fechas por defecto
            inicializarFechasModal();

            // Cargar datos cuando se abre el modal
            setTimeout(() => {
                cargarDatosModal('TODOS');
            }, 300);
        });

        // Actualizar datos al hacer clic en botón actualizar
        btnModalActualizar.addEventListener('click', function() {
            cargarDatosModal('TODOS');
        });

        // Cambiar tipo de meta (Nominal/Real) en el modal
        document.querySelectorAll('input[name="modal-tipo-meta"]').forEach(radio => {
            radio.addEventListener('change', function() {
                cargarDatosModal('TODOS');
            });
        });

        // Event listeners para cambios en las fechas
        document.getElementById('modal-fecha-inicio').addEventListener('change', function() {
            cargarDatosModal('TODOS');
        });

        document.getElementById('modal-fecha-fin').addEventListener('change', function() {
            cargarDatosModal('TODOS');
        });

        // Exportar a Excel
        btnExportar.addEventListener('click', function() {
            const mesSeleccionado = document.getElementById('mes_filtro').value;
            const canalFiltro = 'TODOS';

            // Obtener el tipo de meta del modal
            const tipoMetaModal = document.querySelector('input[name="modal-tipo-meta"]:checked');
            const tipoMeta = tipoMetaModal ? tipoMetaModal.value : 'nominal';

            // Crear formulario para enviar
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/cumplimiento-metas-exportar-excel';

            const campos = {
                'mes_filtro': mesSeleccionado,
                'canal_filtro': canalFiltro,
                'tipo_meta': tipoMeta
            };

            Object.keys(campos).forEach(key => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = campos[key];
                form.appendChild(input);
            });

            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);

            // Feedback visual
            const originalHTML = btnExportar.innerHTML;
            btnExportar.innerHTML = '<i class="bi bi-check-circle me-2"></i>Exportando...';
            btnExportar.disabled = true;

            setTimeout(() => {
                btnExportar.innerHTML = originalHTML;
                btnExportar.disabled = false;
            }, 2000);
        });
    });

    // ============================================================================
    // FUNCIÓN PARA CREAR MINI-BARÓMETRO EN LA TABLA
    // ============================================================================
    function crearMiniBarometro(cumplimiento) {
        // Determinar color según el cumplimiento
        let color;
        if (cumplimiento >= 100) {
            color = '#28a745'; // Verde
        } else if (cumplimiento >= 80) {
            color = '#20c997'; // Verde claro
        } else if (cumplimiento >= 50) {
            color = '#ffc107'; // Amarillo
        } else {
            color = '#dc3545'; // Rojo
        }

        // Limitar el ancho a 100% máximo
        const porcentajeWidth = Math.min(cumplimiento, 100);

        return `
            <div style="display: flex; align-items: center; gap: 8px;">
                <div style="flex: 1; height: 20px; background: #f8f9fa; border-radius: 10px; overflow: hidden; position: relative;">
                    <div style="height: 100%; background: ${color}; width: ${porcentajeWidth}%; transition: width 0.3s ease;"></div>
                </div>
                <span style="min-width: 45px; font-weight: 600; color: ${color};">${cumplimiento.toFixed(1)}%</span>
            </div>
        `;
    }

    // ==========================================
    // SINCRONIZACIÓN DE SCROLL ENTRE TABLAS
    // ==========================================
    function sincronizarScrollTablas() {
        // Obtener todos los contenedores de tablas con la clase detalle-diario-tabla
        const tablasContainers = document.querySelectorAll('.detalle-diario-tabla');

        if (tablasContainers.length === 0) {
            return;
        }

        console.log(`📊 Sincronizando scroll de ${tablasContainers.length} tablas por fila`);

        // Variable para evitar bucles infinitos de eventos
        let isSyncing = false;

        // Agregar event listener a cada contenedor de tabla
        tablasContainers.forEach((container, index) => {
            container.addEventListener('scroll', function(e) {
                // Si ya estamos sincronizando, salir para evitar bucle
                if (isSyncing) return;

                isSyncing = true;
                const scrollTop = this.scrollTop;
                const filaActual = this.getAttribute('data-fila');

                // Aplicar el mismo scroll solo a las tablas de la misma fila
                tablasContainers.forEach((otherContainer, otherIndex) => {
                    const otraFila = otherContainer.getAttribute('data-fila');

                    // Solo sincronizar si es de la misma fila y no es la misma tabla
                    if (otherIndex !== index && filaActual === otraFila) {
                        otherContainer.scrollTop = scrollTop;
                    }
                });

                // Liberar el flag después de un breve delay
                setTimeout(() => {
                    isSyncing = false;
                }, 10);
            });
        });

        console.log('✅ Scroll sincronizado por filas en el modal');
    }

    // Llamar a la sincronización después de que se carguen las tablas
    // Observar cambios en el contenedor de barómetros para detectar cuando se cargan las tablas
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.addedNodes.length > 0) {
                // Verificar si se agregaron tablas
                const tablas = document.querySelectorAll('.detalle-diario-tabla');
                if (tablas.length > 0) {
                    // Esperar un momento para asegurar que todas las tablas estén renderizadas
                    setTimeout(() => {
                        sincronizarScrollTablas();
                    }, 100);
                }
            }
        });
    });

    // ============================================================================
    // FUNCIONES PARA EL MODAL DE CUMPLIMIENTO HOY
    // ============================================================================

    // Función para cargar datos del día actual
    function cargarDatosDiaActual() {
        const mesSeleccionado = document.getElementById('mes_filtro').value;
        const tipoMetaModal = document.querySelector('input[name="hoy-tipo-meta"]:checked');
        const tipoMeta = tipoMetaModal ? tipoMetaModal.value : 'nominal';

        console.log(`Cargando cumplimiento hoy - Mes: ${mesSeleccionado}, Tipo: ${tipoMeta}`);

        // Actualizar el label según el tipo de meta
        const ventasLabel = document.getElementById('hoy-ventas-label');
        if (ventasLabel) {
            ventasLabel.textContent = tipoMeta === 'real' ? 'Ingreso del Día' : 'Ventas del Día';
        }

        // Preparar datos para enviar
        const formData = new FormData();
        formData.append('mes_filtro', mesSeleccionado);
        formData.append('tipo_meta', tipoMeta);

        // Llamar al endpoint
        fetch('/cumplimiento-metas-dia-actual', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            console.log('🔍 Respuesta del servidor (Cumplimiento Hoy):', data);

            if (data.success) {
                // Actualizar fecha
                document.getElementById('hoy-fecha-texto').textContent = data.fecha;

                // Actualizar totales y barómetro
                actualizarBarometroHoy(data.totales);

                // Actualizar tabla
                actualizarTablaHoy(data.datos_tabla, tipoMeta);
            } else {
                mostrarErrorModalHoy(data.error || 'Error cargando datos');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarErrorModalHoy('Error de conexión al servidor');
        });
    }

    // Función para actualizar el barómetro y métricas del día
    function actualizarBarometroHoy(totales) {
        // Actualizar valores numéricos
        document.getElementById('hoy-meta-total').textContent =
            '$' + Math.round(totales.meta).toLocaleString('es-MX');

        document.getElementById('hoy-ventas-total').textContent =
            '$' + Math.round(totales.ventas).toLocaleString('es-MX');

        const variacionElement = document.getElementById('hoy-variacion-total');
        variacionElement.textContent =
            (totales.variacion >= 0 ? '+' : '') + '$' + Math.round(totales.variacion).toLocaleString('es-MX');
        variacionElement.style.color = totales.variacion >= 0 ? '#28a745' : '#dc3545';

        // Actualizar porcentaje de cumplimiento
        const cumplimientoValor = document.getElementById('hoy-cumplimiento-valor');
        cumplimientoValor.textContent = totales.cumplimiento.toFixed(1) + '%';

        // Determinar color de la aguja según cumplimiento
        let agujaColor;
        if (totales.cumplimiento <= 25) {
            agujaColor = '#dc3545';
        } else if (totales.cumplimiento <= 50) {
            agujaColor = '#e8722b';
        } else if (totales.cumplimiento <= 75) {
            agujaColor = '#ffc107';
        } else if (totales.cumplimiento <= 100) {
            agujaColor = '#28a745';
        } else {
            agujaColor = '#20c997';
        }

        // Actualizar color de la aguja
        document.getElementById('hoy-aguja-linea').setAttribute('stroke', agujaColor);
        document.getElementById('hoy-aguja-circulo').setAttribute('fill', agujaColor);

        // Calcular rotación de la aguja (0-144 grados, limitado al 80% del arco)
        const rotacion = Math.min(144, (totales.cumplimiento * 180 * 0.8 / 100));
        document.getElementById('hoy-aguja-rotacion').setAttribute('transform', `rotate(${rotacion})`);

        // Actualizar arco de progreso
        const arcLength = 377; // Longitud del arco (280px de ancho, radio 120)
        const progress = Math.min(1.0, (totales.cumplimiento * 0.8 / 100));
        const offset = arcLength * (1 - progress);
        document.getElementById('hoy-arco-progreso').style.strokeDashoffset = offset;

        console.log(`✅ Barómetro actualizado: ${totales.cumplimiento.toFixed(1)}% (rotación: ${rotacion}°)`);
    }

    // Función para actualizar la tabla de resumen por canal
    function actualizarTablaHoy(datos, tipoMeta) {
        const tbody = document.getElementById('hoy-tabla-body');

        if (!datos || datos.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-4 text-muted">
                        <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                        <p class="mt-2">No hay datos disponibles para hoy</p>
                    </td>
                </tr>
            `;
            return;
        }

        // Generar filas de la tabla
        tbody.innerHTML = datos.map((row, index) => {
            const cumplimientoClass =
                row.Cumplimiento >= 100 ? 'text-success' :
                row.Cumplimiento >= 50 ? 'text-warning' : 'text-danger';

            const cumplimientoColor =
                row.Cumplimiento >= 100 ? '#28a745' :
                row.Cumplimiento >= 50 ? '#ffc107' : '#dc3545';

            const variacionColor = row.Variacion >= 0 ? '#28a745' : '#dc3545';

            // Alternar color de fondo
            const bgColor = index % 2 === 0 ? '#ffffff' : '#f8f9fa';

            return `
                <tr style="background: ${bgColor}; transition: all 0.3s ease;"
                    onmouseenter="this.style.background='rgba(23, 162, 184, 0.08)'; this.style.transform='translateY(-2px)'"
                    onmouseleave="this.style.background='${bgColor}'; this.style.transform='translateY(0)'">
                    <td style="padding: 0.7rem 0.9rem;">
                        <span class="badge" style="background: linear-gradient(135deg, rgba(23, 162, 184, 0.1), rgba(23, 162, 184, 0.05)); color: #17a2b8; font-weight: 600; border: 1px solid rgba(23, 162, 184, 0.2); padding: 0.35rem 0.7rem; font-size: 0.85rem;">
                            ${row.Canal}
                        </span>
                    </td>
                    <td class="text-end fw-semibold" style="padding: 0.7rem 0.9rem; color: #17a2b8; font-size: 0.9rem;">
                        $${Math.round(row.Meta_Diaria).toLocaleString('es-MX')}
                    </td>
                    <td class="text-end fw-semibold" style="padding: 0.7rem 0.9rem; color: #28a745; font-size: 0.9rem;">
                        $${Math.round(row.Ventas_Reales).toLocaleString('es-MX')}
                    </td>
                    <td class="text-end fw-semibold" style="padding: 0.7rem 0.9rem; color: ${variacionColor}; font-size: 0.9rem;">
                        ${row.Variacion >= 0 ? '+' : ''}$${Math.round(row.Variacion).toLocaleString('es-MX')}
                    </td>
                    <td class="text-center" style="padding: 0.7rem 0.9rem;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 0.6rem;">
                            <div style="flex: 1; max-width: 140px; height: 22px; background: #f8f9fa; border-radius: 11px; overflow: hidden; position: relative; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);">
                                <div style="height: 100%; background: ${cumplimientoColor}; width: ${Math.min(row.Cumplimiento, 100)}%; transition: width 0.5s ease;"></div>
                            </div>
                            <span class="fw-bold" style="min-width: 50px; color: ${cumplimientoColor}; font-size: 0.9rem;">
                                ${Math.round(row.Cumplimiento)}%
                            </span>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');

        console.log(`✅ Tabla actualizada con ${datos.length} canales`);
    }

    // Función para mostrar error en modal
    function mostrarErrorModalHoy(mensaje) {
        const tbody = document.getElementById('hoy-tabla-body');
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center py-5">
                    <i class="bi bi-exclamation-triangle-fill text-danger" style="font-size: 3rem;"></i>
                    <p class="mt-3 text-danger fw-semibold">${mensaje}</p>
                </td>
            </tr>
        `;

        // Resetear barómetro
        document.getElementById('hoy-cumplimiento-valor').textContent = '0%';
        document.getElementById('hoy-meta-total').textContent = '$0';
        document.getElementById('hoy-ventas-total').textContent = '$0';
        document.getElementById('hoy-variacion-total').textContent = '$0';
    }

    // Event Listeners para el modal de Cumplimiento Hoy
    document.addEventListener('DOMContentLoaded', function() {
        const modalHoy = document.getElementById('modalCumplimientoHoy');
        const btnCumplimientoHoy = document.getElementById('btn-cumplimiento-hoy');
        const btnHoyActualizar = document.getElementById('btn-hoy-actualizar');
        let autoRefreshInterval = null;

        // Abrir modal al hacer clic en el botón
        if (btnCumplimientoHoy) {
            btnCumplimientoHoy.addEventListener('click', function() {
                const bsModal = new bootstrap.Modal(modalHoy);
                bsModal.show();

                // Cargar datos cuando se abre el modal
                setTimeout(() => {
                    cargarDatosDiaActual();
                }, 300);
            });
        }

        // Auto-refresh cada 18 minutos cuando el modal está abierto
        if (modalHoy) {
            modalHoy.addEventListener('shown.bs.modal', function() {
                // Iniciar auto-refresh cada 18 minutos (1,080,000 ms)
                autoRefreshInterval = setInterval(() => {
                    console.log('Auto-actualizando datos de Cumplimiento Hoy...');
                    cargarDatosDiaActual();
                }, 1080000); // 18 minutos = 18 * 60 * 1000 = 1,080,000 ms
            });

            modalHoy.addEventListener('hidden.bs.modal', function() {
                // Limpiar el intervalo cuando se cierra el modal
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                    console.log('Auto-refresh detenido');
                }
            });
        }

        // Actualizar datos al hacer clic en botón actualizar
        if (btnHoyActualizar) {
            btnHoyActualizar.addEventListener('click', function() {
                const originalHTML = this.innerHTML;
                this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Actualizando...';
                this.disabled = true;

                cargarDatosDiaActual();

                setTimeout(() => {
                    this.innerHTML = originalHTML;
                    this.disabled = false;
                }, 2000);
            });
        }

        // Cambiar tipo de meta (Nominal/Real) en el modal
        const tipoMetaInputs = document.querySelectorAll('input[name="hoy-tipo-meta"]');
        tipoMetaInputs.forEach(input => {
            input.addEventListener('change', function() {
                cargarDatosDiaActual();
            });
        });
    });

    // ============================================================================
    // FIN FUNCIONES MODAL CUMPLIMIENTO HOY
    // ============================================================================

    // Observar el contenedor de barómetros cuando esté disponible
    document.addEventListener('DOMContentLoaded', function() {
        const contenedorBarometros = document.getElementById('modal-barometros-container');
        if (contenedorBarometros) {
            observer.observe(contenedorBarometros, {
                childList: true,
                subtree: true
            });
        }
    });

</script>
</div>
{% endblock %}
