{# MACROS PARA COLORES SEG√öN TIPO DE META #}
{% macro color_segun_meta(valor, tipo_meta, costo_porcentaje=0) -%}
  {%- if tipo_meta == "costo" -%}
    {%- set costo_val = (costo_porcentaje | float) if costo_porcentaje else 0 -%}
    {%- if costo_val < 48 -%}#28a745{%- elif costo_val <= 54 -%}#ffc107{%- else -%}#dc3545{%- endif -%}
  {%- elif tipo_meta == "ingreso_real" -%}
    {%- set val = (valor | float) if valor else 0 -%}
    {%- if val < 10 -%}#dc3545{%- elif val <= 15 -%}#ffc107{%- else -%}#28a745{%- endif -%}
  {%- else -%}
    {%- set val = (valor | float) if valor else 0 -%}
    {%- if val >= 100 -%}#28a745{%- elif val >= 50 -%}#ffc107{%- else -%}#dc3545{%- endif -%}
  {%- endif -%}
{%- endmacro %}

{% macro color_fondo_segun_meta(valor, tipo_meta, opacidad='0.08', costo_porcentaje=0) -%}
  {%- if tipo_meta == "costo" -%}
    {%- set costo_val = (costo_porcentaje | float) if costo_porcentaje else 0 -%}
    {%- if costo_val < 48 -%}rgba(40, 167, 69, {{ opacidad }}){%- elif costo_val <= 54 -%}rgba(255, 193, 7, {{ opacidad }}){%- else -%}rgba(220, 53, 69, {{ opacidad }}){%- endif -%}
  {%- elif tipo_meta == "ingreso_real" -%}
    {%- set val = (valor | float) if valor else 0 -%}
    {%- if val < 10 -%}rgba(220, 53, 69, {{ opacidad }}){%- elif val <= 15 -%}rgba(255, 193, 7, {{ opacidad }}){%- else -%}rgba(40, 167, 69, {{ opacidad }}){%- endif -%}
  {%- else -%}
    {%- set val = (valor | float) if valor else 0 -%}
    {%- if val >= 100 -%}rgba(40, 167, 69, {{ opacidad }}){%- elif val >= 50 -%}rgba(255, 193, 7, {{ opacidad }}){%- else -%}rgba(220, 53, 69, {{ opacidad }}){%- endif -%}
  {%- endif -%}
{%- endmacro %}

<!-- RESUMEN GENERAL - DISE√ëO H√çBRIDO: MODERNO + √çCONOS CIRCULARES -->
<div class="row g-4 mb-4" id="metricsContainer" data-aos="fade-up" data-aos-delay="200" style="overflow: visible;">
    
    <!-- Tarjeta Din√°mica: Per√≠odo / Ventas del Per√≠odo / Ingreso Real del Per√≠odo -->
    <div class="col" data-aos="fade-up" data-aos-delay="700">
        <div class="p-4 shadow-sm border rounded-3 bg-white position-relative text-center"
             style="height: 170px; transition: all 0.3s ease; cursor: pointer; border: 1px solid rgba(212, 175, 55, 0.2);"
             onmouseenter="animateMetricCard(this)"
             onmouseleave="resetMetricCard(this)">

            <!-- Efecto de fondo sutil -->
            <div class="position-absolute top-0 start-0 w-100 h-100 opacity-5"
                 style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.08) 0%, transparent 100%);"></div>

            <!-- √çcono din√°mico seg√∫n tipo de meta -->
            <div class="icon-circle mb-3 mx-auto position-relative"
                 style="width: 60px; height: 60px; background: linear-gradient(135deg, #D4AF37, #B8941F);
                        border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="bi tarjeta-periodo-icono {% if tipo_meta == 'ventas' %}bi-currency-dollar{% elif tipo_meta == 'ingreso_real_nominal' %}bi-cash-coin{% else %}bi-calendar-check{% endif %} text-white" style="font-size: 1.5rem;"></i>
            </div>

            <!-- T√≠tulo din√°mico seg√∫n tipo de meta -->
            <h6 class="mb-2 position-relative tarjeta-periodo-titulo" style="color: #2C2C2C; font-weight: 600;">
                {% if tipo_meta == 'ventas' %}
                    Ventas del Per√≠odo
                {% elif tipo_meta == 'ingreso_real_nominal' %}
                    Ingreso Real del Per√≠odo
                {% else %}
                    Per√≠odo
                {% endif %}
            </h6>

            <!-- Contenido din√°mico seg√∫n tipo de meta -->
            <p class="position-relative tarjeta-periodo-contenido" style="color: {% if tipo_meta == 'costo' %}#6c757d{% else %}#D4AF37{% endif %}; font-size: {% if tipo_meta == 'costo' %}0.9rem{% else %}1.1rem{% endif %}; margin-bottom: 8px; font-weight: {% if tipo_meta == 'costo' %}400{% else %}700{% endif %};">
                {% if tipo_meta == 'ventas' %}
                    <span class="animated-number"
                          data-value="{{ resumen_general.ventas_periodo_total }}"
                          data-type="currency">
                        ${{ "{:,.0f}".format(resumen_general.ventas_periodo_total) }}
                    </span>
                {% elif tipo_meta == 'ingreso_real_nominal' %}
                    <span class="animated-number"
                          data-value="{{ resumen_general.ingreso_real_periodo_total }}"
                          data-type="currency">
                        ${{ "{:,.0f}".format(resumen_general.ingreso_real_periodo_total) }}
                    </span>
                {% else %}
                    {{ periodo_texto }}
                {% endif %}
            </p>

            <!-- Barra de progreso sutil en la parte inferior -->
            <div class="position-absolute bottom-0 start-0 w-100" style="height: 3px; background: rgba(212, 175, 55, 0.1);">
                <div class="h-100 transition-all"
                     style="background: linear-gradient(90deg, #D4AF37, #F4E4A6);
                            width: 0%;
                            transition: width 1.5s ease 1.8s;"></div>
            </div>
        </div>
    </div>
    
    <!-- Meta Per√≠odo -->
    <div class="col" data-aos="fade-up" data-aos-delay="800">
        <div class="p-4 shadow-sm border rounded-3 bg-white position-relative text-center" 
             style="height: 170px; transition: all 0.3s ease; cursor: pointer; border: 1px solid rgba(212, 175, 55, 0.2);"
             onmouseenter="animateMetricCard(this)"
             onmouseleave="resetMetricCard(this)">
            
            <!-- Efecto de fondo sutil -->
            <div class="position-absolute top-0 start-0 w-100 h-100 opacity-5" 
                 style="background: linear-gradient(135deg, rgba(23, 162, 184, 0.08) 0%, transparent 100%);"></div>
            
            <div class="icon-circle mb-3 mx-auto position-relative" 
                 style="width: 60px; height: 60px; background: linear-gradient(135deg, #17a2b8, #6f42c1); 
                        border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-bullseye text-white" style="font-size: 1.5rem;"></i>
            </div>
            
            <h6 class="mb-2 position-relative" style="color: #2C2C2C; font-weight: 600;">Meta Per√≠odo</h6>
            <p class="mb-0 fw-bold position-relative" style="color: #17a2b8; font-size: 1.1rem;">
                {% if cumplimiento_data and cumplimiento_data|length > 0 %}
                    {% if tipo_meta == "costo" %}
                        48% - 54%
                    {% elif tipo_meta == "ingreso_real" %}
                        10% - 15%
                    {% else %}
                        <span class="animated-number" 
                              data-value="{{ resumen_general.meta_total }}"
                              data-type="currency">
                            ${{ "{:,.0f}".format(resumen_general.meta_total) }}
                        </span>
                    {% endif %}
                {% else %}
                    <span style="color: #6c757d; font-size: 0.9rem;">No definida</span>
                {% endif %}
            </p>
            
            <!-- Barra de progreso sutil en la parte inferior -->
            <div class="position-absolute bottom-0 start-0 w-100" style="height: 3px; background: rgba(212, 175, 55, 0.1);">
                <div class="h-100 transition-all" 
                     style="background: linear-gradient(90deg, #17a2b8, #6f42c1); 
                            width: 0%; 
                            transition: width 1.5s ease 2.0s;"></div>
            </div>
        </div>
    </div>
    
    <!-- Meta Total del Mes -->
    <div class="col" data-aos="fade-up" data-aos-delay="900">
        <div class="p-3 shadow-sm border rounded-3 bg-white position-relative text-center d-flex flex-column justify-content-center" 
             style="height: 170px; transition: all 0.3s ease; cursor: pointer; border: 1px solid rgba(212, 175, 55, 0.2);"
             onmouseenter="animateMetricCard(this)"
             onmouseleave="resetMetricCard(this)">
            
            <!-- Efecto de fondo sutil -->
            <div class="position-absolute top-0 start-0 w-100 h-100 opacity-5" 
                 style="background: linear-gradient(135deg, rgba(111, 66, 193, 0.08) 0%, transparent 100%);"></div>
            
            <div class="icon-circle mb-2 mx-auto position-relative" 
                 style="width: 50px; height: 50px; background: linear-gradient(135deg, #6f42c1, #e83e8c); 
                        border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-calendar-month text-white" style="font-size: 1.2rem;"></i>
            </div>
            
            <h6 class="mb-1 position-relative" style="color: #2C2C2C; font-weight: 600; font-size: 0.9rem;">Meta Total del Mes</h6>
            <p class="mb-1 fw-bold position-relative" style="color: #6f42c1; font-size: 1rem;">
                {% if cumplimiento_data and cumplimiento_data|length > 0 %}
                    <span class="animated-number" 
                          data-value="{{ resumen_general.meta_total_mes }}"
                          data-type="currency">
                        ${{ "{:,.0f}".format(resumen_general.meta_total_mes) }}
                    </span>
                {% else %}
                    <span style="color: #6c757d; font-size: 0.9rem;">No definida</span>
                {% endif %}
            </p>
            <small class="text-center position-relative d-block">
                <span class="badge" style="font-size: 0.7rem; color: #2C2C2C; font-weight: 600; 
                                          background-color: {% if resumen_general.cumplimiento_vs_meta_mes >= 100 %}rgba(40, 167, 69, 0.15){% elif resumen_general.cumplimiento_vs_meta_mes >= 50 %}rgba(255, 193, 7, 0.15){% else %}rgba(108, 117, 125, 0.15){% endif %}; 
                                          border: 1px solid {% if resumen_general.cumplimiento_vs_meta_mes >= 100 %}rgba(40, 167, 69, 0.3){% elif resumen_general.cumplimiento_vs_meta_mes >= 50 %}rgba(255, 193, 7, 0.3){% else %}rgba(108, 117, 125, 0.3){% endif %}; 
                                          border-radius: 12px; padding: 4px 8px;">
                    {{ "{:.1f}".format(resumen_general.cumplimiento_vs_meta_mes) }}% del per√≠odo
                </span>
            </small>
            
            <!-- Barra de progreso sutil en la parte inferior -->
            <div class="position-absolute bottom-0 start-0 w-100" style="height: 3px; background: rgba(212, 175, 55, 0.1);">
                <div class="h-100 transition-all" 
                     style="background: linear-gradient(90deg, #6f42c1, #e83e8c); 
                            width: 0%; 
                            transition: width 1.5s ease 2.2s;"></div>
            </div>
        </div>
    </div>
    
    <!-- Cumplimiento de Per√≠odo -->
    <div class="col" data-aos="fade-up" data-aos-delay="1000">
        <div class="p-3 shadow-sm border rounded-3 bg-white position-relative text-center d-flex flex-column justify-content-center"
             style="height: 170px; transition: all 0.3s ease; cursor: pointer; border: 1px solid rgba(212, 175, 55, 0.2);"
             onmouseenter="animateMetricCard(this)"
             onmouseleave="resetMetricCard(this)">

            <!-- Efecto de fondo sutil con color din√°mico -->
            <div class="position-absolute top-0 start-0 w-100 h-100 opacity-5"
                 style="background: linear-gradient(135deg, {{ 'rgba(40, 167, 69, 0.08)' if resumen_general.cumplimiento_global >= 100 else 'rgba(255, 193, 7, 0.08)' if resumen_general.cumplimiento_global >= 50 else 'rgba(220, 53, 69, 0.08)' }} 0%, transparent 100%);"></div>

            <div class="icon-circle mb-2 mx-auto position-relative"
                 style="width: 50px; height: 50px; background: linear-gradient(135deg,
                        {% if resumen_general.cumplimiento_global >= 100 %}#28a745{% elif resumen_general.cumplimiento_global >= 50 %}#ffc107{% else %}#dc3545{% endif %},
                        {% if resumen_general.cumplimiento_global >= 100 %}#20c997{% elif resumen_general.cumplimiento_global >= 50 %}#ffca2c{% else %}#e55353{% endif %});
                        border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-percent text-white" style="font-size: 1.2rem;"></i>
            </div>

            <h6 class="mb-1 position-relative" style="color: #2C2C2C; font-weight: 600; font-size: 0.9rem;">Cumplimiento de Per√≠odo</h6>
            <p class="mb-1 fw-bold position-relative" style="font-size: 1.1rem; color: {% if resumen_general.cumplimiento_global >= 100 %}#28a745{% elif resumen_general.cumplimiento_global >= 50 %}#ffc107{% else %}#dc3545{% endif %};">
                <span class="animated-number" 
                      data-value="{{ resumen_general.cumplimiento_global }}"
                      data-type="percentage">
                    {{ "{:.1f}".format(resumen_general.cumplimiento_global) }}%
                </span>
            </p>
            <small class="text-muted text-center position-relative d-block" style="font-size: 0.7rem;">
                Del per√≠odo seleccionado
            </small>
            
            <!-- Barra de progreso sutil en la parte inferior con color din√°mico -->
            <div class="position-absolute bottom-0 start-0 w-100" style="height: 3px; background: rgba(212, 175, 55, 0.1);">
                <div class="h-100 transition-all" 
                     style="background: linear-gradient(90deg, {% if resumen_general.cumplimiento_global >= 100 %}#28a745, #20c997{% elif resumen_general.cumplimiento_global >= 50 %}#ffc107, #ffca2c{% else %}#dc3545, #e55353{% endif %}); 
                            width: 0%; 
                            transition: width 1.5s ease 2.4s;"></div>
            </div>
        </div>
    </div>
</div>

<!-- SECCI√ìN DE CUMPLIMIENTO POR CANALES -->
<div class="row g-4 mb-5" data-aos="fade-up" data-aos-delay="400">
    {% if cumplimiento_data and cumplimiento_data|length > 0 %}
    {% for canal in cumplimiento_data %}
    {% if canal.es_fila_principal and not canal.es_subfila %}
    <div class="col-12 col-md-6 col-lg-4 canal-card" data-canal="{{ canal.canal }}">
        <div class="card h-100 shadow-sm border-0" style="border-radius: 16px; overflow: hidden; transition: all 0.3s ease; border: 1px solid rgba(212, 175, 55, 0.1);">
            <div class="card-header border-0 pb-2" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
                <div class="d-flex align-items-center justify-content-between">
                    <h6 class="mb-0 fw-bold" style="color: #2C2C2C; font-size: 1rem;">{{ canal.canal }}</h6>
                    <div class="h-100 w-3px rounded" style="width: 4px; height: 35px; 
                                                               background: {% if canal.tipo_meta == "costo" %}{{ color_segun_meta(canal.cumplimiento, canal.tipo_meta, canal.costo_venta_porcentaje) }}{% elif canal.tipo_meta == "ingreso_real" %}{{ color_segun_meta(canal.ingreso_real_porcentaje, canal.tipo_meta) }}{% else %}{{ color_segun_meta(canal.cumplimiento, canal.tipo_meta) }}{% endif %};
                                                               box-shadow: 0 0 8px {% if canal.tipo_meta == "costo" %}{{ color_fondo_segun_meta(canal.cumplimiento, canal.tipo_meta, '0.4', canal.costo_venta_porcentaje) }}{% elif canal.tipo_meta == "ingreso_real" %}{{ color_fondo_segun_meta(canal.ingreso_real_porcentaje, canal.tipo_meta, '0.4') }}{% else %}{{ color_fondo_segun_meta(canal.cumplimiento, canal.tipo_meta, '0.4') }}{% endif %};"></div>
                </div>
            </div>
            <div class="card-body text-center p-4">
                
                
                <!-- GR√ÅFICO PARA METAS DE COSTO -->
                {% if canal.tipo_meta == "costo" and canal.gauge_config %}
                <div class="gauge-container mb-4" style="position: relative; width: 320px; height: 200px; margin: 0 auto;">
                    <div id="{{ canal.gauge_config.div_id }}" style="width: 100%; height: 200px; border: 1px solid #ddd; border-radius: 8px;"></div>
                </div>
                {% elif canal.tipo_meta == "costo" %}
                <div class="gauge-container mb-4" style="position: relative; width: 320px; height: 200px; margin: 0 auto;">
                    <div class="d-flex align-items-center justify-content-center h-100" style="background: #f8f9fa; border-radius: 12px; border: 2px dashed #dee2e6;">
                        <div class="text-center" style="color: #6c757d;">
                            <i class="bi bi-graph-down" style="font-size: 2rem; margin-bottom: 8px;"></i>
                            <div style="font-size: 0.9rem; font-weight: 500;">Gr√°fico de Costos</div>
                            <div style="font-size: 0.8rem;">Sin datos</div>
                        </div>
                    </div>
                </div>
                {% elif canal.tipo_meta == "ingreso_real" and canal.gauge_config %}
                <div class="gauge-container mb-4" style="position: relative; width: 320px; height: 200px; margin: 0 auto;">
                    <div id="{{ canal.gauge_config.div_id }}" style="width: 100%; height: 200px; border: 1px solid #ddd; border-radius: 8px;"></div>
                </div>
                {% elif canal.tipo_meta == "ingreso_real" %}
                <div class="gauge-container mb-4" style="position: relative; width: 320px; height: 200px; margin: 0 auto;">
                    <div class="d-flex align-items-center justify-content-center h-100" style="background: #f0f8ff; border-radius: 12px; border: 2px dashed #0066cc;">
                        <div class="text-center" style="color: #0066cc;">
                            <i class="bi bi-cash-coin" style="font-size: 2rem; margin-bottom: 8px;"></i>
                            <div style="font-size: 0.9rem; font-weight: 500;">Gr√°fico Ingreso Real</div>
                            <div style="font-size: 0.8rem;">Sin datos</div>
                        </div>
                    </div>
                </div>
                {% else %}
                <!-- GR√ÅFICO COMPLETO PARA METAS DE VENTAS (SVG completo corregido) -->
                <div class="barometer-container mb-4" style="position: relative; width: 320px; height: 170px; margin: 0 auto;">
                    <svg width="320" height="170" viewBox="0 0 320 170">
                        <!-- Fondo para el texto "META" -->
                        <rect x="275" y="35" 
                              width="30" height="16" 
                              rx="3" ry="3"
                              fill="rgba(255, 255, 255, 0.9)" 
                              stroke="rgba(44, 44, 44, 0.2)" 
                              stroke-width="1"/>
                        
                        <!-- Texto "META" -->
                        <text x="290" y="47" 
                              font-family="Arial, sans-serif" 
                              font-size="9" 
                              font-weight="600" 
                              fill="{% if canal.cumplimiento > 100 %}#1e7e34{% else %}#2C2C2C{% endif %}" 
                              text-anchor="middle"
                              opacity="1">META</text>
                        
                        <!-- Arco de fondo -->
                        <path d="M 20 150 A 140 140 0 0 1 300 150" 
                              fill="none" 
                              stroke="#e9ecef" 
                              stroke-width="16" 
                              stroke-linecap="round"/>
                        
                        <!-- Gradiente para ventas usando ID √∫nico por canal -->
                        <defs>
                            <linearGradient id="barometer-gradient-{{ canal.canal|lower|replace(' ', '-') }}" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#dc3545;stop-opacity:1" />
                                <stop offset="20%" style="stop-color:#e8722b;stop-opacity:1" />
                                <stop offset="21%" style="stop-color:#ffc107;stop-opacity:1" />
                                <stop offset="60%" style="stop-color:#7cb342;stop-opacity:1" />
                                <stop offset="61%" style="stop-color:#28a745;stop-opacity:1" />
                                <stop offset="80%" style="stop-color:#28a745;stop-opacity:1" />
                                <stop offset="81%" style="stop-color:#28a745;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#1e7e34;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        
                        <!-- Arco de progreso para ventas -->
                        <path d="M 20 150 A 140 140 0 0 1 300 150"
                              fill="none"
                              stroke="url(#barometer-gradient-{{ canal.canal|lower|replace(' ', '-') }})"
                              stroke-width="16"
                              stroke-linecap="round"
                              stroke-dasharray="439.8"
                              stroke-dashoffset="{{ 439.8 * (1 - ([120, (canal.cumplimiento if canal.cumplimiento <= 100 else (100 + (canal.cumplimiento - 100) * 0.25))]|min) * 0.8 / 100) }}"
                              style="transition: stroke-dashoffset 2s ease-in-out;
                                     filter: drop-shadow(0 0 8px rgba(212, 175, 55, 0.3));"/>
                        
                        <!-- L√≠nea de meta para ventas -->
                        <g transform="translate(160,150)">
                            <g transform="rotate(144)">
                                <line x1="0" y1="0" x2="-150" y2="0" 
                                      stroke="#2C2C2C" 
                                      stroke-width="2" 
                                      stroke-linecap="round"
                                      opacity="0.8"/>
                                <circle cx="-150" cy="0" r="3" 
                                        fill="#2C2C2C" 
                                        opacity="0.8"/>
                            </g>
                        </g>
                        
                        <!-- Aguja para ventas -->
                        <g transform="translate(160,150)">
                            <g transform="rotate({{ ([120, (canal.cumplimiento if canal.cumplimiento <= 100 else (100 + (canal.cumplimiento - 100) * 0.25))]|min) * 180 * 0.8 / 100 }})"
                               style="transition: transform 2s ease-in-out;">
                                <line x1="0" y1="0" x2="-140" y2="0" 
                                      stroke="rgba(0,0,0,0.2)" 
                                      stroke-width="3" 
                                      stroke-linecap="round"
                                      transform="translate(1,1)"/>
                                <line x1="0" y1="0" x2="-140" y2="0" 
                                      stroke="{% if canal.cumplimiento <= 25 %}#dc3545{% elif canal.cumplimiento <= 50 %}#e8722b{% elif canal.cumplimiento <= 75 %}#ffc107{% elif canal.cumplimiento <= 100 %}#28a745{% else %}#20c997{% endif %}" 
                                      stroke-width="3" 
                                      stroke-linecap="round"/>
                            </g>
                            <circle cx="0" cy="0" r="8" 
                                    fill="{% if canal.cumplimiento <= 25 %}#dc3545{% elif canal.cumplimiento <= 40 %}#e8722b{% elif canal.cumplimiento <= 60 %}#ffc107{% elif canal.cumplimiento <= 80 %}#7cb342{% elif canal.cumplimiento <= 100 %}#28a745{% else %}#20c997{% endif %}"
                                    stroke="white" 
                                    stroke-width="2"
                                    style="filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));"/>
                        </g>
                    </svg>
                    
                    <!-- Contenido central para ventas -->
                    <div class="barometer-content" style="position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); text-align: center;">
                        <div class="percentage-value" style="font-size: 1.4rem; font-weight: 800; color: #2C2C2C; line-height: 1;">
                            {{ "{:.0f}".format(canal.cumplimiento) }}%
                        </div>
                    </div>
                    
                    <!-- Indicador de meta para ventas -->
                    {% if canal.cumplimiento >= 100 %}
                    <div class="achievement-icon" style="position: absolute; top: -5px; right: 10px; 
                                                        background: linear-gradient(135deg, #28a745, #20c997); 
                                                        border-radius: 50%; width: 28px; height: 28px; 
                                                        display: flex; align-items: center; justify-content: center;
                                                        color: white; font-size: 0.8rem; 
                                                        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
                                                        animation: pulse 2s infinite;">
                        <i class="bi bi-check2"></i>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                
                <!-- INFORMACI√ìN DE M√âTRICAS EN LA PARTE INFERIOR -->
                <div class="row g-3 mb-3">
                    <div class="col-6">
                        <div class="metric-card" style="background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.05)); 
                                                        border-radius: 12px; padding: 1rem; text-align: center; 
                                                        border: 1px solid rgba(40, 167, 69, 0.1);">
                            <div class="metric-icon mb-2" style="color: {% if canal.tipo_meta == "costo" %}{{ color_segun_meta(canal.cumplimiento, canal.tipo_meta, canal.costo_venta_porcentaje) }}{% elif canal.tipo_meta == "ingreso_real" %}{{ color_segun_meta(canal.ingreso_real_porcentaje, canal.tipo_meta) }}{% else %}{{ color_segun_meta(canal.cumplimiento, canal.tipo_meta) }}{% endif %}; font-size: 1.2rem;">
                                {% if canal.tipo_meta == "costo" %}
                                    <i class="bi bi-graph-down"></i>
                                {% elif canal.tipo_meta == "ingreso_real" %}
                                    <i class="bi bi-cash-coin"></i>
                                {% else %}
                                    <i class="bi bi-currency-dollar"></i>
                                {% endif %}
                            </div>
                            <div class="metric-value" style="font-size: 1.1rem; font-weight: 700; color: {% if canal.tipo_meta == "costo" %}{{ color_segun_meta(canal.cumplimiento, canal.tipo_meta, canal.costo_venta_porcentaje) }}{% elif canal.tipo_meta == "ingreso_real" %}{{ color_segun_meta(canal.ingreso_real_porcentaje, canal.tipo_meta) }}{% else %}{{ color_segun_meta(canal.cumplimiento, canal.tipo_meta) }}{% endif %}; line-height: 1;">
                                {% if canal.tipo_meta == "costo" %}
                                    {{ "%.1f" | format(canal.costo_venta_porcentaje) }}%
                                    {% if canal.variacion_costo_venta_pct is defined and canal.variacion_costo_venta_pct != 0 %}
                                        <small style="display: block; font-size: 0.8rem; font-weight: 500; color: {% if canal.variacion_costo_venta_pct > 0 %}#dc3545{% else %}#28a745{% endif %};">
                                            {% if canal.variacion_costo_venta_pct > 0 %}+{% endif %}{{ "%.1f" | format(canal.variacion_costo_venta_pct) }}pp vs anterior
                                        </small>
                                    {% endif %}
                                {% elif canal.tipo_meta == "ingreso_real" %}
                                    {{ "%.1f" | format(canal.ingreso_real_porcentaje) }}%
                                    {% if canal.variacion_ingreso_pct is defined and canal.variacion_ingreso_pct != 0 %}
                                        <small style="display: block; font-size: 0.8rem; font-weight: 500; color: {% if canal.variacion_ingreso_pct > 0 %}#28a745{% else %}#dc3545{% endif %};">
                                            {% if canal.variacion_ingreso_pct > 0 %}+{% endif %}{{ "%.1f" | format(canal.variacion_ingreso_pct) }}pp vs anterior
                                        </small>
                                    {% endif %}
                                {% else %}
                                    {{ canal.ventas_reales_display }}
                                {% endif %}
                            </div>
                            <div class="metric-label" style="font-size: 0.8rem; color: #6c757d; margin-top: 2px;">
                                {% if canal.tipo_meta == "costo" %}
                                    Costo Actual
                                    {% if canal.variacion_gastos_directos_pct is defined and canal.variacion_gastos_directos_pct != 0 %}
                                        <small style="display: block; font-size: 0.7rem; color: {% if canal.variacion_gastos_directos_pct > 0 %}#dc3545{% else %}#28a745{% endif %}; margin-top: 3px;">
                                            Gastos Directos: {% if canal.variacion_gastos_directos_pct > 0 %}+{% endif %}{{ "%.1f" | format(canal.variacion_gastos_directos_pct) }}pp
                                        </small>
                                    {% endif %}
                                {% elif canal.tipo_meta == "ingreso_real" %}
                                    Ingreso Real Actual
                                {% elif canal.tipo_meta == "ingreso_real_nominal" %}
                                    Ingreso Real
                                {% else %}
                                    Ventas Reales
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-6">
                        <div class="metric-card" style="background: linear-gradient(135deg, rgba(23, 162, 184, 0.1), rgba(23, 162, 184, 0.05)); 
                                                        border-radius: 12px; padding: 1rem; text-align: center; 
                                                        border: 1px solid rgba(23, 162, 184, 0.1);">
                            <div class="metric-icon mb-2" style="color: #17a2b8; font-size: 1.2rem;">
                                <i class="bi bi-bullseye"></i>
                            </div>
                            <div class="metric-value" style="font-size: 1.1rem; font-weight: 700; color: #17a2b8; line-height: 1;">
                                {% if canal.tipo_meta == "costo" %}
                                    48% - 54%
                                {% elif canal.tipo_meta == "ingreso_real" %}
                                    10% - 15%
                                {% else %}
                                    ${{ "{:,.0f}".format(canal.meta_periodo) }}
                                {% endif %}
                            </div>
                            <div class="metric-label" style="font-size: 0.8rem; color: #6c757d; margin-top: 2px;">
                                {% if canal.tipo_meta == "costo" %}
                                    Rango Objetivo
                                {% elif canal.tipo_meta == "ingreso_real" %}
                                    Rango Objetivo
                                {% else %}
                                    Meta Per√≠odo
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PORCENTAJE DE INGRESO REAL (solo para ingreso_real_nominal) -->
                {% if canal.tipo_meta == "ingreso_real_nominal" %}
                <div class="row mt-2">
                    <div class="col-12 text-center">
                        <div style="padding: 0.5rem;
                                    background: linear-gradient(135deg, rgba(108, 117, 125, 0.08), rgba(108, 117, 125, 0.03));
                                    border-radius: 8px;
                                    border: 1px solid rgba(108, 117, 125, 0.1);">
                            <span style="font-size: 0.75rem; color: #6c757d; font-weight: 500; letter-spacing: 0.5px;">
                                % INGRESO REAL:
                            </span>
                            <span style="font-size: 0.9rem;
                                         font-weight: 700;
                                         color: {% if canal.ingreso_real_porcentaje >= 15 %}#1e7e34{% elif canal.ingreso_real_porcentaje >= 10 %}#28a745{% elif canal.ingreso_real_porcentaje >= 5 %}#ffc107{% else %}#dc3545{% endif %};
                                         margin-left: 0.3rem;">
                                {{ "%.1f" | format(canal.ingreso_real_porcentaje) }}%
                            </span>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- DIFERENCIA Y STATUS -->
                {% if canal.tipo_meta == "costo" %}
                <!-- Para metas de costo, solo mostramos un badge simple -->
                <div class="text-center">
                    {% set costo_val = (canal.costo_venta_porcentaje | float) if canal.costo_venta_porcentaje else 0 %}
                    {% if costo_val < 48 %}
                      <span class="badge px-3 py-2" style="background: linear-gradient(135deg, #28a745, #20c997); border: none; font-size: 0.85rem; border-radius: 20px; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2);">
                        <i class="bi bi-check-circle-fill me-1"></i>Excelente (Bajo Costo)
                      </span>
                    {% elif costo_val >= 48 and costo_val <= 54 %}
                      <span class="badge px-3 py-2" style="background: linear-gradient(135deg, #ffc107, #ffca2c); border: none; font-size: 0.85rem; border-radius: 20px; color: #2C2C2C; box-shadow: 0 4px 12px rgba(255, 193, 7, 0.2);">
                        <i class="bi bi-target me-1"></i>En Rango Objetivo
                      </span>
                    {% else %}
                      <span class="badge px-3 py-2" style="background: linear-gradient(135deg, #dc3545, #c82333); border: none; font-size: 0.85rem; border-radius: 20px; box-shadow: 0 4px 12px rgba(220, 53, 69, 0.2);">
                        <i class="bi bi-exclamation-triangle-fill me-1"></i>Alto Riesgo (Costo Elevado)
                      </span>
                    {% endif %}
                </div>
                {% elif canal.tipo_meta == "ingreso_real" %}
                <!-- Para metas de ingreso real, usar l√≥gica espec√≠fica -->
                <div class="text-center">
                    {% set ingreso_val = (canal.ingreso_real_porcentaje | float) if canal.ingreso_real_porcentaje else 0 %}
                    <!-- DEBUG: Mostrar valor actual para detectar inconsistencias -->
                    <!-- Canal: {{ canal.canal }} | Ingreso Real %: {{ "%.2f"|format(ingreso_val) }} -->
                    {% if ingreso_val >= 16 %}
                      <span class="badge px-3 py-2" style="background: linear-gradient(135deg, #28a745, #20c997); border: none; font-size: 0.85rem; border-radius: 20px; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2);">
                        <i class="bi bi-check-circle-fill me-1"></i>Excelente Ingreso ({{ "%.1f"|format(ingreso_val) }}%)
                      </span>
                    {% elif ingreso_val >= 10 and ingreso_val < 16 %}
                      <span class="badge px-3 py-2" style="background: linear-gradient(135deg, #ffc107, #ffca2c); border: none; font-size: 0.85rem; border-radius: 20px; color: #2C2C2C; box-shadow: 0 4px 12px rgba(255, 193, 7, 0.2);">
                        <i class="bi bi-target me-1"></i>En Rango Objetivo ({{ "%.1f"|format(ingreso_val) }}%)
                      </span>
                    {% else %}
                      <span class="badge px-3 py-2" style="background: linear-gradient(135deg, #dc3545, #c82333); border: none; font-size: 0.85rem; border-radius: 20px; box-shadow: 0 4px 12px rgba(220, 53, 69, 0.2);">
                        <i class="bi bi-exclamation-triangle-fill me-1"></i>Bajo Ingreso ({{ "%.1f"|format(ingreso_val) }}%) - Necesita Optimizaci√≥n
                      </span>
                    {% endif %}
                </div>
                {% else %}
                <!-- Para metas de ventas (solo esta queda en el else) -->
                <div class="difference-status">
                    <div class="difference-amount mb-2" style="font-size: 1rem; font-weight: 600; color: #6c757d;">
                        {% set diff_val = (canal.diferencia | float) if canal.diferencia else 0 %}
                        {% if diff_val >= 0 %}+{% endif %} ${{ "{:,.0f}".format(diff_val) }}
                        <small style="font-size: 0.8rem; color: #6c757d; font-weight: 400;">diferencia</small>
                    </div>
                    
                    <!-- Badge para metas de ventas -->
                    {% if canal.cumplimiento >= 100 %}
                      <span class="badge px-3 py-2" style="background: linear-gradient(135deg, #28a745, #20c997); border: none; font-size: 0.85rem; border-radius: 20px; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2);">
                        <i class="bi bi-check-circle-fill me-1"></i>Meta Alcanzada
                      </span>
                    {% elif canal.cumplimiento >= 50 %}
                      <span class="badge px-3 py-2" style="background: linear-gradient(135deg, #ffc107, #ffca2c); border: none; font-size: 0.85rem; border-radius: 20px; color: #2C2C2C; box-shadow: 0 4px 12px rgba(255, 193, 7, 0.2);">
                        <i class="bi bi-hourglass-split me-1"></i>En Progreso
                      </span>
                    {% else %}
                      <span class="badge px-3 py-2" style="background: linear-gradient(135deg, #dc3545, #c82333); border: none; font-size: 0.85rem; border-radius: 20px; box-shadow: 0 4px 12px rgba(220, 53, 69, 0.2);">
                        <i class="bi bi-exclamation-triangle-fill me-1"></i>Necesita Atenci√≥n
                      </span>
                    {% endif %}
                </div>
                {% endif %}
                
            </div>
        </div>
    </div>
    {% endif %}
    {% endfor %}
    {% else %}
    <!-- MENSAJE CUANDO NO HAY METAS DEFINIDAS -->
    <div class="col-12">
        <div class="text-center py-5" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: 20px; border: 2px dashed rgba(108, 117, 125, 0.3);">
            <div class="mb-4">
                <i class="bi bi-calendar-x" style="font-size: 4rem; color: rgba(108, 117, 125, 0.6);"></i>
            </div>
            <h4 class="mb-3" style="color: #495057; font-weight: 600;">Metas no Definidas</h4>
            <p class="text-muted mb-0" style="font-size: 1.1rem;">
                No se han definido metas para el mes seleccionado.<br>
                <small style="font-size: 0.9rem;">Contacta al administrador para configurar las metas de este per√≠odo.</small>
            </p>
        </div>
    </div>
    {% endif %}
</div>

<!-- ESTILO CSS ADICIONAL PARA METAS DE VENTAS -->
<style>
/* Animaci√≥n de pulso para logros de ventas */
@keyframes pulse {
    0% {
        transform: scale(1);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    50% {
        transform: scale(1.05);
        box-shadow: 0 6px 16px rgba(40, 167, 69, 0.4);
    }
    100% {
        transform: scale(1);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
}
</style>

<!-- SCRIPT GLOBAL PARA RENDERIZAR TODOS LOS GR√ÅFICOS PLOTLY -->
<script>
// Funci√≥n global para renderizar todos los gauges (costo e ingreso real)
function renderAllGauges() {
    if (typeof Plotly === 'undefined') {
        return;
    }
    
    // Configuraciones de gauges pasadas desde el backend - SOLO CANALES PRINCIPALES
    const gaugeConfigs = [
        {% for canal in cumplimiento_data %}
        {% if (canal.tipo_meta == "costo" or canal.tipo_meta == "ingreso_real") and canal.gauge_config %}
        {{ canal.gauge_config | tojson }},
        {% endif %}
        {% endfor %}
    ];
    
    // Renderizar cada gauge
    gaugeConfigs.forEach((config, index) => {
        setTimeout(() => {
            try {
                const divElement = document.getElementById(config.div_id);
                if (!divElement) {
                    return;
                }
                
                // Limpiar contenedor
                try {
                    Plotly.purge(config.div_id);
                } catch (e) {
                    // Normal en primera carga
                }
                
                // Crear gr√°fico
                Plotly.newPlot(config.div_id, config.data, config.layout, config.config)
                    .catch((error) => {
                        divElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f8d7da; border-radius: 8px; color: #721c24; padding: 20px;"><div class="text-center"><i class="bi bi-x-circle" style="font-size: 2rem;"></i><br>Error al cargar</div></div>';
                    });
            } catch (error) {
                // Error silencioso
            }
        }, index * 200); // Delay escalonado para evitar conflictos
    });
}

// Ejecutar SOLO si no hay funci√≥n global disponible (fallback para uso directo)
if (typeof window.renderPlotlyGaugesFromData !== 'function') {
    console.log('üîÑ Usando renderizaci√≥n local de gauges (fallback)');
    
    // Ejecutar cuando el contenido est√© listo
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(renderAllGauges, 100);
    });
    
    // Tambi√©n ejecutar inmediatamente por si el DOM ya est√° listo
    setTimeout(renderAllGauges, 200);
} else {
    console.log('‚úÖ Funci√≥n global de gauges detectada - renderizaci√≥n ser√° manejada globalmente');
}
</script>